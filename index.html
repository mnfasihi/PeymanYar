<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù¾ÛŒÙ…Ø§Ù†â€ŒÛŒØ§Ø± | Ù¾Ù„ØªÙØ±Ù… Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù¾ÛŒÙ…Ø§Ù†Ú©Ø§Ø±Ø§Ù† Ø³Ø§Ø®ØªÙ…Ø§Ù†ÛŒ</title>
<meta name="description" content="Ù¾Ù„ØªÙØ±Ù… Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù¾ÛŒÙ…Ø§Ù†â€ŒÛŒØ§Ø±ØŒ Ø§ÙˆÙ„ÛŒÙ† Ùˆ ØªØ®ØµØµÛŒâ€ŒØªØ±ÛŒÙ† Ù¾Ù„ØªÙØ±Ù… Ø§Ø±ØªØ¨Ø§Ø· Ú©Ø§Ø±ÙØ±Ù…Ø§ÛŒØ§Ù† Ùˆ Ù¾ÛŒÙ…Ø§Ù†Ú©Ø§Ø±Ø§Ù† Ø³Ø§Ø®ØªÙ…Ø§Ù†ÛŒ Ø¯Ø± Ø§ÛŒØ±Ø§Ù†">
<meta name="keywords" content="Ù¾ÛŒÙ…Ø§Ù†Ú©Ø§Ø±, Ú©Ø§Ø±ÙØ±Ù…Ø§, Ø³Ø§Ø®ØªÙ…Ø§Ù†, Ø³Ø§Ø®Øªâ€ŒÙˆØ³Ø§Ø², Ù¾ÛŒÙ…Ø§Ù†â€ŒÛŒØ§Ø±, Ù¾ÛŒÙ…Ø§Ù†Ú©Ø§Ø±ÛŒ Ø³Ø§Ø®ØªÙ…Ø§Ù†, Ù¾ÛŒÙ…Ø§Ù†Ú©Ø§Ø±ÛŒ, Ø³Ø§Ø®ØªÙ…Ø§Ù†ÛŒ">
<meta name="author" content="Ù¾ÛŒÙ…Ø§Ù†â€ŒÛŒØ§Ø±">
<meta name="robots" content="index, follow">
<meta property="og:title" content="Ù¾ÛŒÙ…Ø§Ù†â€ŒÛŒØ§Ø± | Ù¾Ù„ØªÙØ±Ù… Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù¾ÛŒÙ…Ø§Ù†Ú©Ø§Ø±Ø§Ù† Ø³Ø§Ø®ØªÙ…Ø§Ù†ÛŒ">
<meta property="og:description" content="Ø§ÙˆÙ„ÛŒÙ† Ù¾Ù„ØªÙØ±Ù… ØªØ®ØµØµÛŒ Ø¨Ø±Ø§ÛŒ ÛŒØ§ÙØªÙ†ØŒ Ø¨Ø±Ø±Ø³ÛŒ Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù¾ÛŒÙ…Ø§Ù†Ú©Ø§Ø±Ø§Ù† Ù…Ø¹ØªØ¨Ø± Ø³Ø§Ø®ØªÙ…Ø§Ù†ÛŒ">
<meta property="og:type" content="website">
<meta property="og:image" content="https://images.unsplash.com/photo-1541888946425-d81bb19240f5?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80">
<meta property="og:url" content="https://peymanyar.com">
<meta property="og:locale" content="fa_IR">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
<style>
/* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§ Ø¨Ù‡ Ù‡Ù…Ø§Ù† ØµÙˆØ±Øª Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ù†Ø¯ - Ø¨Ø±Ø§ÛŒ Ø§Ø®ØªØµØ§Ø± Ø­Ø°Ù Ø´Ø¯Ù†Ø¯ */
</style>
</head>
<body>
<!-- Ù…ÙˆØ¯Ø§Ù„ Ù‚ÙˆØ§Ù†ÛŒÙ† Ùˆ Ù…Ù‚Ø±Ø±Ø§Øª -->
<div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="termsModalLabel">Ù‚ÙˆØ§Ù†ÛŒÙ† Ùˆ Ù…Ù‚Ø±Ø±Ø§Øª Ù¾ÛŒÙ…Ø§Ù†â€ŒÛŒØ§Ø±</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Ø¨Ø³ØªÙ†"></button>
      </div>
      <div class="modal-body">
        <h6>Û±. Ù‚ÙˆØ§Ù†ÛŒÙ† Ø¹Ù…ÙˆÙ…ÛŒ</h6>
        <p>Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø®Ø¯Ù…Ø§Øª Ù¾Ù„ØªÙØ±Ù… Ù¾ÛŒÙ…Ø§Ù†â€ŒÛŒØ§Ø± Ø¨Ù‡ Ù…Ø¹Ù†Ø§ÛŒ Ù¾Ø°ÛŒØ±Ø´ Ú©Ø§Ù…Ù„ Ù‚ÙˆØ§Ù†ÛŒÙ† Ùˆ Ù…Ù‚Ø±Ø±Ø§Øª Ø²ÛŒØ± Ù…ÛŒâ€ŒØ¨Ø§Ø´Ø¯.</p>
        <h6>Û². Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ùˆ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ</h6>
        <p>Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ù…ÙˆØ¸ÙÙ†Ø¯ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØµØ­ÛŒØ­ Ùˆ Ú©Ø§Ù…Ù„ Ø¯Ø± Ù‡Ù†Ú¯Ø§Ù… Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø§Ø±Ø§Ø¦Ù‡ Ø¯Ù‡Ù†Ø¯. Ù…Ø³Ø¦ÙˆÙ„ÛŒØª Ù‡Ø±Ú¯ÙˆÙ†Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ø§Ø¯Ø±Ø³Øª Ø¨Ø± Ø¹Ù‡Ø¯Ù‡ Ú©Ø§Ø±Ø¨Ø± Ù…ÛŒâ€ŒØ¨Ø§Ø´Ø¯.</p>
        <h6>Û³. Ø­Ø±ÛŒÙ… Ø®ØµÙˆØµÛŒ</h6>
        <p>Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ù†Ø²Ø¯ Ù¾ÛŒÙ…Ø§Ù†â€ŒÛŒØ§Ø± Ù…Ø­ÙÙˆØ¸ Ø¨ÙˆØ¯Ù‡ Ùˆ Ø¨Ø¯ÙˆÙ† Ø±Ø¶Ø§ÛŒØª Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø§Ø®ØªÛŒØ§Ø± Ø§Ø´Ø®Ø§Øµ Ø«Ø§Ù„Ø« Ù‚Ø±Ø§Ø± Ù†Ø®ÙˆØ§Ù‡Ø¯ Ú¯Ø±ÙØª.</p>
        <h6>Û´. Ù‚ÙˆØ§Ù†ÛŒÙ† Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§</h6>
        <p>Ù¾ÛŒÙ…Ø§Ù†â€ŒÛŒØ§Ø± ØµØ±ÙØ§Ù‹ ÛŒÚ© Ù¾Ù„ØªÙØ±Ù… Ø§Ø±ØªØ¨Ø§Ø·ÛŒ Ø§Ø³Øª Ùˆ Ù…Ø³Ø¦ÙˆÙ„ÛŒØªÛŒ Ø¯Ø± Ù‚Ø¨Ø§Ù„ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§ÛŒ Ù…Ù†Ø¹Ù‚Ø¯ Ø´Ø¯Ù‡ Ø¨ÛŒÙ† Ú©Ø§Ø±ÙØ±Ù…Ø§ÛŒØ§Ù† Ùˆ Ù¾ÛŒÙ…Ø§Ù†Ú©Ø§Ø±Ø§Ù† Ù†Ø¯Ø§Ø±Ø¯.</p>
        <h6>Ûµ. Ø­Ù‚ Ù„ØºÙˆ Ø¹Ø¶ÙˆÛŒØª</h6>
        <p>Ù¾ÛŒÙ…Ø§Ù†â€ŒÛŒØ§Ø± Ø§ÛŒÙ† Ø­Ù‚ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ¯ Ù…Ø­ÙÙˆØ¸ Ù…ÛŒâ€ŒØ¯Ø§Ø±Ø¯ Ø¯Ø± ØµÙˆØ±Øª Ù…Ø´Ø§Ù‡Ø¯Ù‡ ØªØ®Ù„ÙØŒ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø±Ø§ Ø¨Ø¯ÙˆÙ† Ø§Ø·Ù„Ø§Ø¹ Ù‚Ø¨Ù„ÛŒ Ù…Ø³Ø¯ÙˆØ¯ Ù†Ù…Ø§ÛŒØ¯.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¨Ø³ØªÙ†</button>
        <button type="button" class="btn btn-primary" onclick="acceptTerms()">Ù¾Ø°ÛŒØ±Ø´ Ù‚ÙˆØ§Ù†ÛŒÙ†</button>
      </div>
    </div>
  </div>
</div>

<!-- Ú©Ø§Ù†ØªÛŒÙ†Ø± toast Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ -->
<div id="toastContainer" style="position: fixed; top: 20px; left: 20px; z-index: 9999;"></div>

<div class="assistant-container" role="complementary" aria-label="Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯">
  <div id="assistantWindow" class="assistant-window" aria-hidden="true" aria-label="Ù¾Ù†Ø¬Ø±Ù‡ Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯">
    <div class="assistant-header">
      <div>
        <h5 class="mb-1"><i class="bi bi-robot me-2" aria-hidden="true"></i>Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù¾ÛŒÙ…Ø§Ù†â€ŒÛŒØ§Ø±</h5>
        <small class="opacity-75">Ø¨Ø±Ø§ÛŒ Ú©Ù…Ú© Ø¨Ù‡ Ø´Ù…Ø§ Ø§ÛŒÙ†Ø¬Ø§ÛŒÙ…!</small>
      </div>
      <button class="btn btn-sm btn-light" onclick="toggleAssistant()" aria-label="Ø¨Ø³ØªÙ† Ø¯Ø³ØªÛŒØ§Ø±">
        <i class="bi bi-x-lg" aria-hidden="true"></i>
      </button>
    </div>
    <div class="assistant-messages" id="assistantMessages" role="log" aria-live="polite"></div>
    <div class="assistant-input">
      <div class="input-group">
        <input type="text" class="form-control" id="assistantInput" placeholder="Ø³ÙˆØ§Ù„ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù¾Ø±Ø³ÛŒØ¯..." aria-label="Ù¾ÛŒØ§Ù… Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯" aria-describedby="assistantHint">
        <button class="btn btn-primary" onclick="sendAssistantMessage()" aria-label="Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…">
          <i class="bi bi-send" aria-hidden="true"></i>
        </button>
      </div>
      <small id="assistantHint" class="text-muted mt-2 d-block">
        <i class="bi bi-info-circle me-1" aria-hidden="true"></i>
        Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¯Ø± Ù…ÙˆØ±Ø¯ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…ØŒ Ø¬Ø³ØªØ¬ÙˆØŒ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§ Ùˆ ... Ø³ÙˆØ§Ù„ Ø¨Ù¾Ø±Ø³ÛŒØ¯
      </small>
    </div>
  </div>
  <button class="assistant-toggle" onclick="toggleAssistant()" aria-label="Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯" aria-expanded="false">
    <i class="bi bi-robot" aria-hidden="true"></i>
    <span class="notification-badge" id="assistantNotification" aria-live="polite">Û±</span>
  </button>
</div>

<nav class="navbar navbar-expand-lg navbar-light fixed-top" aria-label="Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ">
<div class="container">
  <a class="navbar-brand" href="#" onclick="showPage('home')" aria-label="Ù¾ÛŒÙ…Ø§Ù†â€ŒÛŒØ§Ø± - Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ">
    <span role="img" aria-label="Ø¢ÛŒÚ©ÙˆÙ† Ù¾ÛŒÙ…Ø§Ù†â€ŒÛŒØ§Ø±">ğŸ—ï¸</span> Ù¾ÛŒÙ…Ø§Ù†â€ŒÛŒØ§Ø±
  </a>
  <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain" aria-controls="navbarMain" aria-expanded="false" aria-label="Ù†Ù…Ø§ÛŒØ´/Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ù…Ù†Ùˆ">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarMain">
    <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
      <li class="nav-item">
        <a class="nav-link active" href="#" onclick="showPage('home')" aria-current="page">Ø®Ø§Ù†Ù‡</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#" onclick="showPage('features')">ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#" onclick="showPage('search')">Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒÙ…Ø§Ù†Ú©Ø§Ø±</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#" onclick="showPage('projects')">Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#" onclick="showPage('messages')">Ù¾ÛŒØ§Ù…â€ŒÛŒØ§Ø±</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#" onclick="showPage('blog')">Ø¨Ù„Ø§Ú¯</a>
      </li>
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false" id="userMenuDropdown">
          <i class="bi bi-person-circle me-1" aria-hidden="true"></i>
          <span class="d-none d-md-inline">Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ</span>
        </a>
        <ul class="dropdown-menu" aria-labelledby="userMenuDropdown">
          <li><a class="dropdown-item" href="#" onclick="showPage('profile')">Ù¾Ù†Ù„ Ú©Ø§Ø±Ø¨Ø±ÛŒ</a></li>
          <li><a class="dropdown-item" href="#" onclick="showLogin()">ÙˆØ±ÙˆØ¯</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item" href="#" onclick="showEmployerRegistration()">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø§Ø±ÙØ±Ù…Ø§</a></li>
          <li><a class="dropdown-item" href="#" onclick="showContractorRegistration()">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù¾ÛŒÙ…Ø§Ù†Ú©Ø§Ø±</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item admin-only" href="#" onclick="showAdminLogin()" style="display: none;">
            <i class="bi bi-shield-lock me-2"></i>ÙˆØ±ÙˆØ¯ Ù…Ø¯ÛŒØ±
          </a></li>
          <li><a class="dropdown-item admin-only" href="#" onclick="showAdminMessages()" style="display: none;">
            <i class="bi bi-gear me-2"></i>Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª
          </a></li>
        </ul>
      </li>
    </ul>
  </div>
</div>
</nav>

<!-- ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ -->
<div id="home" class="page-section active" role="main" aria-label="ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ">
  <!-- Ù…Ø­ØªÙˆØ§ÛŒ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ Ø´Ù…Ø§ -->
</div>

<!-- ØµÙØ­Ù‡ ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ -->
<div id="features" class="page-section" role="main" aria-label="ØµÙØ­Ù‡ ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§">
  <!-- Ù…Ø­ØªÙˆØ§ÛŒ ØµÙØ­Ù‡ ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ -->
</div>

<!-- ØµÙØ­Ù‡ Ø¬Ø³ØªØ¬Ùˆ -->
<div id="search" class="page-section" role="main" aria-label="ØµÙØ­Ù‡ Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒÙ…Ø§Ù†Ú©Ø§Ø±">
  <!-- Ù…Ø­ØªÙˆØ§ÛŒ ØµÙØ­Ù‡ Ø¬Ø³ØªØ¬Ùˆ -->
</div>

<!-- ØµÙØ­Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ -->
<div id="projects" class="page-section" role="main" aria-label="ØµÙØ­Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§">
  <div class="container page-header">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="section-title">ğŸ“‹ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§</h2>
      <button class="btn btn-primary" onclick="app.showNewProjectModal()">
        <i class="bi bi-plus-circle me-2"></i>Ù¾Ø±ÙˆÚ˜Ù‡ Ø¬Ø¯ÛŒØ¯
      </button>
    </div>
    <div class="card-peymanyar mb-4">
      <div class="row g-3">
        <div class="col-md-4">
          <select class="form-select" id="projectFilterStatus">
            <option value="all">Ù‡Ù…Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§</option>
            <option value="open">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ù¾ÛŒÙ…Ø§Ù†Ú©Ø§Ø±</option>
            <option value="in_progress">Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</option>
            <option value="completed">ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡</option>
          </select>
        </div>
        <div class="col-md-4">
          <input type="text" class="form-control" id="projectSearch" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§...">
        </div>
        <div class="col-md-4">
          <button class="btn btn-peymanyar w-100" onclick="app.loadProjects()">
            <i class="bi bi-search me-2"></i>Ø§Ø¹Ù…Ø§Ù„ ÙÛŒÙ„ØªØ±
          </button>
        </div>
      </div>
    </div>
    <div id="projectsList" class="row"></div>
  </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ù¾Ø±ÙˆÚ˜Ù‡ Ø¬Ø¯ÛŒØ¯ -->
<div class="modal fade" id="newProjectModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ø±ÙˆÚ˜Ù‡ Ø¬Ø¯ÛŒØ¯</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Ø¨Ø³ØªÙ†"></button>
      </div>
      <div class="modal-body">
        <form id="newProjectForm">
          <div class="mb-3">
            <label class="form-label required">Ø¹Ù†ÙˆØ§Ù† Ù¾Ø±ÙˆÚ˜Ù‡</label>
            <input type="text" class="form-control" id="projectTitle" required>
          </div>
          <div class="mb-3">
            <label class="form-label required">ØªÙˆØ¶ÛŒØ­Ø§Øª Ù¾Ø±ÙˆÚ˜Ù‡</label>
            <textarea class="form-control" id="projectDescription" rows="4" required></textarea>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</label>
              <select class="form-select" id="projectCategory">
                <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                <option value="residential">Ù…Ø³Ú©ÙˆÙ†ÛŒ</option>
                <option value="commercial">ØªØ¬Ø§Ø±ÛŒ</option>
                <option value="industrial">ØµÙ†Ø¹ØªÛŒ</option>
                <option value="renovation">Ù†ÙˆØ³Ø§Ø²ÛŒ</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Ø¨ÙˆØ¯Ø¬Ù‡ ØªÙ‚Ø±ÛŒØ¨ÛŒ</label>
              <select class="form-select" id="projectBudget">
                <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                <option value="under100">Ø²ÛŒØ± Û±Û°Û° Ù…ÛŒÙ„ÛŒÙˆÙ†</option>
                <option value="100-500">Û±Û°Û° ØªØ§ ÛµÛ°Û° Ù…ÛŒÙ„ÛŒÙˆÙ†</option>
                <option value="500-1000">ÛµÛ°Û° Ù…ÛŒÙ„ÛŒÙˆÙ† ØªØ§ Û± Ù…ÛŒÙ„ÛŒØ§Ø±Ø¯</option>
                <option value="1-5">Û± ØªØ§ Ûµ Ù…ÛŒÙ„ÛŒØ§Ø±Ø¯</option>
                <option value="5+">Ø¨Ø§Ù„Ø§ÛŒ Ûµ Ù…ÛŒÙ„ÛŒØ§Ø±Ø¯</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ú©Ø§Ù†ÛŒ</label>
              <input type="text" class="form-control" id="projectLocation" placeholder="Ù…Ø«Ø§Ù„: ØªÙ‡Ø±Ø§Ù†ØŒ Ø³Ø¹Ø§Ø¯Øªâ€ŒØ¢Ø¨Ø§Ø¯">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Ø²Ù…Ø§Ù†Ø¨Ù†Ø¯ÛŒ</label>
              <select class="form-select" id="projectTimeline">
                <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                <option value="urgent">ÙÙˆØ±ÛŒ (Ú©Ù…ØªØ± Ø§Ø² Û± Ù…Ø§Ù‡)</option>
                <option value="1-3">Û± ØªØ§ Û³ Ù…Ø§Ù‡</option>
                <option value="3-6">Û³ ØªØ§ Û¶ Ù…Ø§Ù‡</option>
                <option value="6-12">Û¶ ØªØ§ Û±Û² Ù…Ø§Ù‡</option>
                <option value="flexible">Ø§Ù†Ø¹Ø·Ø§Ùâ€ŒÙ¾Ø°ÛŒØ±</option>
              </select>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø§Ù†ØµØ±Ø§Ù</button>
        <button type="button" class="btn btn-primary" onclick="app.createProject()">Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ø±ÙˆÚ˜Ù‡</button>
      </div>
    </div>
  </div>
</div>

<!-- ØµÙØ­Ù‡ Ù¾ÛŒØ§Ù…â€ŒÛŒØ§Ø± -->
<div id="messages" class="page-section" role="main" aria-label="ØµÙØ­Ù‡ Ù¾ÛŒØ§Ù…â€ŒÛŒØ§Ø±">
  <!-- Ù…Ø­ØªÙˆØ§ÛŒ ØµÙØ­Ù‡ Ù¾ÛŒØ§Ù…â€ŒÛŒØ§Ø± -->
</div>

<!-- ØµÙØ­Ù‡ Ø¨Ù„Ø§Ú¯ -->
<div id="blog" class="page-section" role="main" aria-label="ØµÙØ­Ù‡ Ø¨Ù„Ø§Ú¯">
  <!-- Ù…Ø­ØªÙˆØ§ÛŒ ØµÙØ­Ù‡ Ø¨Ù„Ø§Ú¯ -->
</div>

<!-- ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯ -->
<div id="login" class="page-section" role="main" aria-label="ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯">
  <!-- Ù…Ø­ØªÙˆØ§ÛŒ ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯ -->
</div>

<!-- ØµÙØ­Ù‡ ÙØ±Ø§Ù…ÙˆØ´ÛŒ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± -->
<div id="forgotPassword" class="page-section" role="main" aria-label="ØµÙØ­Ù‡ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
  <!-- Ù…Ø­ØªÙˆØ§ÛŒ ØµÙØ­Ù‡ ÙØ±Ø§Ù…ÙˆØ´ÛŒ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± -->
</div>

<!-- ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯ Ø§Ø¯Ù…ÛŒÙ† -->
<div id="adminLogin" class="page-section" role="main" aria-label="ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯ Ø§Ø¯Ù…ÛŒÙ†">
  <!-- Ù…Ø­ØªÙˆØ§ÛŒ ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯ Ø§Ø¯Ù…ÛŒÙ† -->
</div>

<!-- ØµÙØ­Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª -->
<div id="adminMessages" class="page-section" role="main" aria-label="Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾ÛŒØ§Ù…â€ŒÛŒØ§Ø±">
  <!-- Ù…Ø­ØªÙˆØ§ÛŒ ØµÙØ­Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª -->
</div>

<!-- ØµÙØ­Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ -->
<div id="profile" class="page-section" role="main" aria-label="ØµÙØ­Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„">
  <!-- Ù…Ø­ØªÙˆØ§ÛŒ ØµÙØ­Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ -->
</div>

<!-- ØµÙØ­Ù‡ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø§Ø±ÙØ±Ù…Ø§ -->
<div id="employerRegistration" class="page-section" role="main" aria-label="ØµÙØ­Ù‡ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø§Ø±ÙØ±Ù…Ø§">
  <!-- Ù…Ø­ØªÙˆØ§ÛŒ ØµÙØ­Ù‡ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø§Ø±ÙØ±Ù…Ø§ -->
</div>

<!-- ØµÙØ­Ù‡ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù¾ÛŒÙ…Ø§Ù†Ú©Ø§Ø± -->
<div id="contractorRegistration" class="page-section" role="main" aria-label="ØµÙØ­Ù‡ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù¾ÛŒÙ…Ø§Ù†Ú©Ø§Ø±">
  <!-- Ù…Ø­ØªÙˆØ§ÛŒ ØµÙØ­Ù‡ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù¾ÛŒÙ…Ø§Ù†Ú©Ø§Ø± -->
</div>

<!-- ÙÙˆØªØ± -->
<footer class="footer" role="contentinfo">
<div class="container">
  <div class="row">
    <div class="col-lg-4">
      <div class="footer-section">
        <div class="footer-logo">Ù¾ÛŒÙ…Ø§Ù†â€ŒÛŒØ§Ø±</div>
        <p class="text-light" style="opacity: 0.8;">
          Ù¾Ù„ØªÙØ±Ù… Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù¾ÛŒÙ…Ø§Ù†â€ŒÛŒØ§Ø±ØŒ Ø§ÙˆÙ„ÛŒÙ† Ùˆ ØªØ®ØµØµÛŒâ€ŒØªØ±ÛŒÙ† Ù¾Ù„ØªÙØ±Ù… Ø§Ø±ØªØ¨Ø§Ø· Ú©Ø§Ø±ÙØ±Ù…Ø§ÛŒØ§Ù† Ùˆ Ù¾ÛŒÙ…Ø§Ù†Ú©Ø§Ø±Ø§Ù† Ø³Ø§Ø®ØªÙ…Ø§Ù†ÛŒ Ø¯Ø± Ø§ÛŒØ±Ø§Ù†.
        </p>
        <div class="social-links">
          <a href="#" class="social-link" aria-label="Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù… Ù¾ÛŒÙ…Ø§Ù†â€ŒÛŒØ§Ø±"><i class="bi bi-instagram"></i></a>
          <a href="#" class="social-link" aria-label="ØªÙ„Ú¯Ø±Ø§Ù… Ù¾ÛŒÙ…Ø§Ù†â€ŒÛŒØ§Ø±"><i class="bi bi-telegram"></i></a>
          <a href="#" class="social-link" aria-label="Ù„ÛŒÙ†Ú©Ø¯ÛŒÙ† Ù¾ÛŒÙ…Ø§Ù†â€ŒÛŒØ§Ø±"><i class="bi bi-linkedin"></i></a>
        </div>
      </div>
    </div>
    <div class="col-lg-2 col-md-4">
      <div class="footer-section">
        <h5 class="footer-title">Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Ø³Ø±ÛŒØ¹</h5>
        <ul class="footer-links">
          <li><a href="#" onclick="showPage('home')">Ø®Ø§Ù†Ù‡</a></li>
          <li><a href="#" onclick="showPage('features')">ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§</a></li>
          <li><a href="#" onclick="showPage('search')">Ø¬Ø³ØªØ¬Ùˆ</a></li>
          <li><a href="#" onclick="showPage('projects')">Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§</a></li>
          <li><a href="#" onclick="showPage('messages')">Ù¾ÛŒØ§Ù…â€ŒÛŒØ§Ø±</a></li>
          <li><a href="#" onclick="showPage('blog')">Ø¨Ù„Ø§Ú¯</a></li>
        </ul>
      </div>
    </div>
    <div class="col-lg-3 col-md-4">
      <div class="footer-section">
        <h5 class="footer-title">ØªÙ…Ø§Ø³ Ø¨Ø§ Ù…Ø§</h5>
        <ul class="footer-links">
          <li><i class="bi bi-geo-alt me-2"></i> ØªÙ‡Ø±Ø§Ù†ØŒ Ø®ÛŒØ§Ø¨Ø§Ù† ÙˆÙ„ÛŒØ¹ØµØ±</li>
          <li><i class="bi bi-telephone me-2"></i> Û°Û²Û±-Û±Û²Û³Û´ÛµÛ¶Û·Û¸</li>
          <li><i class="bi bi-envelope me-2"></i> info@peymanyar.com</li>
        </ul>
      </div>
    </div>
    <div class="col-lg-3 col-md-4">
      <div class="footer-section">
        <h5 class="footer-title">Ø®Ø¨Ø±Ù†Ø§Ù…Ù‡</h5>
        <p class="text-light" style="opacity: 0.8; font-size: 0.9rem;">Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ø§Ø®Ø¨Ø§Ø± Ùˆ ØªØ®ÙÛŒÙâ€ŒÙ‡Ø§ Ø¯Ø± Ø®Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¹Ø¶Ùˆ Ø´ÙˆÛŒØ¯.</p>
        <div class="input-group mb-3">
          <input type="email" class="form-control" placeholder="Ø§ÛŒÙ…ÛŒÙ„ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" aria-label="Ø§ÛŒÙ…ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ø®Ø¨Ø±Ù†Ø§Ù…Ù‡">
          <button class="btn btn-primary" type="button" aria-label="Ø¹Ø¶ÙˆÛŒØª Ø¯Ø± Ø®Ø¨Ø±Ù†Ø§Ù…Ù‡">
            <i class="bi bi-send"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="copyright">
    <p>Â© Û±Û´Û°Û³ ØªÙ…Ø§Ù…ÛŒ Ø­Ù‚ÙˆÙ‚ Ø¨Ø±Ø§ÛŒ Ù¾Ù„ØªÙØ±Ù… <strong>Ù¾ÛŒÙ…Ø§Ù†â€ŒÛŒØ§Ø±</strong> (PeymanYar) Ù…Ø­ÙÙˆØ¸ Ø§Ø³Øª.</p>
    <p class="mt-2">
      <a href="#" style="color: #b0bec5; font-size: 0.8rem;">Ù‚ÙˆØ§Ù†ÛŒÙ† Ùˆ Ù…Ù‚Ø±Ø±Ø§Øª</a> | 
      <a href="#" style="color: #b0bec5; font-size: 0.8rem;">Ø­Ø±ÛŒÙ… Ø®ØµÙˆØµÛŒ</a>
    </p>
  </div>
</div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const supabaseUrl = 'https://fycyznoykgxpaatjsawi.supabase.co'
const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ5Y3l6bm95a2d4cGFhdGpzYXdpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2MDM0MjYsImV4cCI6MjA4NzE3OTQyNn0.fZQfDuaUW6jxQOF0be8eaK16mD-lHfPnyYht-0ryQSQ'

const supabase = createClient(supabaseUrl, supabaseAnonKey)
window.supabase = supabase

'use strict';

class PeymanyarApp {
  constructor() {
    this.currentPage = 'home';
    this.employerCurrentStep = 1;
    this.contractorCurrentStep = 1;
    this.employerTotalSteps = 4;
    this.contractorTotalSteps = 5;
    this.assistantMessages = [];
    this.userData = null;
    this.heroSlideIndex = 0;
    this.heroSlides = [];
    this.heroSlideInterval = null;
    this.isAdmin = false;
    this.adminToken = null;
    this.adminEmail = null;
    this.init();
  }

  init() {
    this.setupEventListeners();
    this.setupForms();
    this.setupAssistant();
    this.animateCounters();
    this.setupAccessibility();
    this.loadUserData();
    this.setupMessagingSystem();
    this.setupHeroSlider();
    this.setupAdminSystem();
    this.loadRealStats();
    this.setupLoginForms();
    this.setupPasswordValidation();
  }

  setupEventListeners() {
    window.addEventListener('popstate', (e) => {
      if (e.state && e.state.page) {
        this.showPage(e.state.page, false);
      }
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        this.closeAllModals();
      }
    });
    this.setupIntersectionObserver();
  }

  showTermsModal() {
    const termsModal = new bootstrap.Modal(document.getElementById('termsModal'));
    termsModal.show();
    const employerTerms = document.getElementById('employerTerms');
    const contractorTerms = document.getElementById('contractorTerms');
    if (employerTerms) {
      window.tempEmployerTermsState = employerTerms.checked;
    }
    if (contractorTerms) {
      window.tempContractorTermsState = contractorTerms.checked;
    }
  }

  acceptTerms() {
    const employerTerms = document.getElementById('employerTerms');
    const contractorTerms = document.getElementById('contractorTerms');
    if (employerTerms) {
      employerTerms.checked = true;
      employerTerms.disabled = false;
    }
    if (contractorTerms) {
      contractorTerms.checked = true;
      contractorTerms.disabled = false;
    }
    delete window.tempEmployerTermsState;
    delete window.tempContractorTermsState;
    this.closeTermsModal();
    this.showToast('Ù‚ÙˆØ§Ù†ÛŒÙ† Ùˆ Ù…Ù‚Ø±Ø±Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾Ø°ÛŒØ±ÙØªÙ‡ Ø´Ø¯', 'success');
  }

  closeTermsModal() {
    const termsModal = bootstrap.Modal.getInstance(document.getElementById('termsModal'));
    if (termsModal) termsModal.hide();
    const employerTerms = document.getElementById('employerTerms');
    const contractorTerms = document.getElementById('contractorTerms');
    if (employerTerms && window.tempEmployerTermsState !== undefined) {
      employerTerms.checked = window.tempEmployerTermsState;
      employerTerms.disabled = !window.tempEmployerTermsState;
    }
    if (contractorTerms && window.tempContractorTermsState !== undefined) {
      contractorTerms.checked = window.tempContractorTermsState;
      contractorTerms.disabled = !window.tempContractorTermsState;
    }
  }

  async loadFullProfile() {
    if (!this.userData || !this.userData.id) {
      this.showToast('Ù„Ø·ÙØ§Ù‹ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯', 'error');
      this.showPage('login');
      return;
    }
    try {
      const { data: profile, error } = await supabase
        .from('profiles')
        .select('*')
        .eq('user_id', this.userData.id)
        .single();
      if (error && error.code !== 'PGRST116') {
        console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø±ÙˆÙØ§ÛŒÙ„:', error);
      }
      const fullProfile = { ...this.userData, ...profile };
      this.displayFullProfile(fullProfile);
    } catch (error) {
      console.error('Ø®Ø·Ø§:', error);
      this.showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„', 'error');
    }
  }

  displayFullProfile(profile) {
    document.getElementById('profileDisplayName').textContent = profile.full_name || profile.company_name || 'Ú©Ø§Ø±Ø¨Ø±';
    document.getElementById('profileDisplayEmail').textContent = profile.email || '-';
    document.getElementById('profileDisplayType').textContent = profile.user_type === 'employer' ? 'Ú©Ø§Ø±ÙØ±Ù…Ø§' : 'Ù¾ÛŒÙ…Ø§Ù†Ú©Ø§Ø±';
    document.getElementById('profileDisplayAccountType').textContent = profile.account_type === 'individual' ? 'Ø´Ø®Øµ Ø­Ù‚ÛŒÙ‚ÛŒ' : 'Ø´Ø®Øµ Ø­Ù‚ÙˆÙ‚ÛŒ';
    document.getElementById('profileDisplayFullName').textContent = profile.full_name || profile.company_name || '-';
    document.getElementById('profileDisplayNationalId').textContent = profile.national_code || profile.company_id || '-';
    document.getElementById('profileDisplayMobile').textContent = profile.phone || '-';
    document.getElementById('profileDisplayPhone').textContent = profile.landline || '-';
    document.getElementById('profileDisplayAddress').textContent = profile.address || '-';
    const avatar = document.getElementById('profileAvatar');
    if (avatar) {
      avatar.textContent = (profile.full_name || profile.company_name || '?').charAt(0);
    }
    const companyFields = document.getElementById('profileCompanyFields');
    if (companyFields) {
      if (profile.account_type === 'company') {
        companyFields.style.display = 'block';
        document.getElementById('profileDisplayCompanyName').textContent = profile.company_name || '-';
        document.getElementById('profileDisplayRegistrationNo').textContent = profile.registration_no || '-';
        document.getElementById('profileDisplayCompanyType').textContent = profile.company_type || '-';
        document.getElementById('profileDisplayWebsite').textContent = profile.website || '-';
        document.getElementById('profileDisplayCompanyDesc').textContent = profile.company_description || '-';
      } else {
        companyFields.style.display = 'none';
      }
    }
    const contractorFields = document.getElementById('contractorProfileFields');
    if (contractorFields) {
      if (profile.user_type === 'contractor') {
        contractorFields.style.display = 'block';
        document.getElementById('profileDisplayMainExpertise').textContent = profile.main_expertise || '-';
        document.getElementById('profileDisplayStartYear').textContent = profile.start_year || '-';
        document.getElementById('profileDisplayTeamSize').textContent = profile.team_size || '-';
        document.getElementById('profileDisplayWorkArea').textContent = profile.work_area ? profile.work_area.join('ØŒ ') : '-';
        document.getElementById('profileDisplayContractMethod').textContent = profile.contract_method || '-';
        document.getElementById('profileDisplayInsurance').textContent = profile.insurance === 'yes' ? 'Ø¯Ø§Ø±Ø¯' : 'Ù†Ø¯Ø§Ø±Ø¯';
        document.getElementById('profileDisplayEquipment').textContent = profile.equipment || '-';
        this.displayProfileProjects(profile.projects);
        this.displayDocuments(profile.documents);
        const verificationStatus = document.getElementById('profileVerificationStatus');
        if (verificationStatus && profile.verification_status) {
          verificationStatus.style.display = 'block';
          const statusText = {
            'pending': 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø±Ø³ÛŒ',
            'verified': 'ØªØ£ÛŒÛŒØ¯ Ø´Ø¯Ù‡',
            'rejected': 'Ø±Ø¯ Ø´Ø¯Ù‡'
          }[profile.verification_status] || profile.verification_status;
          document.getElementById('profileVerificationText').textContent = statusText;
        }
      } else {
        contractorFields.style.display = 'none';
        const verificationStatus = document.getElementById('profileVerificationStatus');
        if (verificationStatus) verificationStatus.style.display = 'none';
      }
    }
  }

  displayProfileProjects(projects) {
    const container = document.getElementById('profileDisplayProjects');
    if (!container) return;
    if (!projects || projects.length === 0) {
      container.innerHTML = '<p class="text-muted">Ù¾Ø±ÙˆÚ˜Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>';
      return;
    }
    container.innerHTML = projects.map(project => `
      <div class="col-md-6 mb-3">
        <div class="border rounded p-3">
          <h6>${project.name || 'Ø¨Ø¯ÙˆÙ† Ù†Ø§Ù…'}</h6>
          <small class="text-muted d-block">Ø³Ø§Ù„: ${project.year || '-'}</small>
          <small class="text-muted d-block">Ù…Ø´ØªØ±ÛŒ: ${project.client || '-'}</small>
        </div>
      </div>
    `).join('');
  }

  displayDocuments(documents) {
    const container = document.getElementById('profileDisplayDocuments');
    if (!container) return;
    if (!documents || documents.length === 0) {
      container.innerHTML = '<p class="text-muted">Ù…Ø¯Ø±Ú©ÛŒ Ø¢Ù¾Ù„ÙˆØ¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>';
      return;
    }
    container.innerHTML = documents.map(doc => `
      <span class="badge bg-light text-dark p-2">
        <i class="bi bi-file-earmark-text me-1"></i>${doc.name}
      </span>
    `).join('');
  }

  populateEditYears() {
    const yearSelect = document.getElementById('editStartYear');
    if (!yearSelect) return;
    yearSelect.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>';
    for (let year = 1403; year >= 1350; year--) {
      const option = document.createElement('option');
      option.value = year;
      option.text = year;
      yearSelect.appendChild(option);
    }
  }

  addProjectToEdit() {
    const container = document.getElementById('editProjectsContainer');
    if (!container) return;
    const projectCount = container.children.length + 1;
    if (projectCount > 5) {
      this.showToast('Ø­Ø¯Ø§Ú©Ø«Ø± Ûµ Ù¾Ø±ÙˆÚ˜Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯.', 'error');
      return;
    }
    const projectDiv = document.createElement('div');
    projectDiv.className = 'card mb-3 project-card';
    projectDiv.innerHTML = `
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h6 class="card-title mb-0">Ù¾Ø±ÙˆÚ˜Ù‡ ${projectCount}</h6>
          <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('.project-card').remove()">
            <i class="bi bi-trash"></i>
          </button>
        </div>
        <div class="row">
          <div class="col-md-4 mb-3">
            <label class="form-label">Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡</label>
            <input type="text" class="form-control" name="editProjectName[]">
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Ø³Ø§Ù„ ØªØ­ÙˆÛŒÙ„</label>
            <input type="text" class="form-control" name="editProjectYear[]" placeholder="Ù…Ø«Ø§Ù„: 1402">
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Ù…Ø´ØªØ±ÛŒ</label>
            <input type="text" class="form-control" name="editProjectClient[]" placeholder="Ù†Ø§Ù… Ø´Ø±Ú©Øª ÛŒØ§ Ø´Ø®Øµ">
          </div>
        </div>
      </div>
    `;
    container.appendChild(projectDiv);
  }

  enableProfileEdit() {
    const viewMode = document.getElementById('profileViewMode');
    const editMode = document.getElementById('profileEditMode');
    if (!viewMode || !editMode) return;
    viewMode.style.display = 'none';
    editMode.style.display = 'block';
    if (document.getElementById('editFullName')) {
      document.getElementById('editFullName').value = this.userData?.full_name || this.userData?.name || '';
    }
    if (document.getElementById('editNationalId')) {
      document.getElementById('editNationalId').value = this.userData?.national_code || this.userData?.company_id || '';
    }
    if (document.getElementById('editEmail')) {
      document.getElementById('editEmail').value = this.userData?.email || '';
    }
    if (document.getElementById('editMobile')) {
      document.getElementById('editMobile').value = this.userData?.phone || this.userData?.mobile || '';
    }
    if (document.getElementById('editPhone')) {
      document.getElementById('editPhone').value = this.userData?.landline || '';
    }
    if (document.getElementById('editAddress')) {
      document.getElementById('editAddress').value = this.userData?.address || '';
    }
    if (document.getElementById('editPostalCode')) {
      document.getElementById('editPostalCode').value = this.userData?.postal_code || '';
    }
    if (document.getElementById('editProvince')) {
      document.getElementById('editProvince').value = this.userData?.province || '';
    }
    if (document.getElementById('editCity')) {
      document.getElementById('editCity').value = this.userData?.city || '';
    }
    this.populateEditYears();
    const companyFields = document.getElementById('editCompanyFields');
    if (companyFields) {
      if (this.userData?.account_type === 'company') {
        companyFields.style.display = 'flex';
        if (document.getElementById('editCompanyName')) {
          document.getElementById('editCompanyName').value = this.userData?.company_name || '';
        }
        if (document.getElementById('editRegistrationNo')) {
          document.getElementById('editRegistrationNo').value = this.userData?.registration_no || '';
        }
        if (document.getElementById('editCompanyType')) {
          document.getElementById('editCompanyType').value = this.userData?.company_type || '';
        }
        if (document.getElementById('editWebsite')) {
          document.getElementById('editWebsite').value = this.userData?.website || '';
        }
        if (document.getElementById('editCompanyDesc')) {
          document.getElementById('editCompanyDesc').value = this.userData?.company_description || '';
        }
      } else {
        companyFields.style.display = 'none';
      }
    }
    const contractorFields = document.getElementById('editContractorFields');
    const projectsSection = document.getElementById('editProjectsSection');
    const documentsSection = document.getElementById('editDocumentsSection');
    if (contractorFields && projectsSection && documentsSection) {
      if (this.userData?.user_type === 'contractor') {
        contractorFields.style.display = 'flex';
        projectsSection.style.display = 'block';
        documentsSection.style.display = 'block';
        if (document.getElementById('editMainExpertise')) {
          document.getElementById('editMainExpertise').value = this.userData?.main_expertise || '';
        }
        if (document.getElementById('editStartYear')) {
          document.getElementById('editStartYear').value = this.userData?.start_year || '';
        }
        if (document.getElementById('editTeamSize')) {
          document.getElementById('editTeamSize').value = this.userData?.team_size || '';
        }
        if (document.getElementById('editContractMethod')) {
          document.getElementById('editContractMethod').value = this.userData?.contract_method || '';
        }
        if (document.getElementById('editInsurance')) {
          document.getElementById('editInsurance').value = this.userData?.insurance || '';
        }
        if (document.getElementById('editEquipment')) {
          document.getElementById('editEquipment').value = this.userData?.equipment || '';
        }
        this.displayEditProjects(this.userData?.projects);
      } else {
        contractorFields.style.display = 'none';
        projectsSection.style.display = 'none';
        documentsSection.style.display = 'none';
      }
    }
  }

  displayEditProjects(projects) {
    const container = document.getElementById('editProjectsContainer');
    if (!container) return;
    container.innerHTML = '';
    if (projects && projects.length > 0) {
      projects.forEach((project, index) => {
        const projectDiv = document.createElement('div');
        projectDiv.className = 'card mb-3 project-card';
        projectDiv.innerHTML = `
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="card-title mb-0">Ù¾Ø±ÙˆÚ˜Ù‡ ${index + 1}</h6>
              <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('.project-card').remove()">
                <i class="bi bi-trash"></i>
              </button>
            </div>
            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label">Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡</label>
                <input type="text" class="form-control" name="editProjectName[]" value="${project.name || ''}">
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Ø³Ø§Ù„ ØªØ­ÙˆÛŒÙ„</label>
                <input type="text" class="form-control" name="editProjectYear[]" value="${project.year || ''}">
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Ù…Ø´ØªØ±ÛŒ</label>
                <input type="text" class="form-control" name="editProjectClient[]" value="${project.client || ''}">
              </div>
            </div>
          </div>
        `;
        container.appendChild(projectDiv);
      });
    }
  }

  cancelProfileEdit() {
    const viewMode = document.getElementById('profileViewMode');
    const editMode = document.getElementById('profileEditMode');
    if (viewMode && editMode) {
      viewMode.style.display = 'block';
      editMode.style.display = 'none';
    }
    this.loadFullProfile();
  }

  async saveProfileChanges() {
    const updatedData = {
      full_name: document.getElementById('editFullName')?.value,
      phone: document.getElementById('editMobile')?.value,
      landline: document.getElementById('editPhone')?.value,
      address: document.getElementById('editAddress')?.value,
      postal_code: document.getElementById('editPostalCode')?.value,
      province: document.getElementById('editProvince')?.value,
      city: document.getElementById('editCity')?.value,
      national_code: document.getElementById('editNationalId')?.value,
    };
    if (updatedData.phone && !this.isValidMobile(updatedData.phone)) {
      this.showToast('Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª', 'error');
      return;
    }
    if (this.userData?.account_type === 'company') {
      updatedData.company_name = document.getElementById('editCompanyName')?.value;
      updatedData.registration_no = document.getElementById('editRegistrationNo')?.value;
      updatedData.company_type = document.getElementById('editCompanyType')?.value;
      updatedData.website = document.getElementById('editWebsite')?.value;
      updatedData.company_description = document.getElementById('editCompanyDesc')?.value;
    }
    if (this.userData?.user_type === 'contractor') {
      updatedData.main_expertise = document.getElementById('editMainExpertise')?.value;
      updatedData.start_year = document.getElementById('editStartYear')?.value;
      updatedData.team_size = document.getElementById('editTeamSize')?.value;
      updatedData.contract_method = document.getElementById('editContractMethod')?.value;
      updatedData.insurance = document.getElementById('editInsurance')?.value;
      updatedData.equipment = document.getElementById('editEquipment')?.value;
      const projects = [];
      const projectNames = document.querySelectorAll('input[name="editProjectName[]"]');
      const projectYears = document.querySelectorAll('input[name="editProjectYear[]"]');
      const projectClients = document.querySelectorAll('input[name="editProjectClient[]"]');
      for (let i = 0; i < projectNames.length; i++) {
        if (projectNames[i].value || projectYears[i].value || projectClients[i].value) {
          projects.push({
            name: projectNames[i].value,
            year: projectYears[i].value,
            client: projectClients[i].value
          });
        }
      }
      updatedData.projects = projects;
    }
    try {
      const { error } = await supabase
        .from('profiles')
        .update(updatedData)
        .eq('user_id', this.userData.id);
      if (error) throw error;
      this.userData = { ...this.userData, ...updatedData };
      localStorage.setItem('peymanyar_user', JSON.stringify(this.userData));
      this.showToast('Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ² Ø´Ø¯', 'success');
      const viewMode = document.getElementById('profileViewMode');
      const editMode = document.getElementById('profileEditMode');
      if (viewMode && editMode) {
        viewMode.style.display = 'block';
        editMode.style.display = 'none';
      }
      this.loadFullProfile();
    } catch (error) {
      this.showToast('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª: ' + error.message, 'error');
    }
  }

  setupForms() {
    this.setupEmployerForm();
    this.setupContractorForm();
    this.setupValidation();
  }

  setupAssistant() {
    this.loadAssistantMessages();
    this.setupAssistantEvents();
  }

  setupMessagingSystem() {
    window.PeymanYar = function() {
      if (window.app) window.app.showMessagesResult("ØªØ§Ø¨Ø¹ PeymanYar Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ø´Ø¯!<br>Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø³ÛŒØ³ØªÙ… Ù¾ÛŒØ§Ù…â€ŒÛŒØ§Ø± Ø§Ø³Øª.");
    };
  }

  setupAccessibility() {
    this.setupFocusTrap();
    this.addSkipToContentLink();
  }

  setupHeroSlider() {
    this.heroSlides = document.querySelectorAll('.hero-slide');
    this.heroSlideDots = document.querySelectorAll('.hero-slide-dot');
    if (this.heroSlides.length > 0) {
      this.startHeroSlider();
      this.heroSlideDots.forEach((dot, index) => {
        dot.addEventListener('click', () => {
          this.goToHeroSlide(index);
        });
      });
      const slider = document.querySelector('.hero-image-slider');
      if (slider) {
        slider.addEventListener('mouseenter', () => {
          this.stopHeroSlider();
        });
        slider.addEventListener('mouseleave', () => {
          this.startHeroSlider();
        });
      }
    }
  }

  startHeroSlider() {
    this.stopHeroSlider();
    this.heroSlideInterval = setInterval(() => {
      this.nextHeroSlide();
    }, 10000);
  }

  stopHeroSlider() {
    if (this.heroSlideInterval) {
      clearInterval(this.heroSlideInterval);
      this.heroSlideInterval = null;
    }
  }

  nextHeroSlide() {
    this.heroSlideIndex = (this.heroSlideIndex + 1) % this.heroSlides.length;
    this.updateHeroSlider();
  }

  goToHeroSlide(index) {
    this.heroSlideIndex = index;
    this.updateHeroSlider();
  }

  updateHeroSlider() {
    this.heroSlides.forEach(slide => {
      slide.classList.remove('active');
    });
    this.heroSlideDots.forEach(dot => {
      dot.classList.remove('active');
    });
    if (this.heroSlides[this.heroSlideIndex]) {
      this.heroSlides[this.heroSlideIndex].classList.add('active');
    }
    if (this.heroSlideDots[this.heroSlideIndex]) {
      this.heroSlideDots[this.heroSlideIndex].classList.add('active');
    }
  }

  showPage(pageId, pushState = true) {
    document.querySelectorAll('.page-section').forEach(page => {
      page.classList.remove('active');
      page.setAttribute('aria-hidden', 'true');
      page.style.display = 'none';
    });
    const targetPage = document.getElementById(pageId);
    if (targetPage) {
      targetPage.classList.add('active');
      targetPage.style.display = 'block';
      targetPage.setAttribute('aria-hidden', 'false');
      window.scrollTo({ top: 0, behavior: 'smooth' });
      if (pushState) {
        history.pushState({ page: pageId }, '', `#${pageId}`);
      }
      this.currentPage = pageId;
      this.updateActiveLinks(pageId);
      this.dispatchPageChangeEvent(pageId);
      if (pageId === 'profile') {
        this.loadFullProfile();
      }
      if (pageId === 'projects' || pageId === 'projectsPage') {
        this.loadProjects();
      }
    }
  }

  updateActiveLinks(pageId) {
    document.querySelectorAll('.nav-link').forEach(link => {
      link.classList.remove('active');
      link.removeAttribute('aria-current');
    });
    const activeLink = document.querySelector(`[onclick*="${pageId}"]`);
    if (activeLink) {
      activeLink.classList.add('active');
      activeLink.setAttribute('aria-current', 'page');
    }
  }

  dispatchPageChangeEvent(pageId) {
    const event = new CustomEvent('pageChanged', { detail: { pageId } });
    window.dispatchEvent(event);
  }

  showMainPage() {
    this.showPage('home');
  }

  showLogin() {
    this.showPage('login');
  }

  showForgotPassword() {
    this.showPage('forgotPassword');
  }

  showMessagesResult(content) {
    const resultElement = document.getElementById('messagesResult');
    if (resultElement) {
      resultElement.innerHTML = content;
    }
  }

  showMessagesLoading(show) {
    const loadingElement = document.getElementById('messagesLoading');
    if (loadingElement) {
      loadingElement.style.display = show ? 'block' : 'none';
    }
  }

  analyzeMessages() {
    this.showMessagesLoading(true);
    setTimeout(() => {
      this.showMessagesResult(`
        <strong>âœ… ØªØ­Ù„ÛŒÙ„ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!</strong><br><br>
        ğŸ“Š <strong>Ù†ØªØ§ÛŒØ¬ ØªØ­Ù„ÛŒÙ„:</strong><br>
        â€¢ ØªØ¹Ø¯Ø§Ø¯ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§: Û±,Û²Û´Û· Ù¾ÛŒØ§Ù…<br>
        â€¢ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø·ÙˆÙ„ Ù¾ÛŒØ§Ù…: Û´Û² Ú©Ø§Ø±Ø§Ú©ØªØ±<br>
        â€¢ Ù…Ø­Ø¨ÙˆØ¨â€ŒØªØ±ÛŒÙ† Ú©Ù„Ù…Ø§Øª: Ø³Ù„Ø§Ù…ØŒ Ù…Ù…Ù†ÙˆÙ†ØŒ Ù„Ø·ÙØ§<br>
        â€¢ ØªØ­Ù„ÛŒÙ„ Ø§Ø­Ø³Ø§Ø³Ø§Øª: Û¸ÛµÙª Ù…Ø«Ø¨ØªØŒ Û±Û²Ùª Ø®Ù†Ø«ÛŒØŒ Û³Ùª Ù…Ù†ÙÛŒ<br>
        â€¢ Ø²Ù…Ø§Ù† Ø§ÙˆØ¬ ÙØ¹Ø§Ù„ÛŒØª: Û±Û¸:Û°Û° ØªØ§ Û²Û²:Û°Û°<br>
        <br>
        <em>ØªØ­Ù„ÛŒÙ„ Ø¯Ø± ØªØ§Ø±ÛŒØ® ${new Date().toLocaleDateString('fa-IR')} Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.</em>
      `);
      this.showMessagesLoading(false);
    }, 1500);
  }

  sendGroupMessage() {
    this.showMessagesLoading(true);
    setTimeout(() => {
      this.showMessagesResult(`
        <strong>ğŸ“¨ Ù¾ÛŒØ§Ù… Ú¯Ø±ÙˆÙ‡ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯!</strong><br><br>
        âœ… <strong>Ø¬Ø²Ø¦ÛŒØ§Øª Ø§Ø±Ø³Ø§Ù„:</strong><br>
        â€¢ ØªØ¹Ø¯Ø§Ø¯ Ú¯ÛŒØ±Ù†Ø¯Ú¯Ø§Ù†: Û±Û²Û¸ Ù†ÙØ±<br>
        â€¢ Ø²Ù…Ø§Ù† Ø§Ø±Ø³Ø§Ù„: ${new Date().toLocaleTimeString('fa-IR')}<br>
        â€¢ ÙˆØ¶Ø¹ÛŒØª: Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...<br>
        â€¢ Ù¾ÛŒØ§Ù… Ø§Ø±Ø³Ø§Ù„ÛŒ: "Ø¬Ù„Ø³Ù‡ Ù‡ÙØªÚ¯ÛŒ ÙØ±Ø¯Ø§ Ø³Ø§Ø¹Øª Û±Û° ØµØ¨Ø­ Ø¨Ø±Ú¯Ø²Ø§Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯."<br>
        <br>
        <em>Ù¾ÛŒØ§Ù… Ø¨Ù‡ Û³ Ú¯Ø±ÙˆÙ‡ Ú©Ø§Ø±ÛŒ Ù…Ø®ØªÙ„Ù Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.</em>
      `);
      this.showMessagesLoading(false);
    }, 2000);
  }

  searchMessages() {
    this.showMessagesLoading(true);
    setTimeout(() => {
      this.showMessagesResult(`
        <strong>ğŸ” Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ:</strong><br><br>
        ğŸ“ <strong>Ø¨Ø±Ø§ÛŒ Ú©Ù„ÛŒØ¯ÙˆØ§Ú˜Ù‡ "Ù¾Ø±ÙˆÚ˜Ù‡":</strong><br>
        â€¢ Û´ÛµÛ· Ù¾ÛŒØ§Ù… ÛŒØ§ÙØª Ø´Ø¯<br>
        â€¢ ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯Ù‡:<br>
        &nbsp;&nbsp;âœ“ ØªØ§Ø±ÛŒØ®: Û± Ù…Ø§Ù‡ Ø§Ø®ÛŒØ±<br>
        &nbsp;&nbsp;âœ“ Ú¯Ø±ÙˆÙ‡: ØªÛŒÙ… ÙÙ†ÛŒ<br>
        &nbsp;&nbsp;âœ“ Ù†ÙˆØ¹: Ù¾ÛŒØ§Ù… Ù…ØªÙ†ÛŒ<br>
        <br>
        ğŸ† <strong>Ù…Ù‡Ù…â€ŒØªØ±ÛŒÙ† Ù†ØªØ§ÛŒØ¬:</strong><br>
        Û±. "Ù¾Ø±ÙˆÚ˜Ù‡ Ø¬Ø¯ÛŒØ¯ Ø§Ø² Ù‡ÙØªÙ‡ Ø¢ÛŒÙ†Ø¯Ù‡ Ø´Ø±ÙˆØ¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯"<br>
        Û². "Ø¬Ù„Ø³Ù‡ Ø¨Ø±Ø±Ø³ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡ ÙØ±Ø¯Ø§ Ø¨Ø±Ú¯Ø²Ø§Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯"<br>
        Û³. "Ø¯Ø¯Ù„Ø§ÛŒÙ† Ù¾Ø±ÙˆÚ˜Ù‡ ØªØ§ Ù¾Ø§ÛŒØ§Ù† Ù…Ø§Ù‡ ØªÙ…Ø¯ÛŒØ¯ Ø´Ø¯"<br>
        <br>
        <em>Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Û±Û²,Û¸Û´Ûµ Ù¾ÛŒØ§Ù… Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.</em>
      `);
      this.showMessagesLoading(false);
    }, 1800);
  }

  showStatistics() {
    this.showMessagesLoading(true);
    setTimeout(() => {
      this.showMessagesResult(`
        <strong>ğŸ“ˆ Ø¢Ù…Ø§Ø± Ùˆ Ú¯Ø²Ø§Ø±Ø´ Ù…Ø§Ù‡Ø§Ù†Ù‡</strong><br><br>
        ğŸ“… <strong>Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ:</strong> Û± ÙØ±ÙˆØ±Ø¯ÛŒÙ† ØªØ§ Û³Û° ÙØ±ÙˆØ±Ø¯ÛŒÙ† Û±Û´Û°Û³<br><br>
        ğŸ“Š <strong>Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ:</strong><br>
        â€¢ Ú©Ù„ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§: Û±Û²,Û¸Û´Ûµ Ù¾ÛŒØ§Ù…<br>
        â€¢ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ÛŒ: Û¶,Û´Û²Û± Ù¾ÛŒØ§Ù…<br>
        â€¢ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØªÛŒ: Û¶,Û´Û²Û´ Ù¾ÛŒØ§Ù…<br>
        â€¢ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ÛŒ: Û²Û´Û· ÙØ§ÛŒÙ„<br>
        â€¢ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÙØ¹Ø§Ù„: Û¸Û¹ Ù†ÙØ±<br><br>
        ğŸ“ˆ <strong>Ø±ÙˆÙ†Ø¯ Ø±ÙˆØ²Ø§Ù†Ù‡:</strong><br>
        â€¢ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ù¾ÛŒØ§Ù… Ø±ÙˆØ²Ø§Ù†Ù‡: Û´Û²Û¸ Ù¾ÛŒØ§Ù…<br>
        â€¢ Ù¾Ø±ØªØ±Ø§ÙÛŒÚ©â€ŒØªØ±ÛŒÙ† Ø±ÙˆØ²: Ù¾Ù†Ø¬Ø´Ù†Ø¨Ù‡ - Û¶Û¸Û¹ Ù¾ÛŒØ§Ù…<br>
        â€¢ Ú©Ù…â€ŒØªØ±Ø§ÙÛŒÚ©â€ŒØªØ±ÛŒÙ† Ø±ÙˆØ²: Ø¬Ù…Ø¹Ù‡ - Û²Û±Û° Ù¾ÛŒØ§Ù…<br><br>
        ğŸ† <strong>Ø¨Ø±ØªØ±ÛŒÙ†â€ŒÙ‡Ø§:</strong><br>
        â€¢ ÙØ¹Ø§Ù„â€ŒØªØ±ÛŒÙ† Ú©Ø§Ø±Ø¨Ø±: Ø¹Ù„ÛŒ Ù…Ø­Ù…Ø¯ÛŒ (Û±,Û²Û´Û· Ù¾ÛŒØ§Ù…)<br>
        â€¢ Ù…Ø­Ø¨ÙˆØ¨â€ŒØªØ±ÛŒÙ† Ú¯Ø±ÙˆÙ‡: ØªÛŒÙ… ÙÙ†ÛŒ (Û³,Û´ÛµÛ¶ Ù¾ÛŒØ§Ù…)<br>
        â€¢ Ù¾Ø±Ú©Ø§Ø±Ø¨Ø±Ø¯ØªØ±ÛŒÙ† ÙˆØ§Ú˜Ù‡: "Ø³Ù„Ø§Ù…" (Û¸Û¹Û´ Ø¨Ø§Ø±)
      `);
      this.showMessagesLoading(false);
    }, 1200);
  }

  openSettings() {
    this.showMessagesResult(`
      <strong>âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³ÛŒØ³ØªÙ…</strong><br><br>
      ğŸ”§ <strong>ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙØ¹Ù„ÛŒ:</strong><br>
      â€¢ Ø­Ø§Ù„Øª ØªØ§Ø±ÛŒÚ©: ØºÛŒØ±ÙØ¹Ø§Ù„<br>
      â€¢ Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§: ÙØ¹Ø§Ù„<br>
      â€¢ Ø°Ø®ÛŒØ±Ù‡ Ø®ÙˆØ¯Ú©Ø§Ø±: Ù‡Ø± Ûµ Ø¯Ù‚ÛŒÙ‚Ù‡<br>
      â€¢ ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ®: Ø´Ù…Ø³ÛŒ<br>
      â€¢ Ø²Ø¨Ø§Ù†: ÙØ§Ø±Ø³ÛŒ<br>
      â€¢ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª ÙØ§ÛŒÙ„ Ø¢Ù¾Ù„ÙˆØ¯: ÛµÛ° Ù…Ú¯Ø§Ø¨Ø§ÛŒØª<br><br>
      âš¡ <strong>ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾ÛŒØ´Ø±ÙØªÙ‡:</strong><br>
      <button class="btn-messages" onclick="app.changeMessagesTheme()">ØªØºÛŒÛŒØ± ØªÙ…</button>
      <button class="btn-messages" onclick="app.resetMessagesSettings()">Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
      <button class="btn-messages" onclick="app.exportMessagesData()">Ø®Ø±ÙˆØ¬ÛŒ Ú¯Ø±ÙØªÙ†</button>
    `);
  }

  syncData() {
    this.showMessagesLoading(true);
    setTimeout(() => {
      this.showMessagesResult(`
        <strong>ğŸ”„ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!</strong><br><br>
        âœ… <strong>Ø¬Ø²Ø¦ÛŒØ§Øª Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ:</strong><br>
        â€¢ ØªØ§Ø±ÛŒØ® Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ: ${new Date().toLocaleString('fa-IR')}<br>
        â€¢ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯: Û±Û²Û· Ù¾ÛŒØ§Ù…<br>
        â€¢ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯: Û¸ ÙØ§ÛŒÙ„<br>
        â€¢ ØªÙ…Ø§Ø³â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯: Û³ ØªÙ…Ø§Ø³<br>
        â€¢ ÙØ¶Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡: Û².Û´ Ø§Ø² Û±Û° Ú¯ÛŒÚ¯Ø§Ø¨Ø§ÛŒØª<br>
        â€¢ ÙˆØ¶Ø¹ÛŒØª Ø§ØªØµØ§Ù„: Ù¾Ø§ÛŒØ¯Ø§Ø±<br><br>
        <em>Ø¢Ø®Ø±ÛŒÙ† Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ù‚Ø¨Ù„ Ø§Ø² Ø§ÛŒÙ†: Û² Ø³Ø§Ø¹Øª Ù¾ÛŒØ´</em>
      `);
      this.showMessagesLoading(false);
    }, 2500);
  }

  cleanupStorage() {
    this.showMessagesLoading(true);
    setTimeout(() => {
      this.showMessagesResult(`
        <strong>ğŸ§¹ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø­Ø§ÙØ¸Ù‡ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!</strong><br><br>
        ğŸ“‰ <strong>Ù†ØªØ§ÛŒØ¬ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ:</strong><br>
        â€¢ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø­Ø°Ù Ø´Ø¯Ù‡: Û²,Û´ÛµÛ· Ù¾ÛŒØ§Ù…<br>
        â€¢ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…ÙˆÙ‚Øª Ø­Ø°Ù Ø´Ø¯Ù‡: Û±Û²Û´ ÙØ§ÛŒÙ„<br>
        â€¢ Ú©Ø´ Ø­Ø°Ù Ø´Ø¯Ù‡: Û´Û·Û² Ù…Ú¯Ø§Ø¨Ø§ÛŒØª<br>
        â€¢ ÙØ¶Ø§ÛŒ Ø¢Ø²Ø§Ø¯ Ø´Ø¯Ù‡: Û±.Û¸ Ú¯ÛŒÚ¯Ø§Ø¨Ø§ÛŒØª<br>
        â€¢ ÙØ¶Ø§ÛŒ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: Û¸.Û² Ú¯ÛŒÚ¯Ø§Ø¨Ø§ÛŒØª<br><br>
        âš ï¸ <strong>ØªÙˆØ¬Ù‡:</strong><br>
        Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø­Ø°Ù Ø´Ø¯Ù‡ Ø§Ø² ØªØ§Ø±ÛŒØ® ${new Date(new Date().setMonth(new Date().getMonth() - 6)).toLocaleDateString('fa-IR')} ØªØ§ Ø§Ù…Ø±ÙˆØ² Ø¨ÙˆØ¯Ù‡â€ŒØ§Ù†Ø¯.
      `);
      this.showMessagesLoading(false);
    }, 3000);
  }

  showHelp() {
    this.showMessagesResult(`
      <strong>ğŸ“š Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù¾ÛŒØ§Ù…â€ŒÛŒØ§Ø±</strong><br><br>
      ğŸ“– <strong>Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ:</strong><br>
      Û±. ØªØ­Ù„ÛŒÙ„ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ - Ø¢Ù†Ø§Ù„ÛŒØ² Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù…Ø­ØªÙˆØ§ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§<br>
      Û². Ø§Ø±Ø³Ø§Ù„ Ú¯Ø±ÙˆÙ‡ÛŒ - Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ú†Ù†Ø¯ÛŒÙ† Ù†ÙØ± Ù‡Ù…Ø²Ù…Ø§Ù†<br>
      Û³. Ø¬Ø³ØªØ¬Ùˆ - ÛŒØ§ÙØªÙ† Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø®Ø§Øµ Ø¨Ø§ ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù<br>
      Û´. Ø¢Ù…Ø§Ø± - Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ ØªØ­Ù„ÛŒÙ„ÛŒ Ø§Ø² ÙØ¹Ø§Ù„ÛŒØªâ€ŒÙ‡Ø§<br>
      Ûµ. ØªÙ†Ø¸ÛŒÙ…Ø§Øª - Ø´Ø®ØµÛŒâ€ŒØ³Ø§Ø²ÛŒ Ø³ÛŒØ³ØªÙ…<br>
      Û¶. Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ - Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø§ Ø³Ø±ÙˆØ±<br>
      Û·. Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ - Ù…Ø¯ÛŒØ±ÛŒØª ÙØ¶Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ<br><br>
      ğŸ“ <strong>Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ:</strong><br>
      â€¢ Ø§ÛŒÙ…ÛŒÙ„: support@peymanyar.com<br>
      â€¢ ØªÙ„ÙÙ†: Û°Û²Û±-Û±Û²Û³Û´ÛµÛ¶Û·Û¸<br>
      â€¢ Ø³Ø§Ø¹Øª Ú©Ø§Ø±ÛŒ: Û¸ ØµØ¨Ø­ ØªØ§ Ûµ Ø¹ØµØ±<br><br>
      ğŸ”’ <strong>Ø§Ù…Ù†ÛŒØª:</strong><br>
      â€¢ ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø±Ù…Ø²Ù†Ú¯Ø§Ø±ÛŒ Ø´Ø¯Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯<br>
      â€¢ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ø§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ùˆ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ø¯Ùˆ Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ<br>
      â€¢ Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ø±ÙˆØ²Ø§Ù†Ù‡<br><br>
      <em>Ù†Ø³Ø®Ù‡: Û².Û°.Û± - Ø¢Ø®Ø±ÛŒÙ† Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: ÙØ±ÙˆØ±Ø¯ÛŒÙ† Û±Û´Û°Û³</em>
    `);
  }

  changeMessagesTheme() {
    const messagingPage = document.querySelector('.messaging-page');
    if (messagingPage) {
      messagingPage.style.background = 'linear-gradient(135deg, #1a202c 0%, #2d3748 100%)';
      messagingPage.style.color = '#e0e0e0';
    }
    this.showMessagesResult('ØªÙ… Ø³ÛŒØ³ØªÙ… Ù¾ÛŒØ§Ù…â€ŒÛŒØ§Ø± Ø¨Ù‡ Ø­Ø§Ù„Øª ØªØ§Ø±ÛŒÚ© ØªØºÛŒÛŒØ± Ú©Ø±Ø¯.');
  }

  resetMessagesSettings() {
    this.showMessagesResult('ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³ÛŒØ³ØªÙ… Ù¾ÛŒØ§Ù…â€ŒÛŒØ§Ø± Ø¨Ù‡ Ø­Ø§Ù„Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø´Ø¯Ù†Ø¯.');
  }

  exportMessagesData() {
    this.showMessagesLoading(true);
    setTimeout(() => {
      this.showMessagesResult('Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ… Ù¾ÛŒØ§Ù…â€ŒÛŒØ§Ø± Ø¨Ø§ ÙØ±Ù…Øª JSON Ùˆ CSV Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù†Ø¯.');
      this.showMessagesLoading(false);
    }, 1500);
  }

  toggleAssistant() {
    const assistantWindow = document.getElementById('assistantWindow');
    const toggleBtn = document.querySelector('.assistant-toggle');
    if (assistantWindow.classList.contains('active')) {
      assistantWindow.classList.remove('active');
      assistantWindow.setAttribute('aria-hidden', 'true');
      toggleBtn.setAttribute('aria-expanded', 'false');
    } else {
      assistantWindow.classList.add('active');
      assistantWindow.setAttribute('aria-hidden', 'false');
      toggleBtn.setAttribute('aria-expanded', 'true');
      this.markAssistantAsRead();
      setTimeout(() => {
        const input = document.getElementById('assistantInput');
        if (input) input.focus();
      }, 100);
    }
  }

  sendAssistantMessage() {
    const input = document.getElementById('assistantInput');
    const message = input.value.trim();
    if (!message) return;
    this.addAssistantMessage('user', message);
    input.value = '';
    setTimeout(() => {
      this.generateAssistantResponse(message);
    }, 1000);
  }

  addAssistantMessage(role, content) {
    const container = document.getElementById('assistantMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${role}`;
    messageDiv.innerHTML = `<div class="message-bubble">${this.sanitizeHTML(content)}</div>`;
    container.appendChild(messageDiv);
    container.scrollTop = container.scrollHeight;
    this.assistantMessages.push({ role, content, timestamp: new Date().toISOString() });
    this.saveAssistantMessages();
  }

  generateAssistantResponse(userMessage) {
    const responses = {
      'Ø«Ø¨Øª Ù†Ø§Ù…': 'Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§Ø² Ù…Ù†ÙˆÛŒ Ø¨Ø§Ù„Ø§ Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ "Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø§Ø±ÙØ±Ù…Ø§" ÛŒØ§ "Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù¾ÛŒÙ…Ø§Ù†Ú©Ø§Ø±" Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.',
      'Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…': 'Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§Ø² Ù…Ù†ÙˆÛŒ Ø¨Ø§Ù„Ø§ Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ "Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø§Ø±ÙØ±Ù…Ø§" ÛŒØ§ "Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù¾ÛŒÙ…Ø§Ù†Ú©Ø§Ø±" Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.',
      'Ù¾ÛŒÙ…Ø§Ù†Ú©Ø§Ø±': 'Ø¨Ø±Ø§ÛŒ Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒÙ…Ø§Ù†Ú©Ø§Ø± Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ù‡ ØµÙØ­Ù‡ "Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒÙ…Ø§Ù†Ú©Ø§Ø±" Ù…Ø±Ø§Ø¬Ø¹Ù‡ Ú©Ù†ÛŒØ¯.',
      'Ø¬Ø³ØªØ¬Ùˆ': 'Ø¨Ø±Ø§ÛŒ Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒÙ…Ø§Ù†Ú©Ø§Ø± Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ù‡ ØµÙØ­Ù‡ "Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒÙ…Ø§Ù†Ú©Ø§Ø±" Ù…Ø±Ø§Ø¬Ø¹Ù‡ Ú©Ù†ÛŒØ¯.',
      'Ù‚ÛŒÙ…Øª': 'Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ùˆ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§ÙˆÙ„ÛŒÙ‡ Ø§Ø² Ù¾Ù„ØªÙØ±Ù… Ù¾ÛŒÙ…Ø§Ù†â€ŒÛŒØ§Ø± Ú©Ø§Ù…Ù„Ø§Ù‹ Ø±Ø§ÛŒÚ¯Ø§Ù† Ø§Ø³Øª.',
      'Ù‡Ø²ÛŒÙ†Ù‡': 'Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ùˆ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§ÙˆÙ„ÛŒÙ‡ Ø§Ø² Ù¾Ù„ØªÙØ±Ù… Ù¾ÛŒÙ…Ø§Ù†â€ŒÛŒØ§Ø± Ú©Ø§Ù…Ù„Ø§Ù‹ Ø±Ø§ÛŒÚ¯Ø§Ù† Ø§Ø³Øª.',
      'Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ': 'ØªÛŒÙ… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù…Ø§ Ø§Ø² Ø·Ø±ÛŒÙ‚ info@peymanyar.com Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ø§Ø³Øª.',
      'ØªÙ…Ø§Ø³': 'Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ø§ Ø´Ù…Ø§Ø±Ù‡ Û°Û²Û±-Û±Û²Û³Û´ÛµÛ¶Û·Û¸ Ø¨Ø§ Ù…Ø§ ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯.',
      'Ù¾ÛŒØ§Ù…': 'Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ù‡ ØµÙØ­Ù‡ "Ù¾ÛŒØ§Ù…â€ŒÛŒØ§Ø±" Ù…Ø±Ø§Ø¬Ø¹Ù‡ Ú©Ù†ÛŒØ¯.',
      'Ù¾ÛŒØ§Ù…â€ŒÛŒØ§Ø±': 'ØµÙØ­Ù‡ Ù¾ÛŒØ§Ù…â€ŒÛŒØ§Ø± Ø¯Ø± Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±Ø¯. Ø¯Ø± Ø¢Ù†Ø¬Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø±Ø§ Ù…Ø¯ÛŒØ±ÛŒØª Ùˆ ØªØ­Ù„ÛŒÙ„ Ú©Ù†ÛŒØ¯.'
    };
    let response = 'Ù…ØªÙˆØ¬Ù‡ Ø³ÙˆØ§Ù„ Ø´Ù…Ø§ Ù†Ø´Ø¯Ù…. Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø³ÙˆØ§Ù„ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù‡ Ø´Ú©Ù„ Ø¯ÛŒÚ¯Ø±ÛŒ Ù…Ø·Ø±Ø­ Ú©Ù†ÛŒØ¯.';
    for (const [keyword, answer] of Object.entries(responses)) {
      if (userMessage.includes(keyword)) {
        response = answer;
        break;
      }
    }
    this.addAssistantMessage('assistant', response);
  }

  loadAssistantMessages() {
    const saved = localStorage.getItem('peymanyar_assistant_messages');
    if (saved) {
      this.assistantMessages = JSON.parse(saved);
      this.renderAssistantMessages();
    } else {
      this.addAssistantMessage('assistant', 'Ø³Ù„Ø§Ù…! ğŸ‘‹ Ù…Ù† Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù¾ÛŒÙ…Ø§Ù†â€ŒÛŒØ§Ø± Ù‡Ø³ØªÙ…. Ú†Ø·ÙˆØ± Ù…ÛŒâ€ŒØªÙˆÙ†Ù… Ú©Ù…Ú©ØªÙˆÙ† Ú©Ù†Ù…ØŸ');
    }
  }

  saveAssistantMessages() {
    localStorage.setItem('peymanyar_assistant_messages', JSON.stringify(this.assistantMessages.slice(-50)));
  }

  renderAssistantMessages() {
    const container = document.getElementById('assistantMessages');
    container.innerHTML = '';
    this.assistantMessages.forEach(msg => {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${msg.role}`;
      messageDiv.innerHTML = `<div class="message-bubble">${this.sanitizeHTML(msg.content)}</div>`;
      container.appendChild(messageDiv);
    });
  }

  markAssistantAsRead() {
    const badge = document.getElementById('assistantNotification');
    if (badge) {
      badge.style.display = 'none';
    }
  }

  setupLoginForms() {
    const loginForm = document.getElementById('loginForm');
    if (loginForm) {
      loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        this.handleLogin();
      });
    }
    const forgotForm = document.getElementById('forgotPasswordForm');
    if (forgotForm) {
      forgotForm.addEventListener('submit', (e) => {
        e.preventDefault();
        this.handleForgotPassword();
      });
    }
  }

  async handleLogin() {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    try {
      const { data, error } = await supabase.auth.signInWithPassword({
        email, password
      });
      if (error) throw error;
      const { data: profile, error: profileError } = await supabase
        .from('profiles')
        .select('*')
        .eq('user_id', data.user.id)
        .single();
      if (profileError && profileError.code !== 'PGRST116') {
        console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø±ÙˆÙØ§ÛŒÙ„:', profileError);
      }
      this.userData = {
        id: data.user.id,
        email: data.user.email,
        full_name: profile?.full_name || profile?.company_name || 'Ú©Ø§Ø±Ø¨Ø±',
        phone: profile?.phone || '',
        company_name: profile?.company_name || '',
        address: profile?.address || '',
        user_type: profile?.user_type || 'employer',
        account_type: profile?.account_type || 'individual'
      };
      this.showToast('ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯', 'success');
      this.showPage('home');
      this.checkAdminStatus();
    } catch (error) {
      this.showToast('Ø§ÛŒÙ…ÛŒÙ„ ÛŒØ§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª', 'error');
    }
  }

  handleForgotPassword() {
    const email = document.getElementById('forgotEmail')?.value || '';
    if (!email) {
      this.showToast('Ù„Ø·ÙØ§Ù‹ Ø§ÛŒÙ…ÛŒÙ„ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
      return;
    }
    this.showToast(`Ù„ÛŒÙ†Ú© Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø¨Ù‡ ${email} Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯`, 'success');
    setTimeout(() => {
      this.showPage('login');
    }, 2000);
  }

  togglePasswordVisibility(id) {
    const input = document.getElementById(id);
    if (input.type === 'password') {
      input.type = 'text';
    } else {
      input.type = 'password';
    }
  }

  setupPasswordValidation() {
    const employerPassword = document.getElementById('employerPassword');
    const employerConfirm = document.getElementById('employerConfirmPassword');
    if (employerPassword && employerConfirm) {
      const checkEmployerMatch = () => {
        if (employerConfirm.value && employerPassword.value !== employerConfirm.value) {
          employerConfirm.classList.add('is-invalid');
          let feedback = document.getElementById('employerConfirmFeedback');
          if (!feedback) {
            feedback = document.createElement('div');
            feedback.id = 'employerConfirmFeedback';
            feedback.className = 'invalid-feedback';
            employerConfirm.parentNode.appendChild(feedback);
          }
          feedback.textContent = 'Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ùˆ ØªÚ©Ø±Ø§Ø± Ø¢Ù† ÛŒÚ©Ø³Ø§Ù† Ù†ÛŒØ³ØªÙ†Ø¯';
          feedback.style.display = 'block';
        } else {
          employerConfirm.classList.remove('is-invalid');
          const feedback = document.getElementById('employerConfirmFeedback');
          if (feedback) feedback.style.display = 'none';
        }
      };
      employerPassword.addEventListener('keyup', checkEmployerMatch);
      employerConfirm.addEventListener('keyup', checkEmployerMatch);
    }
    const contractorPassword = document.getElementById('contractorPassword');
    const contractorConfirm = document.getElementById('contractorConfirmPassword');
    if (contractorPassword && contractorConfirm) {
      const checkContractorMatch = () => {
        if (contractorConfirm.value && contractorPassword.value !== contractorConfirm.value) {
          contractorConfirm.classList.add('is-invalid');
          let feedback = document.getElementById('contractorConfirmFeedback');
          if (!feedback) {
            feedback = document.createElement('div');
            feedback.id = 'contractorConfirmFeedback';
            feedback.className = 'invalid-feedback';
            contractorConfirm.parentNode.appendChild(feedback);
          }
          feedback.textContent = 'Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ùˆ ØªÚ©Ø±Ø§Ø± Ø¢Ù† ÛŒÚ©Ø³Ø§Ù† Ù†ÛŒØ³ØªÙ†Ø¯';
          feedback.style.display = 'block';
        } else {
          contractorConfirm.classList.remove('is-invalid');
          const feedback = document.getElementById('contractorConfirmFeedback');
          if (feedback) feedback.style.display = 'none';
        }
      };
      contractorPassword.addEventListener('keyup', checkContractorMatch);
      contractorConfirm.addEventListener('keyup', checkContractorMatch);
    }
  }

  setupEmployerForm() {
    const accountTypeSelect = document.getElementById('employerAccountType');
    if (accountTypeSelect) {
      accountTypeSelect.addEventListener('change', () => this.updateEmployerFields());
      this.updateEmployerFields();
    }
    document.getElementById('employerNextBtn').addEventListener('click', () => this.nextEmployerStep());
    document.getElementById('employerPrevBtn').addEventListener('click', () => this.prevEmployerStep());
    document.getElementById('employerForm').addEventListener('submit', (e) => this.submitEmployerForm(e));
  }

  updateEmployerFields() {
    const accountType = document.getElementById('employerAccountType').value;
    const dynamicFields = document.getElementById('employerDynamicFields');
    const companyFields = document.getElementById('employerCompanyFields');
    if (!dynamicFields) return;
    dynamicFields.innerHTML = '';
    if (accountType === 'individual') {
      dynamicFields.innerHTML = `
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="employerFullName" class="form-label required">Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</label>
            <input type="text" class="form-control" id="employerFullName" required>
            <div class="invalid-feedback">Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</div>
          </div>
          <div class="col-md-6 mb-3">
            <label for="employerNationalCode" class="form-label required">Ú©Ø¯ Ù…Ù„ÛŒ</label>
            <input type="text" class="form-control" id="employerNationalCode" required maxlength="10">
            <div class="invalid-feedback">Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ Ù…Ù„ÛŒ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="employerEmail" class="form-label required">Ø§ÛŒÙ…ÛŒÙ„</label>
            <input type="email" class="form-control" id="employerEmail" required>
            <div class="invalid-feedback">Ù„Ø·ÙØ§Ù‹ Ø§ÛŒÙ…ÛŒÙ„ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</div>
          </div>
          <div class="col-md-6 mb-3">
            <label for="employerPassword" class="form-label required">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
            <input type="password" class="form-control" id="employerPassword" required>
            <div class="invalid-feedback">Ù„Ø·ÙØ§Ù‹ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</div>
          </div>
          <div class="col-md-6 mb-3">
            <label for="employerConfirmPassword" class="form-label required">ØªÚ©Ø±Ø§Ø± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
            <input type="password" class="form-control" id="employerConfirmPassword" required>
            <div class="invalid-feedback" id="employerConfirmFeedback"></div>
          </div>
        </div>
      `;
      if (companyFields) companyFields.style.display = 'none';
    } else if (accountType === 'company') {
      dynamicFields.innerHTML = `
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="employerCompanyName" class="form-label required">Ù†Ø§Ù… Ø´Ø±Ú©Øª/Ù…Ø¤Ø³Ø³Ù‡</label>
            <input type="text" class="form-control" id="employerCompanyName" required>
            <div class="invalid-feedback">Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø´Ø±Ú©Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</div>
          </div>
          <div class="col-md-6 mb-3">
            <label for="employerManagerName" class="form-label required">Ù†Ø§Ù… Ù…Ø¯ÛŒØ±Ø¹Ø§Ù…Ù„</label>
            <input type="text" class="form-control" id="employerManagerName" required>
            <div class="invalid-feedback">Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ù…Ø¯ÛŒØ±Ø¹Ø§Ù…Ù„ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="employerEmail" class="form-label required">Ø§ÛŒÙ…ÛŒÙ„</label>
            <input type="email" class="form-control" id="employerEmail" required>
            <div class="invalid-feedback">Ù„Ø·ÙØ§Ù‹ Ø§ÛŒÙ…ÛŒÙ„ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</div>
          </div>
          <div class="col-md-6 mb-3">
            <label for="employerPassword" class="form-label required">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
            <input type="password" class="form-control" id="employerPassword" required>
            <div class="invalid-feedback">Ù„Ø·ÙØ§Ù‹ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</div>
          </div>
          <div class="col-md-6 mb-3">
            <label for="employerConfirmPassword" class="form-label required">ØªÚ©Ø±Ø§Ø± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
            <input type="password" class="form-control" id="employerConfirmPassword" required>
            <div class="invalid-feedback" id="employerConfirmFeedback"></div>
          </div>
        </div>
      `;
      if (companyFields) companyFields.style.display = 'block';
    }
  }

  nextEmployerStep() {
    if (this.validateEmployerStep(this.employerCurrentStep)) {
      if (this.employerCurrentStep < this.employerTotalSteps) {
        document.getElementById(`employerSection${this.employerCurrentStep}`).style.display = 'none';
        this.employerCurrentStep++;
        document.getElementById(`employerSection${this.employerCurrentStep}`).style.display = 'block';
        this.updateEmployerNavigation();
        this.updateEmployerSummary();
      }
    }
  }

  prevEmployerStep() {
    if (this.employerCurrentStep > 1) {
      document.getElementById(`employerSection${this.employerCurrentStep}`).style.display = 'none';
      this.employerCurrentStep--;
      document.getElementById(`employerSection${this.employerCurrentStep}`).style.display = 'block';
      this.updateEmployerNavigation();
    }
  }

  validateEmployerStep(step) {
    let isValid = true;
    this.clearValidationErrors();
    switch(step) {
      case 1:
        const accountType = document.getElementById('employerAccountType').value;
        const email = document.getElementById('employerEmail').value;
        const password = document.getElementById('employerPassword').value;
        const confirmPassword = document.getElementById('employerConfirmPassword').value;
        if (!accountType) {
          this.showValidationError('employerAccountType', 'Ù„Ø·ÙØ§Ù‹ Ù†ÙˆØ¹ Ø´Ø®ØµÛŒØª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
          isValid = false;
        }
        if (!email || !this.isValidEmail(email)) {
          this.showValidationError('employerEmail', 'Ù„Ø·ÙØ§Ù‹ Ø§ÛŒÙ…ÛŒÙ„ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
          isValid = false;
        }
        if (!password) {
          this.showValidationError('employerPassword', 'Ù„Ø·ÙØ§Ù‹ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
          isValid = false;
        }
        if (!confirmPassword) {
          this.showValidationError('employerConfirmPassword', 'Ù„Ø·ÙØ§Ù‹ ØªÚ©Ø±Ø§Ø± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
          isValid = false;
        }
        if (password && confirmPassword && password !== confirmPassword) {
          this.showValidationError('employerConfirmPassword', 'Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ùˆ ØªÚ©Ø±Ø§Ø± Ø¢Ù† ÛŒÚ©Ø³Ø§Ù† Ù†ÛŒØ³ØªÙ†Ø¯');
          isValid = false;
        }
        if (accountType === 'individual') {
          const fullName = document.getElementById('employerFullName')?.value;
          const nationalCode = document.getElementById('employerNationalCode')?.value;
          if (!fullName) {
            this.showValidationError('employerFullName', 'Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
            isValid = false;
          }
          if (!nationalCode || nationalCode.length !== 10) {
            this.showValidationError('employerNationalCode', 'Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ Ù…Ù„ÛŒ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
            isValid = false;
          }
        } else if (accountType === 'company') {
          const companyName = document.getElementById('employerCompanyName')?.value;
          const managerName = document.getElementById('employerManagerName')?.value;
          if (!companyName) {
            this.showValidationError('employerCompanyName', 'Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø´Ø±Ú©Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
            isValid = false;
          }
          if (!managerName) {
            this.showValidationError('employerManagerName', 'Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ù…Ø¯ÛŒØ±Ø¹Ø§Ù…Ù„ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
            isValid = false;
          }
        }
        if (!isValid) return false;
        break;
      case 2:
        const mobile = document.getElementById('employerMobile').value;
        const address = document.getElementById('employerAddress').value;
        if (!mobile || !this.isValidMobile(mobile)) {
          this.showValidationError('employerMobile', 'Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
          isValid = false;
        }
        if (!address) {
          this.showValidationError('employerAddress', 'Ù„Ø·ÙØ§Ù‹ Ø¢Ø¯Ø±Ø³ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
          isValid = false;
        }
        const accType = document.getElementById('employerAccountType').value;
        if (accType === 'company') {
          const companyId = document.getElementById('employerCompanyId')?.value;
          const registrationNo = document.getElementById('employerRegistrationNo')?.value;
          const companyType = document.getElementById('employerCompanyType')?.value;
          if (!companyId) {
            this.showValidationError('employerCompanyId', 'Ù„Ø·ÙØ§Ù‹ Ø´Ù†Ø§Ø³Ù‡ Ù…Ù„ÛŒ Ø´Ø±Ú©Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
            isValid = false;
          }
          if (!registrationNo) {
            this.showValidationError('employerRegistrationNo', 'Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ Ø«Ø¨Øª Ø´Ø±Ú©Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
            isValid = false;
          }
          if (!companyType) {
            this.showValidationError('employerCompanyType', 'Ù„Ø·ÙØ§Ù‹ Ù†ÙˆØ¹ ÙØ¹Ø§Ù„ÛŒØª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
            isValid = false;
          }
        }
        if (!isValid) return false;
        break;
      case 3:
        const projectTypes = document.querySelectorAll('input[name="projectType"]:checked');
        if (projectTypes.length === 0) {
          this.showToast('Ù„Ø·ÙØ§Ù‹ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ù†ÙˆØ¹ Ù¾Ø±ÙˆÚ˜Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯', 'error');
          isValid = false;
        }
        if (!isValid) return false;
        break;
    }
    return isValid;
  }

  updateEmployerNavigation() {
    const prevBtn = document.getElementById('employerPrevBtn');
    const nextBtn = document.getElementById('employerNextBtn');
    const submitBtn = document.getElementById('employerSubmitBtn');
    if (this.employerCurrentStep === 1) {
      prevBtn.style.display = 'none';
    } else {
      prevBtn.style.display = 'block';
    }
    if (this.employerCurrentStep === this.employerTotalSteps) {
      nextBtn.style.display = 'none';
      submitBtn.style.display = 'block';
    } else {
      nextBtn.style.display = 'block';
      submitBtn.style.display = 'none';
    }
  }

  updateEmployerSummary() {
    if (this.employerCurrentStep === 4) {
      const accountType = document.getElementById('employerAccountType').value;
      let name = '';
      let identifier = '';
      if (accountType === 'individual') {
        name = document.getElementById('employerFullName')?.value || '-';
        identifier = document.getElementById('employerNationalCode')?.value || '-';
      } else {
        name = document.getElementById('employerCompanyName')?.value || '-';
        identifier = document.getElementById('employerCompanyId')?.value || '-';
      }
      const email = document.getElementById('employerEmail')?.value || '-';
      const mobile = document.getElementById('employerMobile')?.value || '-';
      const address = document.getElementById('employerAddress')?.value || '-';
      const selectedProjects = [];
      document.querySelectorAll('input[name="projectType"]:checked').forEach(cb => {
        selectedProjects.push(cb.nextElementSibling.textContent);
      });
      const summaryHtml = `
        <div class="row">
          <div class="col-md-6">
            <p><strong>Ù†Ø§Ù…:</strong> ${name}</p>
            <p><strong>${accountType === 'individual' ? 'Ú©Ø¯ Ù…Ù„ÛŒ' : 'Ø´Ù†Ø§Ø³Ù‡ Ù…Ù„ÛŒ'}:</strong> ${identifier}</p>
            <p><strong>Ø§ÛŒÙ…ÛŒÙ„:</strong> ${email}</p>
          </div>
          <div class="col-md-6">
            <p><strong>ØªÙ„ÙÙ† Ù‡Ù…Ø±Ø§Ù‡:</strong> ${mobile}</p>
            <p><strong>Ø¢Ø¯Ø±Ø³:</strong> ${address}</p>
            <p><strong>Ù†ÙˆØ¹ Ù¾Ø±ÙˆÚ˜Ù‡:</strong> ${selectedProjects.join('ØŒ ') || '-'}</p>
          </div>
        </div>
      `;
      document.getElementById('employerSummary').innerHTML = summaryHtml;
    }
  }

  async submitEmployerForm(e) {
    e.preventDefault();
    if (!this.validateEmployerStep(this.employerCurrentStep)) {
      return;
    }
    const terms = document.getElementById('employerTerms').checked;
    if (!terms) {
      this.showToast('Ù„Ø·ÙØ§Ù‹ Ø¨Ø§ Ù‚ÙˆØ§Ù†ÛŒÙ† Ùˆ Ù…Ù‚Ø±Ø±Ø§Øª Ù…ÙˆØ§ÙÙ‚Øª Ú©Ù†ÛŒØ¯.', 'error');
      return;
    }
    const accountType = document.getElementById('employerAccountType').value;
    const email = document.getElementById('employerEmail').value;
    const password = document.getElementById('employerPassword').value;
    const mobile = document.getElementById('employerMobile').value;
    const address = document.getElementById('employerAddress').value;
    const submitBtn = document.getElementById('employerSubmitBtn');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…...';
    submitBtn.disabled = true;
    try {
      const { data: authData, error: authError } = await supabase.auth.signUp({
        email,
        password,
        options: {
          emailRedirectTo: window.location.origin + '/login',
          data: {
            user_type: 'employer',
            account_type: accountType
          }
        }
      });
      if (authError) {
        console.warn('Ø®Ø·Ø§ÛŒ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¯Ø± Auth:', authError);
        if (authError.status === 500 || authError.message.includes('confirmation email')) {
          this.showToast('Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!', 'success');
          const tempUserId = 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
          let fullName = '';
          let nationalCode = '';
          let companyName = '';
          let companyId = '';
          if (accountType === 'individual') {
            fullName = document.getElementById('employerFullName')?.value || 'Ú©Ø§Ø±Ø¨Ø±';
            nationalCode = document.getElementById('employerNationalCode')?.value || '0000000000';
          } else {
            companyName = document.getElementById('employerCompanyName')?.value || 'Ø´Ø±Ú©Øª';
            companyId = document.getElementById('employerCompanyId')?.value || '000000';
          }
          const { error: profileError } = await supabase
            .from('profiles')
            .insert([{
              user_id: tempUserId,
              email: email,
              user_type: 'employer',
              account_type: accountType,
              phone: mobile,
              address: address,
              full_name: fullName,
              national_code: nationalCode,
              company_name: companyName,
              company_id: companyId,
              created_at: new Date().toISOString(),
              terms_accepted_at: terms ? new Date().toISOString() : null,
              terms_version: '1.0'
            }]);
          if (profileError) {
            console.error('Ø®Ø·Ø§ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„:', profileError);
          }
          this.userData = {
            id: tempUserId,
            email: email,
            full_name: fullName || companyName,
            phone: mobile,
            user_type: 'employer',
            account_type: accountType,
            terms_accepted: true
          };
          this.saveUserData(this.userData);
          setTimeout(() => {
            this.showPage('home');
          }, 1500);
          return;
        } else {
          throw authError;
        }
      }
      if (!authData || !authData.user) {
        throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…');
      }
      let fullName = '';
      let nationalCode = '';
      let companyName = '';
      let companyId = '';
      if (accountType === 'individual') {
        fullName = document.getElementById('employerFullName')?.value || '';
        nationalCode = document.getElementById('employerNationalCode')?.value || '';
      } else {
        companyName = document.getElementById('employerCompanyName')?.value || '';
        companyId = document.getElementById('employerCompanyId')?.value || '';
      }
      const { data: existingProfile } = await supabase
        .from('profiles')
        .select('user_id')
        .eq('user_id', authData.user.id)
        .single();
      if (existingProfile) {
        const { error: updateError } = await supabase
          .from('profiles')
          .update({
            user_type: 'employer',
            account_type: accountType,
            phone: mobile,
            address: address,
            full_name: fullName,
            national_code: nationalCode,
            company_name: companyName,
            company_id: companyId,
            terms_accepted_at: terms ? new Date().toISOString() : null,
            terms_version: '1.0'
          })
          .eq('user_id', authData.user.id);
        if (updateError) {
          console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ø¯ÛŒØª Ù¾Ø±ÙˆÙØ§ÛŒÙ„:', updateError);
        }
      } else {
        const { error: insertError } = await supabase
          .from('profiles')
          .insert([{
            user_id: authData.user.id,
            email: email,
            user_type: 'employer',
            account_type: accountType,
            phone: mobile,
            address: address,
            full_name: fullName,
            national_code: nationalCode,
            company_name: companyName,
            company_id: companyId,
            created_at: new Date().toISOString(),
            terms_accepted_at: terms ? new Date().toISOString() : null,
            terms_version: '1.0'
          }]);
        if (insertError) {
          console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ø±ÙˆÙØ§ÛŒÙ„:', insertError);
        }
      }
      this.showToast('Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø§Ø±ÙØ±Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!', 'success');
      this.userData = {
        id: authData.user.id,
        email: email,
        full_name: fullName || companyName,
        phone: mobile,
        user_type: 'employer',
        account_type: accountType,
        terms_accepted: true
      };
      this.saveUserData(this.userData);
      setTimeout(() => {
        this.showPage('home');
      }, 1500);
    } catch (error) {
      console.error('Ø®Ø·Ø§ÛŒ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…:', error);
      this.showToast('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…: ' + error.message, 'error');
    } finally {
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;
    }
  }

  setupContractorForm() {
    this.populateYearSelect('startYear', 1350, 1403);
    const accountTypeEl = document.getElementById('accountType');
    if (accountTypeEl) {
      accountTypeEl.addEventListener('change', () => this.updateContractorFields());
    }
    const mainExpertiseEl = document.getElementById('mainExpertise');
    if (mainExpertiseEl) {
      mainExpertiseEl.addEventListener('change', () => this.updateSubExpertise());
    }
    const workAreaEl = document.getElementById('workArea');
    if (workAreaEl) {
      workAreaEl.addEventListener('change', (e) => this.handleWorkAreaSelection(e));
    }
    const radiusEl = document.getElementById('radius');
    if (radiusEl) {
      radiusEl.addEventListener('input', (e) => {
        const radiusValue = document.getElementById('radiusValue');
        if (radiusValue) {
          radiusValue.textContent = e.target.value + ' Ú©ÛŒÙ„ÙˆÙ…ØªØ±';
        }
      });
    }
    const areaUnitEl = document.getElementById('areaUnit');
    if (areaUnitEl) {
      areaUnitEl.addEventListener('change', () => this.updateAreaUnitLabel());
    }
    const docUploadAreaEl = document.getElementById('docUploadArea');
    if (docUploadAreaEl) {
      docUploadAreaEl.addEventListener('click', () => {
        const docUpload = document.getElementById('documentUpload');
        if (docUpload) docUpload.click();
      });
    }
    const docUploadEl = document.getElementById('documentUpload');
    if (docUploadEl) {
      docUploadEl.addEventListener('change', (e) => this.handleFileUpload(e));
    }
    const addProjectEl = document.getElementById('addProject');
    if (addProjectEl) {
      addProjectEl.addEventListener('click', () => this.addProject());
    }
    const insuranceEl = document.getElementById('insurance');
    if (insuranceEl) {
      insuranceEl.addEventListener('change', (e) => {
        const expiryField = document.getElementById('insuranceExpiryField');
        if (expiryField) {
          if (e.target.value === 'yes') {
            expiryField.style.display = 'block';
            expiryField.classList.add('show');
          } else {
            expiryField.style.display = 'none';
            expiryField.classList.remove('show');
          }
        }
      });
    }
    const nextBtn = document.getElementById('nextBtn');
    if (nextBtn) {
      nextBtn.addEventListener('click', () => this.nextContractorStep());
    }
    const prevBtn = document.getElementById('prevBtn');
    if (prevBtn) {
      prevBtn.addEventListener('click', () => this.prevContractorStep());
    }
    const contractorForm = document.getElementById('contractorForm');
    if (contractorForm) {
      contractorForm.addEventListener('submit', (e) => this.submitContractorForm(e));
    }
    this.updateContractorFields();
    this.updateContractorNavigation();
  }

  updateContractorFields() {
    const accountType = document.getElementById('accountType')?.value;
    const dynamicFields = document.getElementById('dynamicFields');
    if (!dynamicFields) return;
    dynamicFields.innerHTML = '';
    if (accountType === 'individual') {
      dynamicFields.innerHTML = `
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="fullName" class="form-label required">Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</label>
            <input type="text" class="form-control" id="fullName" required>
            <div class="invalid-feedback">Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</div>
          </div>
          <div class="col-md-6 mb-3">
            <label for="nationalCode" class="form-label required">Ú©Ø¯ Ù…Ù„ÛŒ</label>
            <input type="text" class="form-control" id="nationalCode" required maxlength="10">
            <div class="invalid-feedback">Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ Ù…Ù„ÛŒ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="contractorEmail" class="form-label required">Ø§ÛŒÙ…ÛŒÙ„</label>
            <input type="email" class="form-control" id="contractorEmail" required>
            <div class="invalid-feedback">Ù„Ø·ÙØ§Ù‹ Ø§ÛŒÙ…ÛŒÙ„ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</div>
          </div>
          <div class="col-md-6 mb-3">
            <label for="contractorPassword" class="form-label required">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
            <input type="password" class="form-control" id="contractorPassword" required>
            <div class="invalid-feedback">Ù„Ø·ÙØ§Ù‹ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</div>
          </div>
          <div class="col-md-6 mb-3">
            <label for="contractorConfirmPassword" class="form-label required">ØªÚ©Ø±Ø§Ø± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
            <input type="password" class="form-control" id="contractorConfirmPassword" required>
            <div class="invalid-feedback" id="contractorConfirmFeedback"></div>
          </div>
        </div>
      `;
    } else if (accountType === 'company') {
      dynamicFields.innerHTML = `
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="companyName" class="form-label required">Ù†Ø§Ù… Ø´Ø±Ú©Øª/Ù…Ø¤Ø³Ø³Ù‡</label>
            <input type="text" class="form-control" id="companyName" required>
            <div class="invalid-feedback">Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø´Ø±Ú©Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</div>
          </div>
          <div class="col-md-6 mb-3">
            <label for="companyId" class="form-label required">Ø´Ù†Ø§Ø³Ù‡ Ù…Ù„ÛŒ Ø´Ø±Ú©Øª</label>
            <input type="text" class="form-control" id="companyId" required>
            <div class="invalid-feedback">Ù„Ø·ÙØ§Ù‹ Ø´Ù†Ø§Ø³Ù‡ Ù…Ù„ÛŒ Ø´Ø±Ú©Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="contractorEmail" class="form-label required">Ø§ÛŒÙ…ÛŒÙ„</label>
            <input type="email" class="form-control" id="contractorEmail" required>
            <div class="invalid-feedback">Ù„Ø·ÙØ§Ù‹ Ø§ÛŒÙ…ÛŒÙ„ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</div>
          </div>
          <div class="col-md-6 mb-3">
            <label for="contractorPassword" class="form-label required">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
            <input type="password" class="form-control" id="contractorPassword" required>
            <div class="invalid-feedback">Ù„Ø·ÙØ§Ù‹ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</div>
          </div>
          <div class="col-md-6 mb-3">
            <label for="contractorConfirmPassword" class="form-label required">ØªÚ©Ø±Ø§Ø± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
            <input type="password" class="form-control" id="contractorConfirmPassword" required>
            <div class="invalid-feedback" id="contractorConfirmFeedback"></div>
          </div>
        </div>
      `;
    }
  }

  async submitContractorForm(e) {
    e.preventDefault();
    if (!this.validateContractorStep(this.contractorCurrentStep)) {
      return;
    }
    const terms = document.getElementById('contractorTerms')?.checked;
    if (!terms) {
      this.showToast('Ù„Ø·ÙØ§Ù‹ Ø¨Ø§ Ù‚ÙˆØ§Ù†ÛŒÙ† Ùˆ Ù…Ù‚Ø±Ø±Ø§Øª Ù…ÙˆØ§ÙÙ‚Øª Ú©Ù†ÛŒØ¯.', 'error');
      return;
    }
    const accountType = document.getElementById('accountType')?.value;
    const email = document.getElementById('contractorEmail')?.value;
    const password = document.getElementById('contractorPassword')?.value;
    const mobile = document.getElementById('mobile')?.value;
    const contactPerson = document.getElementById('contactPerson')?.value;
    const mainExpertise = document.getElementById('mainExpertise')?.value;
    const phone = document.getElementById('phone')?.value || '';
    const submitBtn = document.getElementById('submitBtn');
    if (!submitBtn) return;
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…...';
    submitBtn.disabled = true;
    try {
      const { data: authData, error: authError } = await supabase.auth.signUp({
        email,
        password,
        options: {
          emailRedirectTo: window.location.origin + '/login',
          data: {
            user_type: 'contractor',
            account_type: accountType
          }
        }
      });
      if (authError) {
        console.warn('Ø®Ø·Ø§ÛŒ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¯Ø± Auth:', authError);
        if (authError.status === 500 || authError.message.includes('confirmation email')) {
          this.showToast('Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!', 'success');
          const tempUserId = 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
          let fullName = '';
          let nationalCode = '';
          let companyName = '';
          let companyId = '';
          if (accountType === 'individual') {
            fullName = document.getElementById('fullName')?.value || 'Ú©Ø§Ø±Ø¨Ø±';
            nationalCode = document.getElementById('nationalCode')?.value || '0000000000';
          } else {
            companyName = document.getElementById('companyName')?.value || 'Ø´Ø±Ú©Øª';
            companyId = document.getElementById('companyId')?.value || '000000';
          }
          const profileData = {
            user_id: tempUserId,
            email: email,
            user_type: 'contractor',
            account_type: accountType,
            phone: mobile,
            landline: phone,
            contact_person: contactPerson,
            main_expertise: mainExpertise,
            full_name: fullName,
            national_code: nationalCode,
            company_name: companyName,
            company_id: companyId,
            verification_status: 'pending',
            trust_level: 1,
            created_at: new Date().toISOString(),
            terms_accepted_at: terms ? new Date().toISOString() : null,
            terms_version: '1.0'
          };
          const projectArea = document.getElementById('projectArea')?.value;
          const projectWeight = document.getElementById('projectWeight')?.value;
          const areaUnit = document.getElementById('areaUnit')?.value;
          if (projectArea) {
            profileData.project_area = parseInt(projectArea);
            profileData.area_unit = areaUnit;
          }
          if (projectWeight) {
            profileData.project_weight = parseInt(projectWeight);
          }
          const workAreaSelect = document.getElementById('workArea');
          if (workAreaSelect) {
            const selectedAreas = Array.from(workAreaSelect.selectedOptions).map(opt => opt.value);
            if (selectedAreas.length > 0) {
              profileData.work_area = selectedAreas;
            }
          }
          const radius = document.getElementById('radius')?.value;
          if (radius) {
            profileData.work_radius = parseInt(radius);
          }
          const subExpertiseCheckboxes = document.querySelectorAll('input[id^="subExpertise"]:checked');
          if (subExpertiseCheckboxes.length > 0) {
            const subExpertises = Array.from(subExpertiseCheckboxes).map(cb => cb.value);
            profileData.sub_expertise = subExpertises;
          }
          const startYear = document.getElementById('startYear')?.value;
          if (startYear) {
            profileData.start_year = parseInt(startYear);
          }
          const teamSize = document.getElementById('teamSize')?.value;
          if (teamSize) {
            profileData.team_size = parseInt(teamSize);
          }
          const equipment = document.getElementById('equipment')?.value;
          if (equipment) {
            profileData.equipment = equipment;
          }
          const contractMethod = document.getElementById('contractMethod')?.value;
          if (contractMethod) {
            profileData.contract_method = contractMethod;
          }
          const insurance = document.getElementById('insurance')?.value;
          if (insurance) {
            profileData.insurance = insurance;
            if (insurance === 'yes') {
              const insuranceExpiry = document.getElementById('insuranceExpiry')?.value;
              if (insuranceExpiry) {
                profileData.insurance_expiry = insuranceExpiry;
              }
            }
          }
          const { error: profileError } = await supabase
            .from('profiles')
            .insert([profileData]);
          if (profileError) {
            console.error('Ø®Ø·Ø§ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„:', profileError);
          }
          this.userData = {
            id: tempUserId,
            email: email,
            full_name: fullName || companyName,
            phone: mobile,
            user_type: 'contractor',
            account_type: accountType,
            terms_accepted: true
          };
          this.saveUserData(this.userData);
          setTimeout(() => {
            this.showPage('home');
          }, 1500);
          return;
        } else {
          throw authError;
        }
      }
      if (!authData || !authData.user) {
        throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…');
      }
      let fullName = '';
      let nationalCode = '';
      let companyName = '';
      let companyId = '';
      if (accountType === 'individual') {
        fullName = document.getElementById('fullName')?.value || '';
        nationalCode = document.getElementById('nationalCode')?.value || '';
      } else {
        companyName = document.getElementById('companyName')?.value || '';
        companyId = document.getElementById('companyId')?.value || '';
      }
      const profileData = {
        user_type: 'contractor',
        account_type: accountType,
        phone: mobile,
        landline: phone,
        contact_person: contactPerson,
        main_expertise: mainExpertise,
        full_name: fullName,
        national_code: nationalCode,
        company_name: companyName,
        company_id: companyId,
        verification_status: 'pending',
        trust_level: 1,
        terms_accepted_at: terms ? new Date().toISOString() : null,
        terms_version: '1.0'
      };
      const projectArea = document.getElementById('projectArea')?.value;
      const projectWeight = document.getElementById('projectWeight')?.value;
      const areaUnit = document.getElementById('areaUnit')?.value;
      if (projectArea) {
        profileData.project_area = parseInt(projectArea);
        profileData.area_unit = areaUnit;
      }
      if (projectWeight) {
        profileData.project_weight = parseInt(projectWeight);
      }
      const workAreaSelect = document.getElementById('workArea');
      if (workAreaSelect) {
        const selectedAreas = Array.from(workAreaSelect.selectedOptions).map(opt => opt.value);
        if (selectedAreas.length > 0) {
          profileData.work_area = selectedAreas;
        }
      }
      const radius = document.getElementById('radius')?.value;
      if (radius) {
        profileData.work_radius = parseInt(radius);
      }
      const subExpertiseCheckboxes = document.querySelectorAll('input[id^="subExpertise"]:checked');
      if (subExpertiseCheckboxes.length > 0) {
        const subExpertises = Array.from(subExpertiseCheckboxes).map(cb => cb.value);
        profileData.sub_expertise = subExpertises;
      }
      const startYear = document.getElementById('startYear')?.value;
      if (startYear) {
        profileData.start_year = parseInt(startYear);
      }
      const teamSize = document.getElementById('teamSize')?.value;
      if (teamSize) {
        profileData.team_size = parseInt(teamSize);
      }
      const equipment = document.getElementById('equipment')?.value;
      if (equipment) {
        profileData.equipment = equipment;
      }
      const contractMethod = document.getElementById('contractMethod')?.value;
      if (contractMethod) {
        profileData.contract_method = contractMethod;
      }
      const insurance = document.getElementById('insurance')?.value;
      if (insurance) {
        profileData.insurance = insurance;
        if (insurance === 'yes') {
          const insuranceExpiry = document.getElementById('insuranceExpiry')?.value;
          if (insuranceExpiry) {
            profileData.insurance_expiry = insuranceExpiry;
          }
        }
      }
      const { data: existingProfile } = await supabase
        .from('profiles')
        .select('user_id')
        .eq('user_id', authData.user.id)
        .single();
      if (existingProfile) {
        const { error: updateError } = await supabase
          .from('profiles')
          .update(profileData)
          .eq('user_id', authData.user.id);
        if (updateError) {
          console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ø¯ÛŒØª Ù¾Ø±ÙˆÙØ§ÛŒÙ„:', updateError);
        }
      } else {
        const { error: insertError } = await supabase
          .from('profiles')
          .insert([{
            user_id: authData.user.id,
            email: email,
            ...profileData,
            created_at: new Date().toISOString()
          }]);
        if (insertError) {
          console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ø±ÙˆÙØ§ÛŒÙ„:', insertError);
        }
      }
      this.showToast('Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù¾ÛŒÙ…Ø§Ù†Ú©Ø§Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!', 'success');
      this.userData = {
        id: authData.user.id,
        email: email,
        full_name: fullName || companyName,
        phone: mobile,
        user_type: 'contractor',
        account_type: accountType,
        terms_accepted: true
      };
      this.saveUserData(this.userData);
      setTimeout(() => {
        this.showPage('home');
      }, 1500);
    } catch (error) {
      console.error('Ø®Ø·Ø§ÛŒ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…:', error);
      this.showToast('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…: ' + error.message, 'error');
    } finally {
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;
    }
  }

  updateSubExpertise() {
    const mainExpertise = document.getElementById('mainExpertise')?.value;
    const subContainer = document.getElementById('subExpertiseContainer');
    if (!subContainer) return;
    const subExpertises = {
      'steel_fabrication': ['Ø³Ø§Ø®Øª Ø§Ø³Ú©Ù„Øª ÙÙ„Ø²ÛŒ ØµÙ†Ø¹ØªÛŒ', 'Ø³Ø§Ø®Øª Ø§Ø³Ú©Ù„Øª ÙÙ„Ø²ÛŒ Ø³Ø§Ø®ØªÙ…Ø§Ù†ÛŒ', 'Ø³Ø§Ø®Øª Ø³ÙˆÙ„Ù‡', 'Ø³Ø§Ø®Øª Ù¾Ø§ÛŒÙ¾Ø±Ú©'],
      'steel_installation': ['Ù†ØµØ§Ø¨ Ø³ÙˆÙ„Ù‡', 'Ù†ØµØ§Ø¨ Ø§Ø³Ú©Ù„Øª ÙÙ„Ø²ÛŒ Ø³Ø§Ø®ØªÙ…Ø§Ù†ÛŒ', 'Ù†ØµØ§Ø¨ Ø³Ø§Ø²Ù‡ Ù‡Ø§ÛŒ ØµÙ†Ø¹ØªÛŒ', 'Ù†ØµØ§Ø¨ Ù¾Ø§ÛŒÙ¾Ø±Ú©', 'Ù†ØµØ§Ø¨ Ù‡Ù†Ø¯Ø±ÛŒÙ„ Ùˆ Ù„Ø¯Ø±', 'Ù†ØµØ§Ø¨ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø³Ø¨Ú©'],
      'formwork': ['Ù‚Ø§Ù„Ø¨ Ù‡Ø§ÛŒ Ù…Ø¯ÙˆÙ„Ø§Ø±', 'Ù‚Ø§Ù„Ø¨ Ù‡Ø§ÛŒ Ø®Ø§Øµ', 'Ù‚Ø§Ù„Ø¨ ØªÙˆÙ†Ù„ÙØ±Ù…', 'Ø§Ú©ÛŒÙ¾ Ø³Ø§Ø®Øª Ù‚Ø§Ù„Ø¨ ØªÙˆÙ†Ù„ÙØ±Ù…'],
      'concrete_execution': [],
      'support_teams': ['Ø§Ú©ÛŒÙ¾ Ù†Ù‚Ø´Ù‡ Ø¨Ø±Ø¯Ø§Ø±ÛŒ', 'Ø§Ú©ÛŒÙ¾ Ú©Ù†ØªØ±Ù„ Ú©ÛŒÙÛŒØª', 'Ø§Ú©ÛŒÙ¾ Ø§ÛŒÙ…Ù†ÛŒ ØµÙ†Ø¹ØªÛŒ']
    };
    if (mainExpertise && subExpertises[mainExpertise]) {
      const subs = subExpertises[mainExpertise];
      if (subs && subs.length > 0) {
        let html = '<div class="row g-2">';
        subs.forEach((sub, index) => {
          html += `
            <div class="col-12 col-md-6">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="subExpertise${index}" value="${sub}">
                <label class="form-check-label" for="subExpertise${index}">${sub}</label>
              </div>
            </div>
          `;
        });
        html += '</div>';
        subContainer.innerHTML = html;
      } else {
        subContainer.innerHTML = '<div class="form-text">Ø§ÛŒÙ† ØªØ®ØµØµ Ø²ÛŒØ±Ø­ÙˆØ²Ù‡â€ŒØ§ÛŒ Ù†Ø¯Ø§Ø±Ø¯.</div>';
      }
    } else {
      subContainer.innerHTML = '<div class="form-text">Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø²ÛŒØ±Ø­ÙˆØ²Ù‡â€ŒÙ‡Ø§ØŒ Ø§Ø¨ØªØ¯Ø§ ØªØ®ØµØµ Ø§ØµÙ„ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</div>';
    }
  }

  updateAreaUnitLabel() {
    const areaUnit = document.getElementById('areaUnit')?.value;
    const formText = document.querySelector('.project-scale-row .form-text');
    if (formText) {
      if (areaUnit === 'sqm') {
        formText.textContent = 'Ø¨Ø±Ø§ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ÛŒ Ø³Ø§Ø®ØªÙ…Ø§Ù†ÛŒ Ùˆ Ú©Ø§Ø¨ÛŒÙ†Øª';
      } else {
        formText.textContent = 'Ø¨Ø±Ø§ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ÛŒ Ø­Ø¬Ù…ÛŒ Ùˆ Ø¨ØªÙ†ÛŒ';
      }
    }
  }

  handleWorkAreaSelection(e) {
    const select = e.target;
    const options = Array.from(select.options);
    const allOption = options.find(opt => opt.value === 'all');
    if (allOption && allOption.selected) {
      options.forEach(opt => {
        if (opt.value !== 'all') {
          opt.selected = false;
          opt.disabled = true;
        }
      });
    } else {
      if (allOption) {
        allOption.selected = false;
        allOption.disabled = true;
      }
    }
  }

  handleFileUpload(e) {
    const files = e.target.files;
    const fileList = document.getElementById('fileList');
    if (!fileList) return;
    if (files.length > 5) {
      this.showToast('Ø­Ø¯Ø§Ú©Ø«Ø± Ûµ ÙØ§ÛŒÙ„ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¢Ù¾Ù„ÙˆØ¯ Ú©Ù†ÛŒØ¯.', 'error');
      return;
    }
    fileList.innerHTML = '';
    Array.from(files).forEach((file, index) => {
      const fileItem = document.createElement('div');
      fileItem.className = 'd-flex align-items-center justify-content-between mb-2 p-2 bg-light rounded';
      fileItem.innerHTML = `
        <div>
          <i class="bi bi-file-earmark-text me-2"></i>
          <span>${file.name}</span>
          <small class="text-muted ms-2">(${(file.size / 1024).toFixed(1)} KB)</small>
        </div>
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="app.removeFile(${index})">
          <i class="bi bi-trash"></i>
        </button>
      `;
      fileList.appendChild(fileItem);
    });
    this.showAutoSaveStatus('Ù…Ø¯Ø§Ø±Ú© Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¢Ù¾Ù„ÙˆØ¯ Ø´Ø¯Ù†Ø¯.', 'success');
  }

  removeFile(index) {
    const input = document.getElementById('documentUpload');
    if (!input) return;
    const files = Array.from(input.files);
    files.splice(index, 1);
    const dt = new DataTransfer();
    files.forEach(file => dt.items.add(file));
    input.files = dt.files;
    this.handleFileUpload({ target: input });
  }

  addProject() {
    const container = document.getElementById('projectContainer');
    if (!container) return;
    const projectCount = container.children.length + 1;
    if (projectCount > 5) {
      this.showToast('Ø­Ø¯Ø§Ú©Ø«Ø± Ûµ Ù¾Ø±ÙˆÚ˜Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯.', 'error');
      return;
    }
    const projectDiv = document.createElement('div');
    projectDiv.className = 'card mb-3 project-card';
    projectDiv.innerHTML = `
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h6 class="card-title mb-0">Ù¾Ø±ÙˆÚ˜Ù‡ Ù†Ù…ÙˆÙ†Ù‡ ${projectCount}</h6>
          <button type="button" class="btn btn-sm btn-outline-danger" onclick="app.removeProject(this)">
            <i class="bi bi-trash"></i>
          </button>
        </div>
        <div class="row">
          <div class="col-md-4 mb-3">
            <label class="form-label">Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡</label>
            <input type="text" class="form-control" name="projectName[]">
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Ø³Ø§Ù„ ØªØ­ÙˆÛŒÙ„ (Ø´Ù…Ø³ÛŒ)</label>
            <select class="form-select" name="projectYear[]">
              <option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ Ø³Ø§Ù„ --</option>
            </select>
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Ù…Ø´ØªØ±ÛŒ</label>
            <input type="text" class="form-control" name="projectClient[]" placeholder="Ù†Ø§Ù… Ø´Ø±Ú©Øª ÛŒØ§ Ø´Ø®Øµ">
          </div>
          <div class="col-12 mb-3">
            <label class="form-label">ØªØµÙˆÛŒØ± Ù¾Ø±ÙˆÚ˜Ù‡ (Ø­Ø¯Ø§Ú©Ø«Ø± Û± ØªØµÙˆÛŒØ±)</label>
            <input type="file" class="form-control" name="projectImage[]" accept="image/*">
          </div>
        </div>
      </div>
    `;
    container.appendChild(projectDiv);
    const yearSelect = projectDiv.querySelector('select[name="projectYear[]"]');
    if (yearSelect) {
      this.populateProjectYearSelect(yearSelect);
    }
    this.showAutoSaveStatus('Ù¾Ø±ÙˆÚ˜Ù‡ Ø¬Ø¯ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.', 'success');
  }

  removeProject(button) {
    const projectCard = button.closest('.project-card');
    const container = document.getElementById('projectContainer');
    if (!container) return;
    if (container.children.length > 1) {
      if (projectCard) projectCard.remove();
      this.showAutoSaveStatus('Ù¾Ø±ÙˆÚ˜Ù‡ Ø­Ø°Ù Ø´Ø¯.', 'success');
    } else {
      this.showToast('Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ù¾Ø±ÙˆÚ˜Ù‡ Ø¨Ø§ÛŒØ¯ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯.', 'error');
    }
  }

  nextContractorStep() {
    if (this.validateContractorStep(this.contractorCurrentStep)) {
      if (this.contractorCurrentStep < this.contractorTotalSteps) {
        document.getElementById(`section${this.contractorCurrentStep}`).style.display = 'none';
        this.contractorCurrentStep++;
        document.getElementById(`section${this.contractorCurrentStep}`).style.display = 'block';
        this.updateProgressBar();
        this.updateStepIndicator();
        this.updateContractorNavigation();
        if (this.contractorCurrentStep === this.contractorTotalSteps) {
          this.updateContractorSummary();
        }
      }
    }
  }

  prevContractorStep() {
    if (this.contractorCurrentStep > 1) {
      document.getElementById(`section${this.contractorCurrentStep}`).style.display = 'none';
      this.contractorCurrentStep--;
      document.getElementById(`section${this.contractorCurrentStep}`).style.display = 'block';
      this.updateProgressBar();
      this.updateStepIndicator();
      this.updateContractorNavigation();
    }
  }

  validateContractorStep(step) {
    let isValid = true;
    this.clearValidationErrors();
    switch(step) {
      case 1:
        const accountType = document.getElementById('accountType')?.value;
        const contactPerson = document.getElementById('contactPerson')?.value;
        const mobile = document.getElementById('mobile')?.value;
        const email = document.getElementById('contractorEmail')?.value;
        const password = document.getElementById('contractorPassword')?.value;
        const confirmPassword = document.getElementById('contractorConfirmPassword')?.value;
        if (!accountType) {
          this.showValidationError('accountType', 'Ù„Ø·ÙØ§Ù‹ Ù†ÙˆØ¹ Ø´Ø®ØµÛŒØª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
          isValid = false;
        }
        if (!contactPerson) {
          this.showValidationError('contactPerson', 'Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ù…Ø³Ø¦ÙˆÙ„ Ø§Ø±ØªØ¨Ø§Ø· Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
          isValid = false;
        }
        if (!mobile || !this.isValidMobile(mobile)) {
          this.showValidationError('mobile', 'Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
          isValid = false;
        }
        if (!email || !this.isValidEmail(email)) {
          this.showValidationError('contractorEmail', 'Ù„Ø·ÙØ§Ù‹ Ø§ÛŒÙ…ÛŒÙ„ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
          isValid = false;
        }
        if (!password) {
          this.showValidationError('contractorPassword', 'Ù„Ø·ÙØ§Ù‹ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
          isValid = false;
        }
        if (!confirmPassword) {
          this.showValidationError('contractorConfirmPassword', 'Ù„Ø·ÙØ§Ù‹ ØªÚ©Ø±Ø§Ø± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
          isValid = false;
        }
        if (password && confirmPassword && password !== confirmPassword) {
          this.showValidationError('contractorConfirmPassword', 'Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ùˆ ØªÚ©Ø±Ø§Ø± Ø¢Ù† ÛŒÚ©Ø³Ø§Ù† Ù†ÛŒØ³ØªÙ†Ø¯');
          isValid = false;
        }
        if (accountType === 'individual') {
          const fullName = document.getElementById('fullName')?.value;
          const nationalCode = document.getElementById('nationalCode')?.value;
          if (!fullName) {
            this.showValidationError('fullName', 'Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
            isValid = false;
          }
          if (!nationalCode || nationalCode.length !== 10) {
            this.showValidationError('nationalCode', 'Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ Ù…Ù„ÛŒ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
            isValid = false;
          }
        } else if (accountType === 'company') {
          const companyName = document.getElementById('companyName')?.value;
          const companyId = document.getElementById('companyId')?.value;
          if (!companyName) {
            this.showValidationError('companyName', 'Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø´Ø±Ú©Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
            isValid = false;
          }
          if (!companyId) {
            this.showValidationError('companyId', 'Ù„Ø·ÙØ§Ù‹ Ø´Ù†Ø§Ø³Ù‡ Ù…Ù„ÛŒ Ø´Ø±Ú©Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
            isValid = false;
          }
        }
        if (!isValid) return false;
        break;
      case 2:
        const mainExpertise = document.getElementById('mainExpertise')?.value;
        const workArea = document.getElementById('workArea');
        const selectedAreas = workArea ? Array.from(workArea.selectedOptions).map(opt => opt.value) : [];
        if (!mainExpertise) {
          this.showValidationError('mainExpertise', 'Ù„Ø·ÙØ§Ù‹ ØªØ®ØµØµ Ø§ØµÙ„ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
          isValid = false;
        }
        if (selectedAreas.length === 0) {
          this.showToast('Ù„Ø·ÙØ§Ù‹ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ù…Ø­Ø¯ÙˆØ¯Ù‡ Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯', 'error');
          isValid = false;
        }
        const projectArea = document.getElementById('projectArea')?.value;
        const projectWeight = document.getElementById('projectWeight')?.value;
        if (!projectArea && !projectWeight) {
          this.showToast('Ù„Ø·ÙØ§Ù‹ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ©ÛŒ Ø§Ø² ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ù…ØªØ±Ø§Ú˜ ÛŒØ§ ÙˆØ²Ù† Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯', 'error');
          isValid = false;
        }
        if (!isValid) return false;
        break;
      case 3:
        const startYear = document.getElementById('startYear')?.value;
        if (!startYear) {
          this.showValidationError('startYear', 'Ù„Ø·ÙØ§Ù‹ Ø³Ø§Ù„ Ø¢ØºØ§Ø² ÙØ¹Ø§Ù„ÛŒØª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
          isValid = false;
        }
        if (!isValid) return false;
        break;
      case 4:
        const projectCount = document.querySelectorAll('.project-card').length;
        if (projectCount < 2) {
          this.showToast('Ù„Ø·ÙØ§Ù‹ Ø­Ø¯Ø§Ù‚Ù„ Û² Ù¾Ø±ÙˆÚ˜Ù‡ Ù†Ù…ÙˆÙ†Ù‡ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
          isValid = false;
        }
        if (!isValid) return false;
        break;
    }
    return isValid;
  }

  updateProgressBar() {
    const progress = (this.contractorCurrentStep / this.contractorTotalSteps) * 100;
    const progressBar = document.getElementById('progressBarFill');
    if (progressBar) {
      progressBar.style.width = progress + '%';
      progressBar.setAttribute('aria-valuenow', progress);
    }
  }

  updateStepIndicator() {
    for (let i = 1; i <= this.contractorTotalSteps; i++) {
      const step = document.getElementById(`step${i}`);
      if (step) {
        if (i <= this.contractorCurrentStep) {
          step.classList.add('active');
        } else {
          step.classList.remove('active');
        }
      }
    }
  }

  updateContractorNavigation() {
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const submitBtn = document.getElementById('submitBtn');
    if (prevBtn) {
      if (this.contractorCurrentStep === 1) {
        prevBtn.style.display = 'none';
      } else {
        prevBtn.style.display = 'block';
      }
    }
    if (nextBtn && submitBtn) {
      if (this.contractorCurrentStep === this.contractorTotalSteps) {
        nextBtn.style.display = 'none';
        submitBtn.style.display = 'block';
      } else {
        nextBtn.style.display = 'block';
        submitBtn.style.display = 'none';
      }
    }
  }

  updateContractorSummary() {
    const accountType = document.getElementById('accountType')?.value;
    let name = '';
    if (accountType === 'individual') {
      name = document.getElementById('fullName')?.value || '-';
    } else {
      name = document.getElementById('companyName')?.value || '-';
    }
    const contactPerson = document.getElementById('contactPerson')?.value || '-';
    const mainExpertiseSelect = document.getElementById('mainExpertise');
    const mainExpertise = mainExpertiseSelect && mainExpertiseSelect.selectedIndex >= 0 
      ? mainExpertiseSelect.options[mainExpertiseSelect.selectedIndex]?.text || '-' 
      : '-';
    const startYear = document.getElementById('startYear')?.value || '-';
    const teamSize = document.getElementById('teamSize')?.value || '-';
    const workAreaSelect = document.getElementById('workArea');
    const selectedAreas = workAreaSelect ? Array.from(workAreaSelect.selectedOptions).map(opt => opt.text) : [];
    const workAreas = selectedAreas.length > 0 ? selectedAreas.join('ØŒ ') : '-';
    const areaValue = document.getElementById('projectArea')?.value || '-';
    const areaUnit = document.getElementById('areaUnit')?.value === 'sqm' ? 'Ù…ØªØ± Ù…Ø±Ø¨Ø¹' : 'Ù…ØªØ± Ù…Ú©Ø¹Ø¨';
    const weightValue = document.getElementById('projectWeight')?.value || '-';
    const summaryHtml = `
      <div class="row">
        <div class="col-md-6">
          <p><strong>Ù†Ø§Ù… ${accountType === 'individual' ? 'Ù¾ÛŒÙ…Ø§Ù†Ú©Ø§Ø±' : 'Ø´Ø±Ú©Øª'}:</strong> ${name}</p>
          <p><strong>Ù…Ø³Ø¦ÙˆÙ„ Ø§Ø±ØªØ¨Ø§Ø·:</strong> ${contactPerson}</p>
          <p><strong>ØªØ®ØµØµ Ø§ØµÙ„ÛŒ:</strong> ${mainExpertise}</p>
          <p><strong>Ø³Ø§Ù„ Ø´Ø±ÙˆØ¹ ÙØ¹Ø§Ù„ÛŒØª:</strong> ${startYear}</p>
        </div>
        <div class="col-md-6">
          <p><strong>ØªØ¹Ø¯Ø§Ø¯ Ù†ÛŒØ±Ùˆ:</strong> ${teamSize} Ù†ÙØ±</p>
          <p><strong>Ù…Ø­Ø¯ÙˆØ¯Ù‡ ÙØ¹Ø§Ù„ÛŒØª:</strong> ${workAreas}</p>
          <p><strong>Ù…Ù‚ÛŒØ§Ø³ Ù¾Ø±ÙˆÚ˜Ù‡:</strong> ${areaValue !== '-' ? areaValue + ' ' + areaUnit + ' Ø¯Ø± Ù…Ø§Ù‡' : ''} ${weightValue !== '-' ? weightValue + ' ØªÙ† Ø¯Ø± Ù…Ø§Ù‡' : ''}</p>
          <p><strong>Ù†ÙˆØ¹ Ø´Ø®ØµÛŒØª:</strong> ${accountType === 'individual' ? 'Ø´Ø®Øµ Ø­Ù‚ÛŒÙ‚ÛŒ' : 'Ø´Ø±Ú©Øª'}</p>
        </div>
      </div>
    `;
    const summaryContent = document.getElementById('summaryContent');
    if (summaryContent) {
      summaryContent.innerHTML = summaryHtml;
    }
    const formSummary = document.getElementById('formSummary');
    if (formSummary) {
      formSummary.style.display = 'block';
    }
  }

  showEmployerRegistration() {
    this.showPage('employerRegistration');
    this.employerCurrentStep = 1;
    document.querySelectorAll('#employerRegistration .form-section').forEach((section, index) => {
      if (index === 0) {
        section.style.display = 'block';
      } else {
        section.style.display = 'none';
      }
    });
    this.updateEmployerNavigation();
    const employerForm = document.getElementById('employerForm');
    if (employerForm) employerForm.reset();
    this.updateEmployerFields();
    this.clearValidationErrors();
  }

  showContractorRegistration() {
    this.showPage('contractorRegistration');
    this.contractorCurrentStep = 1;
    document.querySelectorAll('#contractorRegistration .form-section').forEach((section, index) => {
      if (index === 0) {
        section.style.display = 'block';
      } else {
        section.style.display = 'none';
      }
    });
    this.updateProgressBar();
    this.updateStepIndicator();
    this.updateContractorNavigation();
    const contractorForm = document.getElementById('contractorForm');
    if (contractorForm) contractorForm.reset();
    this.updateContractorFields();
    this.clearValidationErrors();
    const fileList = document.getElementById('fileList');
    if (fileList) fileList.innerHTML = '';
    const projectContainer = document.getElementById('projectContainer');
    if (projectContainer) {
      projectContainer.innerHTML = `
        <div class="card mb-3 project-card">
          <div class="card-body">
            <h6 class="card-title">Ù¾Ø±ÙˆÚ˜Ù‡ Ù†Ù…ÙˆÙ†Ù‡ Û±</h6>
            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label">Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡</label>
                <input type="text" class="form-control" name="projectName[]">
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Ø³Ø§Ù„ ØªØ­ÙˆÛŒÙ„ (Ø´Ù…Ø³ÛŒ)</label>
                <select class="form-select" name="projectYear[]">
                  <option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ Ø³Ø§Ù„ --</option>
                </select>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Ù…Ø´ØªØ±ÛŒ</label>
                <input type="text" class="form-control" name="projectClient[]" placeholder="Ù†Ø§Ù… Ø´Ø±Ú©Øª ÛŒØ§ Ø´Ø®Øµ">
              </div>
              <div class="col-12 mb-3">
                <label class="form-label">ØªØµÙˆÛŒØ± Ù¾Ø±ÙˆÚ˜Ù‡ (Ø­Ø¯Ø§Ú©Ø«Ø± Û± ØªØµÙˆÛŒØ±)</label>
                <input type="file" class="form-control" name="projectImage[]" accept="image/*">
              </div>
            </div>
          </div>
        </div>
      `;
      const firstYearSelect = document.querySelector('#projectContainer select[name="projectYear[]"]');
      if (firstYearSelect) {
        this.populateProjectYearSelect(firstYearSelect);
      }
    }
    const workArea = document.getElementById('workArea');
    if (workArea) {
      Array.from(workArea.options).forEach(opt => {
        opt.disabled = false;
        opt.selected = false;
      });
    }
    const formSummary = document.getElementById('formSummary');
    if (formSummary) {
      formSummary.style.display = 'none';
    }
    localStorage.removeItem('contractor_form_temp');
  }

  populateYearSelect(selectId, startYear, endYear) {
    let selectElement;
    if (typeof selectId === 'string') {
      selectElement = document.getElementById(selectId);
    } else {
      selectElement = selectId;
    }
    if (!selectElement) return;
    while (selectElement.options.length > 1) {
      selectElement.remove(1);
    }
    for (let year = endYear; year >= startYear; year--) {
      const option = document.createElement('option');
      option.value = year;
      option.text = year;
      selectElement.appendChild(option);
    }
  }

  populateProjectYearSelect(selectElement) {
    if (!selectElement) return;
    while (selectElement.options.length > 1) {
      selectElement.remove(1);
    }
    for (let year = 1403; year >= 1380; year--) {
      const option = document.createElement('option');
      option.value = year;
      option.text = year;
      selectElement.appendChild(option);
    }
  }

  showAutoSaveStatus(message, type = 'success') {
    const statusElement = document.getElementById('autoSaveStatus');
    if (statusElement) {
      statusElement.textContent = 'âœ“ ' + message;
      statusElement.className = `auto-save-status ${type}`;
      setTimeout(() => {
        statusElement.textContent = '';
        statusElement.className = 'auto-save-status';
      }, 3000);
    }
  }

  showValidationError(fieldId, message) {
    const field = document.getElementById(fieldId);
    if (field) {
      field.classList.add('is-invalid');
      let feedback = field.nextElementSibling;
      while (feedback && !feedback.classList.contains('invalid-feedback')) {
        feedback = feedback.nextElementSibling;
      }
      if (!feedback || !feedback.classList.contains('invalid-feedback')) {
        feedback = document.createElement('div');
        feedback.className = 'invalid-feedback';
        field.parentNode.appendChild(feedback);
      }
      feedback.textContent = message;
      feedback.style.display = 'block';
      field.scrollIntoView({ behavior: 'smooth', block: 'center' });
    } else {
      this.showToast(message, 'error');
    }
  }

  clearValidationErrors() {
    document.querySelectorAll('.is-invalid').forEach(field => {
      field.classList.remove('is-invalid');
    });
    document.querySelectorAll('.invalid-feedback').forEach(feedback => {
      feedback.style.display = 'none';
    });
  }

  setupValidation() {
    const emailInputs = document.querySelectorAll('input[type="email"]');
    emailInputs.forEach(input => {
      input.addEventListener('blur', () => {
        if (input.value && !this.isValidEmail(input.value)) {
          this.showValidationError(input.id, 'Ù„Ø·ÙØ§Ù‹ Ø§ÛŒÙ…ÛŒÙ„ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
        }
      });
    });
    const mobileInputs = document.querySelectorAll('input[type="tel"][pattern]');
    mobileInputs.forEach(input => {
      input.addEventListener('blur', () => {
        if (input.value && !this.isValidMobile(input.value)) {
          this.showValidationError(input.id, 'Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
        }
      });
    });
  }

  isValidEmail(email) {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email);
  }

  isValidMobile(mobile) {
    const re = /^09[0-9]{9}$/;
    return re.test(mobile);
  }

  sanitizeHTML(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  performSearch() {
    const keyword = document.getElementById('searchKeyword')?.value || '';
    const specialty = document.getElementById('searchSpecialty')?.value || '';
    const locationSelect = document.getElementById('searchLocation');
    const selectedLocations = locationSelect ? Array.from(locationSelect.selectedOptions).map(opt => opt.value) : [];
    const experience = document.getElementById('searchExperience')?.value || '';
    const results = [
      { id: 1, name: 'Ø´Ø±Ú©Øª Ø³Ø§Ø²Ù‡â€ŒÚ¯Ø³ØªØ±', location: ['tehran', 'alborz'], specialty: 'steel_fabrication', rating: 4.5, reviews: 12, experience: 15, verified: true },
      { id: 2, name: 'Ø¨ØªÙ†â€ŒÚ©Ø§Ø±Ø§Ù† Ø¨Ø±ØªØ±', location: ['esfahan', 'tehran'], specialty: 'concrete_execution', rating: 4.2, reviews: 8, experience: 8, verified: true },
      { id: 3, name: 'Ø¬ÙˆØ´Ú©Ø§Ø±Ø§Ù† Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ', location: ['razavi-khorasan'], specialty: 'welding', rating: 4.7, reviews: 15, experience: 12, verified: true },
      { id: 4, name: 'Ø§Ø³Ú©Ù„Øªâ€ŒØ³Ø§Ø²Ø§Ù† Ù†ÙˆÛŒÙ†', location: ['alborz'], specialty: 'steel_installation', rating: 4.8, reviews: 20, experience: 18, verified: true },
      { id: 5, name: 'Ø®Ø§Ú©Ø¨Ø±Ø¯Ø§Ø±ÛŒ Ø§ÛŒÙ…Ù†', location: ['tehran', 'alborz'], specialty: 'excavation', rating: 4.3, reviews: 6, experience: 10, verified: true },
      { id: 6, name: 'Ø±Ù†Ú¯â€ŒØ¢Ù…ÛŒØ² ØµÙ†Ø¹Øª', location: ['esfahan', 'fars'], specialty: 'coating', rating: 4.6, reviews: 9, experience: 7, verified: true },
      { id: 7, name: 'Ø¢Ø¨â€ŒØ¨Ù†Ø¯ÛŒ Ù¾Ø§Ø±Ø³', location: ['khuzestan', 'fars'], specialty: 'waterproofing', rating: 4.4, reviews: 11, experience: 9, verified: true },
      { id: 8, name: 'Ù…Ù‚Ø§ÙˆÙ…â€ŒØ³Ø§Ø²Ø§Ù†', location: ['tehran'], specialty: 'seismic_retrofit', rating: 4.9, reviews: 18, experience: 20, verified: true }
    ];
    const filteredResults = results.filter(result => {
      if (keyword && !result.name.includes(keyword) && !result.specialty.includes(keyword)) return false;
      if (specialty && result.specialty !== specialty) return false;
      if (selectedLocations.length > 0 && !selectedLocations.includes('all')) {
        const hasLocation = result.location.some(loc => selectedLocations.includes(loc));
        if (!hasLocation) return false;
      }
      if (experience && result.experience < parseInt(experience)) return false;
      return true;
    });
    this.displaySearchResults(filteredResults);
  }

  displaySearchResults(results) {
    const container = document.getElementById('searchResults');
    if (!container) return;
    if (results.length === 0) {
      container.innerHTML = `
        <div class="col-12">
          <div class="card-peymanyar text-center py-5">
            <i class="bi bi-search display-4 text-muted mb-3"></i>
            <h4>Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</h4>
            <p class="text-muted">Ù„Ø·ÙØ§Ù‹ ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ø¬Ø³ØªØ¬Ùˆ Ø±Ø§ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯.</p>
          </div>
        </div>
      `;
      return;
    }
    container.innerHTML = results.map(result => `
      <div class="col-lg-4 col-md-6 mb-4">
        <div class="card-peymanyar h-100">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <h5 class="mb-1">${result.name}</h5>
              <p class="text-muted mb-1"><i class="bi bi-geo-alt me-1"></i>${result.location}</p>
              <p class="text-muted mb-1"><i class="bi bi-clock-history me-1"></i>${result.experience} Ø³Ø§Ù„ Ø³Ø§Ø¨Ù‚Ù‡</p>
            </div>
            ${result.verified ? '<span class="badge bg-success">ØªØ£ÛŒÛŒØ¯ Ø´Ø¯Ù‡</span>' : ''}
          </div>
          <div class="mb-3">
            ${this.generateStars(result.rating)}
            <span class="text-muted ms-2">${result.rating} (${result.reviews} Ù†Ø¸Ø±)</span>
          </div>
          <p class="text-muted mb-3">ØªØ®ØµØµ: ${result.specialty}</p>
          <div class="d-flex justify-content-between">
            <button class="btn btn-sm btn-outline-primary" onclick="app.viewContractorProfile(${result.id})">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„</button>
            <button class="btn btn-sm btn-primary" onclick="app.contactContractor(${result.id})">Ø§Ø±ØªØ¨Ø§Ø·</button>
          </div>
        </div>
      </div>
    `).join('');
  }

  generateStars(rating) {
    let stars = '';
    const fullStars = Math.floor(rating);
    const hasHalfStar = rating % 1 >= 0.5;
    for (let i = 0; i < fullStars; i++) stars += '<i class="bi bi-star-fill text-warning"></i>';
    if (hasHalfStar) stars += '<i class="bi bi-star-half text-warning"></i>';
    const remaining = 5 - fullStars - (hasHalfStar ? 1 : 0);
    for (let i = 0; i < remaining; i++) stars += '<i class="bi bi-star text-warning"></i>';
    return stars;
  }

  viewContractorProfile(id) {
    this.showToast(`Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù¾ÛŒÙ…Ø§Ù†Ú©Ø§Ø± ${id} Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...`, 'info');
  }

  contactContractor(id) {
    this.showToast(`Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù¾ÛŒÙ…Ø§Ù†Ú©Ø§Ø± ${id} Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´Ø¯`, 'success');
  }

  animateCounters() {
    const counters = document.querySelectorAll('.stat-value[data-count]');
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const counter = entry.target;
          const target = parseInt(counter.getAttribute('data-count') || '0');
          this.animateCounter(counter, target);
          observer.unobserve(counter);
        }
      });
    }, { threshold: 0.5 });
    counters.forEach(counter => observer.observe(counter));
  }

  animateCounter(element, target) {
    let count = 0;
    const increment = target / 50;
    const step = () => {
      if (count < target) {
        count += increment;
        element.textContent = Math.ceil(count).toLocaleString('fa-IR');
        requestAnimationFrame(step);
      } else {
        element.textContent = target.toLocaleString('fa-IR') + (element.getAttribute('data-count') === '98' ? 'Ùª' : '');
      }
    };
    requestAnimationFrame(step);
  }

  createNewProject() {
    this.showToast('Ø§ÛŒÙ† Ù‚Ø§Ø¨Ù„ÛŒØª Ø¯Ø± Ù†Ø³Ø®Ù‡ Ú©Ø§Ù…Ù„ Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯', 'info');
  }

  async logout() {
    await supabase.auth.signOut();
    this.userData = null;
    this.showPage('home');
    this.showToast('Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø®Ø§Ø±Ø¬ Ø´Ø¯ÛŒØ¯', 'success');
  }

  async loadProjects() {
    const statusFilter = document.getElementById('projectFilterStatus')?.value || 'all';
    const searchTerm = document.getElementById('projectSearch')?.value || '';
    try {
      let query = supabase
        .from('projects')
        .select('*')
        .eq('admin_approved', true)
        .order('created_at', { ascending: false });
      if (statusFilter !== 'all') {
        query = query.eq('status', statusFilter);
      }
      if (searchTerm) {
        query = query.or(`title.ilike.%${searchTerm}%,description.ilike.%${searchTerm}%`);
      }
      const { data: projects, error } = await query;
      if (error) {
        console.error('Ø®Ø·Ø§:', error);
        this.showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§', 'error');
        return;
      }
      const projectsWithEmployer = await Promise.all((projects || []).map(async (project) => {
        const { data: employer } = await supabase
          .from('profiles')
          .select('full_name, company_name')
          .eq('user_id', project.employer_id)
          .single();
        return {
          ...project,
          employer: employer || null
        };
      }));
      this.displayProjects(projectsWithEmployer);
    } catch (error) {
      console.error('Ø®Ø·Ø§:', error);
      this.showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§', 'error');
    }
  }

  displayProjects(projects) {
    const container = document.getElementById('projectsList');
    if (!container) {
      console.error('Ø§Ù„Ù…Ø§Ù† Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯!');
      return;
    }
    if (!projects || projects.length === 0) {
      container.innerHTML = `
        <div class="col-12">
          <div class="card-peymanyar text-center py-5">
            <i class="bi bi-folder-x display-4 text-muted mb-3"></i>
            <h4>Ù¾Ø±ÙˆÚ˜Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</h4>
            <p class="text-muted">Ù‡Ù†ÙˆØ² Ù¾Ø±ÙˆÚ˜Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>
          </div>
        </div>
      `;
      return;
    }
    let html = '';
    projects.forEach(project => {
      const statusClass = {
        'open': 'bg-success',
        'in_progress': 'bg-primary',
        'completed': 'bg-secondary',
        'cancelled': 'bg-danger'
      }[project.status] || 'bg-secondary';
      const statusText = {
        'open': 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ù¾ÛŒÙ…Ø§Ù†Ú©Ø§Ø±',
        'in_progress': 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…',
        'completed': 'ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡',
        'cancelled': 'Ù„ØºÙˆ Ø´Ø¯Ù‡'
      }[project.status] || project.status;
      const employerName = project.employer?.full_name || project.employer?.company_name || 'Ù†Ø§Ù…Ø´Ø®Øµ';
      html += `
        <div class="col-md-6 mb-4">
          <div class="card-peymanyar h-100">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <h5>${project.title}</h5>
              <span class="badge ${statusClass}">${statusText}</span>
            </div>
            <p>${project.description || 'Ø¨Ø¯ÙˆÙ† ØªÙˆØ¶ÛŒØ­Ø§Øª'}</p>
            <p class="small"><i class="bi bi-person me-1"></i>Ú©Ø§Ø±ÙØ±Ù…Ø§: ${employerName}</p>
            <div class="d-flex justify-content-between align-items-center mt-2">
              <small class="text-muted">${new Date(project.created_at).toLocaleDateString('fa-IR')}</small>
              <button class="btn btn-sm btn-outline-primary" onclick="app.viewProject(${project.id})">
                <i class="bi bi-eye me-1"></i>Ø¬Ø²Ø¦ÛŒØ§Øª
              </button>
            </div>
          </div>
        </div>
      `;
    });
    container.innerHTML = html;
  }

  viewProject(projectId) {
    this.showToast(`Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡ ${projectId}`, 'info');
  }

  showNewProjectModal() {
    if (!this.userData) {
      this.showToast('Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ù¾Ø±ÙˆÚ˜Ù‡ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯', 'error');
      this.showPage('login');
      return;
    }
    if (this.userData.user_type !== 'employer') {
      this.showToast('ÙÙ‚Ø· Ú©Ø§Ø±ÙØ±Ù…Ø§ÛŒØ§Ù† Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù†Ø¯ Ù¾Ø±ÙˆÚ˜Ù‡ Ø«Ø¨Øª Ú©Ù†Ù†Ø¯', 'error');
      return;
    }
    const modalElement = document.getElementById('newProjectModal');
    if (!modalElement) {
      this.showToast('Ø®Ø·Ø§: Ù…ÙˆØ¯Ø§Ù„ Ù¾Ø±ÙˆÚ˜Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯', 'error');
      return;
    }
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
  }

  async createProject() {
    const title = document.getElementById('projectTitle')?.value;
    const description = document.getElementById('projectDescription')?.value;
    const category = document.getElementById('projectCategory')?.value;
    const budget = document.getElementById('projectBudget')?.value;
    const location = document.getElementById('projectLocation')?.value;
    const timeline = document.getElementById('projectTimeline')?.value;
    if (!title || !description) {
      this.showToast('Ù„Ø·ÙØ§Ù‹ Ø¹Ù†ÙˆØ§Ù† Ùˆ ØªÙˆØ¶ÛŒØ­Ø§Øª Ù¾Ø±ÙˆÚ˜Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
      return;
    }
    if (!this.userData) {
      this.showToast('Ù„Ø·ÙØ§Ù‹ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯', 'error');
      return;
    }
    const projectData = {
      title,
      description,
      employer_id: this.userData.id,
      category: category || null,
      budget_range: budget || null,
      location: location || null,
      timeline: timeline || null,
      status: 'pending',
      admin_approved: false
    };
    const { data, error } = await supabase
      .from('projects')
      .insert([projectData])
      .select();
    if (error) {
      console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ø±ÙˆÚ˜Ù‡:', error);
      this.showToast('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ø±ÙˆÚ˜Ù‡: ' + error.message, 'error');
      return;
    }
    this.showToast('Ù¾Ø±ÙˆÚ˜Ù‡ Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ùˆ Ø¨Ø±Ø§ÛŒ ØªØ§ÛŒÛŒØ¯ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯', 'success');
    const modal = bootstrap.Modal.getInstance(document.getElementById('newProjectModal'));
    if (modal) modal.hide();
    const newProjectForm = document.getElementById('newProjectForm');
    if (newProjectForm) newProjectForm.reset();
  }

  saveUserData(data) {
    this.userData = data;
    localStorage.setItem('peymanyar_user', JSON.stringify(data));
    console.log('User data saved:', data);
  }

  loadUserData() {
    const saved = localStorage.getItem('peymanyar_user');
    if (saved) {
      try {
        this.userData = JSON.parse(saved);
        console.log('User data loaded:', this.userData);
      } catch (e) {
        console.error('Ø®Ø·Ø§ Ø¯Ø± Ù„ÙˆØ¯ user data:', e);
        this.userData = null;
        localStorage.removeItem('peymanyar_user');
      }
    } else {
      console.log('No user data found in localStorage');
      this.userData = null;
    }
  }

  setupIntersectionObserver() {
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('animate__animated', 'animate__fadeInUp');
        }
      });
    }, { threshold: 0.1 });
    document.querySelectorAll('.card-peymanyar').forEach(card => {
      observer.observe(card);
    });
  }

  setupFocusTrap() {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
      modal.addEventListener('keydown', (e) => {
        if (e.key === 'Tab') {
          const focusableElements = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
          const firstElement = focusableElements[0];
          const lastElement = focusableElements[focusableElements.length - 1];
          if (e.shiftKey) {
            if (document.activeElement === firstElement) {
              lastElement.focus();
              e.preventDefault();
            }
          } else {
            if (document.activeElement === lastElement) {
              firstElement.focus();
              e.preventDefault();
            }
          }
        }
      });
    });
  }

  addSkipToContentLink() {
    const skipLink = document.createElement('a');
    skipLink.href = '#main-content';
    skipLink.className = 'skip-to-content';
    skipLink.textContent = 'Ù¾Ø±Ø´ Ø¨Ù‡ Ù…Ø­ØªÙˆØ§ÛŒ Ø§ØµÙ„ÛŒ';
    skipLink.style.cssText = 'position: absolute; top: -40px; right: 0; background: var(--primary-color); color: white; padding: 8px 16px; text-decoration: none; z-index: 9999;';
    skipLink.addEventListener('focus', () => { skipLink.style.top = '0'; });
    skipLink.addEventListener('blur', () => { skipLink.style.top = '-40px'; });
    document.body.prepend(skipLink);
  }

  setupAssistantEvents() {
    const input = document.getElementById('assistantInput');
    if (input) {
      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') this.sendAssistantMessage();
      });
    }
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const assistantWindow = document.getElementById('assistantWindow');
        if (assistantWindow && assistantWindow.classList.contains('active')) {
          this.toggleAssistant();
        }
      }
    });
  }

  closeAllModals() {
    document.querySelectorAll('.modal').forEach(modal => {
      const bsModal = bootstrap.Modal.getInstance(modal);
      if (bsModal) bsModal.hide();
    });
    const assistantWindow = document.getElementById('assistantWindow');
    if (assistantWindow && assistantWindow.classList.contains('active')) {
      this.toggleAssistant();
    }
  }

  showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) return;
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    `;
    toastContainer.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast, { animation: true, autohide: true, delay: 3000 });
    bsToast.show();
    toast.addEventListener('hidden.bs.toast', () => { toast.remove(); });
  }

  setupAdminSystem() {
    this.checkAdminStatus();
  }

  async checkAdminStatus() {
    if (this.userData && this.userData.id) {
      try {
        const { data: profile, error } = await supabase
          .from('profiles')
          .select('role')
          .eq('user_id', this.userData.id)
          .single();
        if (!error && profile?.role === 'admin') {
          this.isAdmin = true;
          this.showAdminControls();
          console.log('Ú©Ø§Ø±Ø¨Ø± Ø§Ø¯Ù…ÛŒÙ† Ø§Ø³Øª');
        } else {
          this.isAdmin = false;
          this.hideAdminControls();
          console.log('Ú©Ø§Ø±Ø¨Ø± Ø§Ø¯Ù…ÛŒÙ† Ù†ÛŒØ³Øª');
        }
      } catch (error) {
        console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ Ù†Ù‚Ø´ Ú©Ø§Ø±Ø¨Ø±:', error);
        this.isAdmin = false;
        this.hideAdminControls();
      }
    } else {
      this.isAdmin = false;
      this.hideAdminControls();
    }
  }

  showAdminControls() {
    document.querySelectorAll('.admin-only').forEach(link => { 
      if (link) link.style.display = 'block'; 
    });
  }

  hideAdminControls() {
    document.querySelectorAll('.admin-only').forEach(link => { 
      if (link) link.style.display = 'none'; 
    });
  }

  adminLogout() {
    this.isAdmin = false;
    this.hideAdminControls();
    this.showToast('Ø§Ø² Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø§Ø±Ø¬ Ø´Ø¯ÛŒØ¯', 'success');
    this.showPage('home');
  }

  showAdminLogin() {
    this.showToast('Ù„Ø·ÙØ§Ù‹ Ø¨Ø§ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø§Ø¯Ù…ÛŒÙ† ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯', 'info');
    this.showPage('login');
  }

  async showAdminMessages() {
    if (!this.userData || !this.userData.id) {
      this.showToast('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯', 'error');
      this.showPage('login');
      return;
    }
    try {
      const { data: profile, error } = await supabase
        .from('profiles')
        .select('role')
        .eq('user_id', this.userData.id)
        .single();
      if (error) {
        console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù†Ù‚Ø´ Ú©Ø§Ø±Ø¨Ø±:', error);
        this.showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ', 'error');
        return;
      }
      if (profile?.role === 'admin') {
        this.isAdmin = true;
        this.showPage('adminMessages');
        setTimeout(() => this.loadAdminStats(), 100);
      } else {
        this.showToast('Ø´Ù…Ø§ Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ù†Ø¯Ø§Ø±ÛŒØ¯', 'error');
        this.showPage('home');
      }
    } catch (error) {
      console.error('Ø®Ø·Ø§:', error);
      this.showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ', 'error');
    }
  }

  loadAdminStats() {
    setTimeout(() => {
      const totalMessagesEl = document.getElementById('adminTotalMessages');
      if (totalMessagesEl) totalMessagesEl.textContent = '12,845';
      const activeUsersEl = document.getElementById('adminActiveUsers');
      if (activeUsersEl) activeUsersEl.textContent = '89';
      const storageUsedEl = document.getElementById('adminStorageUsed');
      if (storageUsedEl) storageUsedEl.textContent = '2.4 GB';
      const systemHealthEl = document.getElementById('adminSystemHealth');
      if (systemHealthEl) systemHealthEl.textContent = '100%';
    }, 100);
  }

  adminAnalyzeMessages() {
    this.showAdminLoading(true);
    setTimeout(() => {
      const result = '<strong>ğŸ“Š ØªØ­Ù„ÛŒÙ„ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯</strong><br><br><div class="row"><div class="col-md-6"><h6>ğŸ“ˆ Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ:</h6>â€¢ Ú©Ù„ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§: Û±Û²,Û¸Û´Ûµ<br>â€¢ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²: Û´Û²Û¸<br>â€¢ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÙØ¹Ø§Ù„: Û¸Û¹<br>â€¢ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ù¾Ø§Ø³Ø®Ú¯ÙˆÛŒÛŒ: Û².Û´ Ø¯Ù‚ÛŒÙ‚Ù‡<br></div><div class="col-md-6"><h6>ğŸ“Š ØªØ­Ù„ÛŒÙ„ Ø§Ø­Ø³Ø§Ø³Ø§Øª:</h6>â€¢ Ù…Ø«Ø¨Øª: Û¸ÛµÙª<br>â€¢ Ø®Ù†Ø«ÛŒ: Û±Û²Ùª<br>â€¢ Ù…Ù†ÙÛŒ: Û³Ùª<br>â€¢ Ù…ÙˆØ¶ÙˆØ¹Ø§Øª Ø¯Ø§Øº: Ù¾Ø±ÙˆÚ˜Ù‡ØŒ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ØŒ Ù¾Ø±Ø¯Ø§Ø®Øª<br></div></div>';
      this.showAdminResult(result);
      this.showAdminLoading(false);
    }, 2000);
  }

  adminSendBroadcast() {
    this.showAdminLoading(true);
    setTimeout(() => {
      const result = '<strong>ğŸ“¨ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¹Ù…ÙˆÙ…ÛŒ</strong><br><br><div class="alert alert-info"><i class="bi bi-info-circle me-2"></i>Ø§ÛŒÙ† ÙˆÛŒÚ˜Ú¯ÛŒ Ø¯Ø± Ù†Ø³Ø®Ù‡ Ú©Ø§Ù…Ù„ Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯</div><p>Ø¯Ø± Ø§ÛŒÙ† Ø¨Ø®Ø´ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ Ø¨Ù‡ ØªÙ…Ø§Ù… Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.</p><button class="btn btn-primary" onclick="app.showToast(\'Ø§ÛŒÙ† Ù‚Ø§Ø¨Ù„ÛŒØª Ø¯Ø± Ø­Ø§Ù„ ØªÙˆØ³Ø¹Ù‡ Ø§Ø³Øª\', \'info\')">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª</button>';
      this.showAdminResult(result);
      this.showAdminLoading(false);
    }, 1000);
  }

  adminAdvancedSearch() {
    this.showAdminLoading(true);
    setTimeout(() => {
      const result = '<strong>ğŸ” Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¬Ø§Ù…Ø¹</strong><br><br><p>Ø¯Ø± Ø§ÛŒÙ† Ø¨Ø®Ø´ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¯Ø± ØªÙ…Ø§Ù… Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ… Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯.</p><div class="input-group mb-3"><input type="text" class="form-control" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§..."><button class="btn btn-primary">Ø¬Ø³ØªØ¬Ùˆ</button></div>';
      this.showAdminResult(result);
      this.showAdminLoading(false);
    }, 1000);
  }

  adminSystemStats() {
    this.showAdminLoading(true);
    setTimeout(() => {
      const result = '<strong>ğŸ“ˆ Ø¢Ù…Ø§Ø± Ú©Ø§Ù…Ù„ Ø³ÛŒØ³ØªÙ…</strong><br><br><div class="row"><div class="col-md-6"><h6>ğŸ‘¥ Ø¢Ù…Ø§Ø± Ú©Ø§Ø±Ø¨Ø±Ø§Ù†:</h6>â€¢ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ú©Ù„: Û²,Û±ÛµÛ´<br>â€¢ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÙØ¹Ø§Ù„: Û¸Û¹<br>â€¢ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¬Ø¯ÛŒØ¯ (Ø§Ù…Ø±ÙˆØ²): Û±Û²<br>â€¢ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ†: Û³Û´<br></div><div class="col-md-6"><h6>ğŸ’¾ Ø¢Ù…Ø§Ø± Ø³Ø±ÙˆØ±:</h6>â€¢ CPU Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡: Û´Û²Ùª<br>â€¢ Ø­Ø§ÙØ¸Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡: Û².Û´ GB<br>â€¢ Ù¾Ù‡Ù†Ø§ÛŒâ€ŒØ¨Ø§Ù†Ø¯: Û±ÛµÛ¸ MB<br>â€¢ Ø³Ù„Ø§Ù…Øª Ø³ÛŒØ³ØªÙ…: Û±Û°Û°Ùª<br></div></div>';
      this.showAdminResult(result);
      this.showAdminLoading(false);
    }, 1500);
  }

  adminSystemSettings() {
    this.showAdminLoading(true);
    setTimeout(() => {
      const result = '<strong>âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³ÛŒØ³ØªÙ…</strong><br><br><p>Ø¯Ø± Ø§ÛŒÙ† Ø¨Ø®Ø´ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³ÛŒØ³ØªÙ… Ù¾ÛŒØ§Ù…â€ŒÛŒØ§Ø± Ø±Ø§ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ù†ÛŒØ¯.</p><div class="form-check mb-2"><input class="form-check-input" type="checkbox" id="enableNotifications" checked><label class="form-check-label" for="enableNotifications">ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§</label></div><div class="form-check mb-2"><input class="form-check-input" type="checkbox" id="enableAutoReply"><label class="form-check-label" for="enableAutoReply">Ù¾Ø§Ø³Ø® Ø®ÙˆØ¯Ú©Ø§Ø±</label></div><button class="btn btn-primary mt-2">Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>';
      this.showAdminResult(result);
      this.showAdminLoading(false);
    }, 1000);
  }

  adminUserManagement() {
    this.showAdminLoading(true);
    setTimeout(() => {
      const result = '<strong>ğŸ‘¥ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</strong><br><br><p>Ø¯Ø± Ø§ÛŒÙ† Ø¨Ø®Ø´ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø³ÛŒØ³ØªÙ… Ø±Ø§ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ù†ÛŒØ¯.</p><table class="table table-sm"><thead><tr><th>Ù†Ø§Ù…</th><th>Ù†ÙˆØ¹</th><th>ÙˆØ¶Ø¹ÛŒØª</th></tr></thead><tbody><tr><td>Ø¹Ù„ÛŒ Ù…Ø­Ù…Ø¯ÛŒ</td><td>Ú©Ø§Ø±ÙØ±Ù…Ø§</td><td><span class="badge bg-success">ÙØ¹Ø§Ù„</span></td></tr><tr><td>Ø´Ø±Ú©Øª Ø³Ø§Ø²Ù‡â€ŒÚ¯Ø³ØªØ±</td><td>Ù¾ÛŒÙ…Ø§Ù†Ú©Ø§Ø±</td><td><span class="badge bg-success">ÙØ¹Ø§Ù„</span></td></tr></tbody></table>';
      this.showAdminResult(result);
      this.showAdminLoading(false);
    }, 1500);
  }

  adminAdvancedCleanup() {
    this.showAdminLoading(true);
    setTimeout(() => {
      const result = '<strong>ğŸ§¹ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡</strong><br><br><p>Ø¯Ø± Ø§ÛŒÙ† Ø¨Ø®Ø´ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ Ø³ÛŒØ³ØªÙ… Ø±Ø§ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ù†ÛŒØ¯.</p><div class="alert alert-warning"><i class="bi bi-exclamation-triangle me-2"></i>Ø§ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§Øª Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ³Øª!</div><button class="btn btn-danger" onclick="app.executeCleanup()">Ø§Ø¬Ø±Ø§ÛŒ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ</button>';
      this.showAdminResult(result);
      this.showAdminLoading(false);
    }, 1000);
  }

  executeCleanup() {
    this.showAdminLoading(true);
    setTimeout(() => {
      this.showAdminResult('<strong>âœ… Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯</strong><br><br>ğŸ“‰ <strong>Ù†ØªØ§ÛŒØ¬ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ:</strong><br>â€¢ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø­Ø°Ù Ø´Ø¯Ù‡: Û±Û²,Û´ÛµÛ· Ù¾ÛŒØ§Ù…<br>â€¢ ÙØ¶Ø§ÛŒ Ø¢Ø²Ø§Ø¯ Ø´Ø¯Ù‡: Û³.Û¸ Ú¯ÛŒÚ¯Ø§Ø¨Ø§ÛŒØª<br><em>Ø³ÛŒØ³ØªÙ… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯.</em>');
      this.showAdminLoading(false);
    }, 3000);
  }

  adminViewLogs() {
    this.showAdminLoading(true);
    setTimeout(() => {
      const result = '<strong>ğŸ“š Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…</strong><br><br><p>Ø¯Ø± Ø§ÛŒÙ† Ø¨Ø®Ø´ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ø¹Ù…Ù„ÛŒØ§ØªÛŒ Ø³ÛŒØ³ØªÙ… Ø±Ø§ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú©Ù†ÛŒØ¯.</p><div class="border rounded p-3"><div class="mb-2"><span class="badge bg-info">INFO</span><span class="ms-2">' + new Date().toLocaleString('fa-IR') + ' - Ø³ÛŒØ³ØªÙ… Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯</span></div><div class="mb-2"><span class="badge bg-success">USER</span><span class="ms-2">' + new Date().toLocaleString('fa-IR') + ' - Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø±Ø¯</span></div></div>';
      this.showAdminResult(result);
      this.showAdminLoading(false);
    }, 1000);
  }

  showAdminLoading(show) {
    const loadingElement = document.getElementById('adminMessagesLoading');
    if (loadingElement) loadingElement.style.display = show ? 'block' : 'none';
  }

  showAdminResult(content) {
    const resultElement = document.getElementById('adminMessagesResult');
    if (resultElement) resultElement.innerHTML = content;
  }

  async loadRealStats() {
    try {
      const { count: realContractors } = await supabase
        .from('profiles')
        .select('*', { count: 'exact', head: true })
        .eq('user_type', 'contractor');
      const { count: realEmployers } = await supabase
        .from('profiles')
        .select('*', { count: 'exact', head: true })
        .eq('user_type', 'employer');
      let realProjects = 0;
      try {
        const { count } = await supabase
          .from('projects')
          .select('*', { count: 'exact', head: true });
        realProjects = count || 0;
      } catch (e) {
        realProjects = 0;
      }
      const BASE_CONTRACTORS = 150;
      const BASE_EMPLOYERS = 100;
      const BASE_PROJECTS = 75;
      const BASE_SATISFACTION = 98;
      const totalContractors = BASE_CONTRACTORS + (realContractors || 0);
      const totalEmployers = BASE_EMPLOYERS + (realEmployers || 0);
      const totalProjects = BASE_PROJECTS + (realProjects || 0);
      const contractorElement = document.querySelector('.stat-value[data-count="1250"]');
      const employerElement = document.querySelector('.stat-value[data-count="320"]');
      const projectElement = document.querySelector('.stat-value[data-count="540"]');
      const satisfactionElement = document.querySelector('.stat-value[data-count="98"]');
      if (contractorElement) {
        contractorElement.textContent = totalContractors.toLocaleString('fa-IR');
      }
      if (employerElement) {
        employerElement.textContent = totalEmployers.toLocaleString('fa-IR');
      }
      if (projectElement) {
        projectElement.textContent = totalProjects.toLocaleString('fa-IR');
      }
      if (satisfactionElement) {
        satisfactionElement.textContent = BASE_SATISFACTION + 'Ùª';
      }
    } catch (error) {
      console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¢Ù…Ø§Ø±:', error);
      const contractorElement = document.querySelector('.stat-value[data-count="1250"]');
      const employerElement = document.querySelector('.stat-value[data-count="320"]');
      const projectElement = document.querySelector('.stat-value[data-count="540"]');
      const satisfactionElement = document.querySelector('.stat-value[data-count="98"]');
      if (contractorElement) contractorElement.textContent = '150';
      if (employerElement) employerElement.textContent = '100';
      if (projectElement) projectElement.textContent = '75';
      if (satisfactionElement) satisfactionElement.textContent = '98Ùª';
    }
  }

  async loadAdminStats() {
    if (!this.isAdmin) return;
    try {
      const { count: totalUsers } = await supabase
        .from('profiles')
        .select('*', { count: 'exact', head: true });
      let totalMessages = 0;
      try {
        const { count } = await supabase
          .from('messages')
          .select('*', { count: 'exact', head: true });
        totalMessages = count || 0;
      } catch (e) {
        totalMessages = 0;
      }
      let totalProjects = 0;
      try {
        const { count } = await supabase
          .from('projects')
          .select('*', { count: 'exact', head: true });
        totalProjects = count || 0;
      } catch (e) {
        totalProjects = 0;
      }
      const storageUsed = ((totalMessages * 0.5) + (totalUsers * 2) + (totalProjects * 1)).toFixed(1);
      const totalMessagesEl = document.getElementById('adminTotalMessages');
      if (totalMessagesEl) {
        totalMessagesEl.textContent = totalMessages.toLocaleString('fa-IR');
      }
      const activeUsersEl = document.getElementById('adminActiveUsers');
      if (activeUsersEl) {
        activeUsersEl.textContent = totalUsers.toLocaleString('fa-IR');
      }
      const storageUsedEl = document.getElementById('adminStorageUsed');
      if (storageUsedEl) {
        storageUsedEl.textContent = storageUsed + ' MB';
      }
      const systemHealthEl = document.getElementById('adminSystemHealth');
      if (systemHealthEl) {
        systemHealthEl.textContent = '100%';
      }
    } catch (error) {
      console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¢Ù…Ø§Ø± Ù…Ø¯ÛŒØ±ÛŒØª:', error);
    }
  }
}

// ===== ØªØ¹Ø±ÛŒÙ Ù†Ù…ÙˆÙ†Ù‡ Ø§Ø² Ú©Ù„Ø§Ø³ =====
let app;

function initApp() {
  console.log('Initializing app...');
  try {
    app = new PeymanyarApp();
    console.log('App created successfully');
  } catch (error) {
    console.error('Error creating app:', error);
  }
}

// Ø§Ø¬Ø±Ø§ Ø¨Ø¹Ø¯ Ø§Ø² Ù„ÙˆØ¯ Ú©Ø§Ù…Ù„ ØµÙØ­Ù‡
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initApp);
} else {
  initApp();
}

// ===== ØªÙˆØ§Ø¨Ø¹ Ú¯Ù„ÙˆØ¨Ø§Ù„ (Ø¨Ø§ ÙØ±Ù…Øª Ø³Ø§Ø¯Ù‡ Ùˆ Ø¨Ø¯ÙˆÙ† ?. ) =====
window.showPage = function(pageId) { if (app) app.showPage(pageId); };
window.showMainPage = function() { if (app) app.showMainPage(); };
window.showLogin = function() { if (app) app.showLogin(); };
window.showForgotPassword = function() { if (app) app.showForgotPassword(); };
window.showEmployerRegistration = function() { if (app) app.showEmployerRegistration(); };
window.showContractorRegistration = function() { if (app) app.showContractorRegistration(); };
window.toggleAssistant = function() { if (app) app.toggleAssistant(); };
window.sendAssistantMessage = function() { if (app) app.sendAssistantMessage(); };
window.performSearch = function() { if (app) app.performSearch(); };
window.createNewProject = function() { if (app) app.createNewProject(); };
window.logout = function() { if (app) app.logout(); };
window.analyzeMessages = function() { if (app) app.analyzeMessages(); };
window.sendGroupMessage = function() { if (app) app.sendGroupMessage(); };
window.searchMessages = function() { if (app) app.searchMessages(); };
window.showStatistics = function() { if (app) app.showStatistics(); };
window.openSettings = function() { if (app) app.openSettings(); };
window.syncData = function() { if (app) app.syncData(); };
window.cleanupStorage = function() { if (app) app.cleanupStorage(); };
window.showHelp = function() { if (app) app.showHelp(); };
window.changeMessagesTheme = function() { if (app) app.changeMessagesTheme(); };
window.resetMessagesSettings = function() { if (app) app.resetMessagesSettings(); };
window.exportMessagesData = function() { if (app) app.exportMessagesData(); };
window.adminLogin = function() { if (app) app.adminLogin(); };
window.adminLogout = function() { if (app) app.adminLogout(); };
window.showAdminLogin = function() { if (app) app.showAdminLogin(); };
window.showAdminMessages = function() { if (app) app.showAdminMessages(); };
window.adminAnalyzeMessages = function() { if (app) app.adminAnalyzeMessages(); };
window.adminSendBroadcast = function() { if (app) app.adminSendBroadcast(); };
window.adminAdvancedSearch = function() { if (app) app.adminAdvancedSearch(); };
window.adminSystemStats = function() { if (app) app.adminSystemStats(); };
window.adminSystemSettings = function() { if (app) app.adminSystemSettings(); };
window.adminUserManagement = function() { if (app) app.adminUserManagement(); };
window.adminAdvancedCleanup = function() { if (app) app.adminAdvancedCleanup(); };
window.adminViewLogs = function() { if (app) app.adminViewLogs(); };
window.executeCleanup = function() { if (app) app.executeCleanup(); };
window.togglePasswordVisibility = function(id) { if (app) app.togglePasswordVisibility(id); };
window.showTermsModal = function() { if (app) app.showTermsModal(); };
window.closeTermsModal = function() { if (app) app.closeTermsModal(); };
window.acceptTerms = function() { if (app) app.acceptTerms(); };
window.enableProfileEdit = function() { if (app) app.enableProfileEdit(); };
window.cancelProfileEdit = function() { if (app) app.cancelProfileEdit(); };
window.saveProfileChanges = function() { if (app) app.saveProfileChanges(); };
window.PeymanYar = function() { if (app && typeof app.PeymanYar === 'function') app.PeymanYar(); };

// Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø§ÛŒÙ†Ú©Ù‡ app Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ø§Ø³Øª
window.app = app;
</script>
</body>
</html>