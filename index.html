<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const supabaseUrl = 'https://fycyznoykgxpaatjsawi.supabase.co'
const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ5Y3l6bm95a2d4cGFhdGpzYXdpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2MDM0MjYsImV4cCI6MjA4NzE3OTQyNn0.fZQfDuaUW6jxQOF0be8eaK16mD-lHfPnyYht-0ryQSQ'

const supabase = createClient(supabaseUrl, supabaseAnonKey)
window.supabase = supabase

'use strict';

// =====================================================================
// کلاس اصلی پیمان‌یار
// =====================================================================
class PeymanyarApp {
    constructor() {
        this.currentPage = 'home';
        this.employerCurrentStep = 1;
        this.contractorCurrentStep = 1;
        this.employerTotalSteps = 4;
        this.contractorTotalSteps = 5;
        this.assistantMessages = [];
        this.userData = null;
        this.heroSlideIndex = 0;
        this.heroSlides = [];
        this.heroSlideInterval = null;
        this.isAdmin = false;
        this.adminToken = null;
        this.adminEmail = null;
        this.init();
    }

    // =================================================================
    // توابع اولیه‌سازی
    // =================================================================
    init() {
        this.setupEventListeners();
        this.setupForms();
        this.setupAssistant();
        this.animateCounters();
        this.setupAccessibility();
        this.loadUserData();
        this.setupMessagingSystem();
        this.setupHeroSlider();
        this.setupAdminSystem();
        this.loadRealStats();
        this.setupLoginForms();
        this.setupPasswordValidation();
    }

    setupEventListeners() {
        window.addEventListener('popstate', (e) => {
            if (e.state && e.state.page) {
                this.showPage(e.state.page, false);
            }
        });
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                this.closeAllModals();
            }
        });
        
        this.setupIntersectionObserver();
    }

    setupIntersectionObserver() {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('animate__animated', 'animate__fadeInUp');
                }
            });
        }, { threshold: 0.1 });
        
        document.querySelectorAll('.card-peymanyar').forEach(card => {
            observer.observe(card);
        });
    }

    setupFocusTrap() {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            modal.addEventListener('keydown', (e) => {
                if (e.key === 'Tab') {
                    const focusableElements = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                    const firstElement = focusableElements[0];
                    const lastElement = focusableElements[focusableElements.length - 1];
                    
                    if (e.shiftKey) {
                        if (document.activeElement === firstElement) {
                            lastElement.focus();
                            e.preventDefault();
                        }
                    } else {
                        if (document.activeElement === lastElement) {
                            firstElement.focus();
                            e.preventDefault();
                        }
                    }
                }
            });
        });
    }

    addSkipToContentLink() {
        const skipLink = document.createElement('a');
        skipLink.href = '#main-content';
        skipLink.className = 'skip-to-content';
        skipLink.textContent = 'پرش به محتوای اصلی';
        skipLink.style.cssText = 'position: absolute; top: -40px; right: 0; background: var(--primary-color); color: white; padding: 8px 16px; text-decoration: none; z-index: 9999;';
        
        skipLink.addEventListener('focus', () => { skipLink.style.top = '0'; });
        skipLink.addEventListener('blur', () => { skipLink.style.top = '-40px'; });
        
        document.body.prepend(skipLink);
    }

    // =================================================================
    // توابع مدیریت صفحات
    // =================================================================
    showPage(pageId, pushState = true) {
        document.querySelectorAll('.page-section').forEach(page => {
            page.classList.remove('active');
            page.setAttribute('aria-hidden', 'true');
            page.style.display = 'none';
        });
        
        const targetPage = document.getElementById(pageId);
        if (targetPage) {
            targetPage.classList.add('active');
            targetPage.style.display = 'block';
            targetPage.setAttribute('aria-hidden', 'false');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            if (pushState) {
                history.pushState({ page: pageId }, '', `#${pageId}`);
            }
            
            this.currentPage = pageId;
            this.updateActiveLinks(pageId);
            this.dispatchPageChangeEvent(pageId);

            if (pageId === 'profile') {
                this.loadFullProfile();
            }
            
            if (pageId === 'projects' || pageId === 'projectsPage') {
                this.loadProjects();
            }
        }
    }

    updateActiveLinks(pageId) {
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
            link.removeAttribute('aria-current');
        });
        
        const activeLink = document.querySelector(`[onclick*="${pageId}"]`);
        if (activeLink) {
            activeLink.classList.add('active');
            activeLink.setAttribute('aria-current', 'page');
        }
    }

    dispatchPageChangeEvent(pageId) {
        const event = new CustomEvent('pageChanged', { detail: { pageId } });
        window.dispatchEvent(event);
    }

    showMainPage() {
        this.showPage('home');
    }

    showLogin() {
        this.showPage('login');
    }

    showForgotPassword() {
        this.showPage('forgotPassword');
    }

    showEmployerRegistration() {
        this.showPage('employerRegistration');
        this.employerCurrentStep = 1;
        
        document.querySelectorAll('#employerRegistration .form-section').forEach((section, index) => {
            if (index === 0) {
                section.style.display = 'block';
            } else {
                section.style.display = 'none';
            }
        });
        
        this.updateEmployerNavigation();
        document.getElementById('employerForm').reset();
        this.updateEmployerFields();
        this.clearValidationErrors();
    }

    showContractorRegistration() {
        this.showPage('contractorRegistration');
        this.contractorCurrentStep = 1;
        
        document.querySelectorAll('#contractorRegistration .form-section').forEach((section, index) => {
            if (index === 0) {
                section.style.display = 'block';
            } else {
                section.style.display = 'none';
            }
        });
        
        this.updateProgressBar();
        this.updateStepIndicator();
        this.updateContractorNavigation();
        document.getElementById('contractorForm').reset();
        this.updateContractorFields();
        this.clearValidationErrors();
        document.getElementById('fileList').innerHTML = '';
        
        const projectContainer = document.getElementById('projectContainer');
        projectContainer.innerHTML = `
            <div class="card mb-3 project-card">
                <div class="card-body">
                    <h6 class="card-title">پروژه نمونه ۱</h6>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">نام پروژه</label>
                            <input type="text" class="form-control" name="projectName[]">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">سال تحویل (شمسی)</label>
                            <select class="form-select" name="projectYear[]">
                                <option value="">-- انتخاب سال --</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">مشتری</label>
                            <input type="text" class="form-control" name="projectClient[]" placeholder="نام شرکت یا شخص">
                        </div>
                        <div class="col-12 mb-3">
                            <label class="form-label">تصویر پروژه (حداکثر ۱ تصویر)</label>
                            <input type="file" class="form-control" name="projectImage[]" accept="image/*">
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        const firstYearSelect = document.querySelector('#projectContainer select[name="projectYear[]"]');
        this.populateProjectYearSelect(firstYearSelect);
        
        const workArea = document.getElementById('workArea');
        Array.from(workArea.options).forEach(opt => {
            opt.disabled = false;
            opt.selected = false;
        });
        
        document.getElementById('formSummary').style.display = 'none';
        localStorage.removeItem('contractor_form_temp');
    }

    closeAllModals() {
        document.querySelectorAll('.modal').forEach(modal => {
            const bsModal = bootstrap.Modal.getInstance(modal);
            if (bsModal) bsModal.hide();
        });
        
        const assistantWindow = document.getElementById('assistantWindow');
        if (assistantWindow && assistantWindow.classList.contains('active')) {
            this.toggleAssistant();
        }
    }

    // =================================================================
    // توابع مربوط به قوانین و مقررات
    // =================================================================
    showTermsModal() {
        const termsModal = new bootstrap.Modal(document.getElementById('termsModal'));
        termsModal.show();
        
        const employerTerms = document.getElementById('employerTerms');
        const contractorTerms = document.getElementById('contractorTerms');
        
        if (employerTerms) {
            window.tempEmployerTermsState = employerTerms.checked;
        }
        if (contractorTerms) {
            window.tempContractorTermsState = contractorTerms.checked;
        }
    }

    acceptTerms() {
        const employerTerms = document.getElementById('employerTerms');
        const contractorTerms = document.getElementById('contractorTerms');
        
        if (employerTerms) {
            employerTerms.checked = true;
            employerTerms.disabled = false;
        }
        if (contractorTerms) {
            contractorTerms.checked = true;
            contractorTerms.disabled = false;
        }
        
        delete window.tempEmployerTermsState;
        delete window.tempContractorTermsState;
        
        this.closeTermsModal();
        this.showToast('قوانین و مقررات با موفقیت پذیرفته شد', 'success');
    }

    closeTermsModal() {
        const termsModal = bootstrap.Modal.getInstance(document.getElementById('termsModal'));
        if (termsModal) termsModal.hide();
        
        const employerTerms = document.getElementById('employerTerms');
        const contractorTerms = document.getElementById('contractorTerms');
        
        if (employerTerms && window.tempEmployerTermsState !== undefined) {
            employerTerms.checked = window.tempEmployerTermsState;
            employerTerms.disabled = !window.tempEmployerTermsState;
        }
        if (contractorTerms && window.tempContractorTermsState !== undefined) {
            contractorTerms.checked = window.tempContractorTermsState;
            contractorTerms.disabled = !window.tempContractorTermsState;
        }
    }

    // =================================================================
    // توابع پروفایل کاربر
    // =================================================================
    async loadFullProfile() {
        if (!this.userData || !this.userData.id) {
            this.showToast('لطفاً وارد شوید', 'error');
            this.showPage('login');
            return;
        }

        try {
            const { data: profile, error } = await supabase
                .from('profiles')
                .select('*')
                .eq('user_id', this.userData.id)
                .single();

            if (error && error.code !== 'PGRST116') {
                console.error('خطا در دریافت پروفایل:', error);
            }

            const fullProfile = { ...this.userData, ...profile };
            this.displayFullProfile(fullProfile);
            
        } catch (error) {
            console.error('خطا:', error);
            this.showToast('خطا در بارگذاری پروفایل', 'error');
        }
    }

    displayFullProfile(profile) {
        document.getElementById('profileDisplayName').textContent = profile.full_name || profile.company_name || 'کاربر';
        document.getElementById('profileDisplayEmail').textContent = profile.email || '-';
        document.getElementById('profileDisplayType').textContent = profile.user_type === 'employer' ? 'کارفرما' : 'پیمانکار';
        document.getElementById('profileDisplayAccountType').textContent = profile.account_type === 'individual' ? 'شخص حقیقی' : 'شخص حقوقی';
        document.getElementById('profileDisplayFullName').textContent = profile.full_name || profile.company_name || '-';
        document.getElementById('profileDisplayNationalId').textContent = profile.national_code || profile.company_id || '-';
        document.getElementById('profileDisplayMobile').textContent = profile.phone || '-';
        document.getElementById('profileDisplayPhone').textContent = profile.landline || '-';
        document.getElementById('profileDisplayAddress').textContent = profile.address || '-';

        const avatar = document.getElementById('profileAvatar');
        if (avatar) {
            avatar.textContent = (profile.full_name || profile.company_name || '?').charAt(0);
        }

        const companyFields = document.getElementById('profileCompanyFields');
        if (companyFields) {
            if (profile.account_type === 'company') {
                companyFields.style.display = 'block';
                document.getElementById('profileDisplayCompanyName').textContent = profile.company_name || '-';
                document.getElementById('profileDisplayRegistrationNo').textContent = profile.registration_no || '-';
                document.getElementById('profileDisplayCompanyType').textContent = profile.company_type || '-';
                document.getElementById('profileDisplayWebsite').textContent = profile.website || '-';
                document.getElementById('profileDisplayCompanyDesc').textContent = profile.company_description || '-';
            } else {
                companyFields.style.display = 'none';
            }
        }

        const contractorFields = document.getElementById('contractorProfileFields');
        if (contractorFields) {
            if (profile.user_type === 'contractor') {
                contractorFields.style.display = 'block';
                document.getElementById('profileDisplayMainExpertise').textContent = profile.main_expertise || '-';
                document.getElementById('profileDisplayStartYear').textContent = profile.start_year || '-';
                document.getElementById('profileDisplayTeamSize').textContent = profile.team_size || '-';
                document.getElementById('profileDisplayWorkArea').textContent = profile.work_area ? profile.work_area.join('، ') : '-';
                document.getElementById('profileDisplayContractMethod').textContent = profile.contract_method || '-';
                document.getElementById('profileDisplayInsurance').textContent = profile.insurance === 'yes' ? 'دارد' : 'ندارد';
                document.getElementById('profileDisplayEquipment').textContent = profile.equipment || '-';

                this.displayProjects(profile.projects);
                this.displayDocuments(profile.documents);

                const verificationStatus = document.getElementById('profileVerificationStatus');
                if (verificationStatus && profile.verification_status) {
                    verificationStatus.style.display = 'block';
                    const statusText = {
                        'pending': 'در انتظار بررسی',
                        'verified': 'تأیید شده',
                        'rejected': 'رد شده'
                    }[profile.verification_status] || profile.verification_status;
                    document.getElementById('profileVerificationText').textContent = statusText;
                }
            } else {
                contractorFields.style.display = 'none';
                const verificationStatus = document.getElementById('profileVerificationStatus');
                if (verificationStatus) verificationStatus.style.display = 'none';
            }
        }
    }

    displayProjects(projects) {
        const container = document.getElementById('profileDisplayProjects');
        if (!container) return;

        if (!projects || projects.length === 0) {
            container.innerHTML = '<p class="text-muted">پروژه‌ای ثبت نشده است.</p>';
            return;
        }

        container.innerHTML = projects.map(project => `
            <div class="col-md-6 mb-3">
                <div class="border rounded p-3">
                    <h6>${project.name || 'بدون نام'}</h6>
                    <small class="text-muted d-block">سال: ${project.year || '-'}</small>
                    <small class="text-muted d-block">مشتری: ${project.client || '-'}</small>
                </div>
            </div>
        `).join('');
    }

    displayDocuments(documents) {
        const container = document.getElementById('profileDisplayDocuments');
        if (!container) return;

        if (!documents || documents.length === 0) {
            container.innerHTML = '<p class="text-muted">مدرکی آپلود نشده است.</p>';
            return;
        }

        container.innerHTML = documents.map(doc => `
            <span class="badge bg-light text-dark p-2">
                <i class="bi bi-file-earmark-text me-1"></i>${doc.name}
            </span>
        `).join('');
    }

    populateEditYears() {
        const yearSelect = document.getElementById('editStartYear');
        if (!yearSelect) return;

        yearSelect.innerHTML = '<option value="">انتخاب کنید</option>';
        for (let year = 1403; year >= 1350; year--) {
            const option = document.createElement('option');
            option.value = year;
            option.text = year;
            yearSelect.appendChild(option);
        }
    }

    addProjectToEdit() {
        const container = document.getElementById('editProjectsContainer');
        if (!container) return;

        const projectCount = container.children.length + 1;
        if (projectCount > 5) {
            this.showToast('حداکثر ۵ پروژه می‌توانید اضافه کنید.', 'error');
            return;
        }

        const projectDiv = document.createElement('div');
        projectDiv.className = 'card mb-3 project-card';
        projectDiv.innerHTML = `
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="card-title mb-0">پروژه ${projectCount}</h6>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('.project-card').remove()">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">نام پروژه</label>
                        <input type="text" class="form-control" name="editProjectName[]">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">سال تحویل</label>
                        <input type="text" class="form-control" name="editProjectYear[]" placeholder="مثال: 1402">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">مشتری</label>
                        <input type="text" class="form-control" name="editProjectClient[]" placeholder="نام شرکت یا شخص">
                    </div>
                </div>
            </div>
        `;

        container.appendChild(projectDiv);
    }

    enableProfileEdit() {
        const viewMode = document.getElementById('profileViewMode');
        const editMode = document.getElementById('profileEditMode');
        if (!viewMode || !editMode) return;

        viewMode.style.display = 'none';
        editMode.style.display = 'block';

        if (document.getElementById('editFullName')) {
            document.getElementById('editFullName').value = this.userData?.full_name || this.userData?.name || '';
        }
        if (document.getElementById('editNationalId')) {
            document.getElementById('editNationalId').value = this.userData?.national_code || this.userData?.company_id || '';
        }
        if (document.getElementById('editEmail')) {
            document.getElementById('editEmail').value = this.userData?.email || '';
        }
        if (document.getElementById('editMobile')) {
            document.getElementById('editMobile').value = this.userData?.phone || this.userData?.mobile || '';
        }
        if (document.getElementById('editPhone')) {
            document.getElementById('editPhone').value = this.userData?.landline || '';
        }
        if (document.getElementById('editAddress')) {
            document.getElementById('editAddress').value = this.userData?.address || '';
        }
        if (document.getElementById('editPostalCode')) {
            document.getElementById('editPostalCode').value = this.userData?.postal_code || '';
        }
        if (document.getElementById('editProvince')) {
            document.getElementById('editProvince').value = this.userData?.province || '';
        }
        if (document.getElementById('editCity')) {
            document.getElementById('editCity').value = this.userData?.city || '';
        }

        this.populateEditYears();

        const companyFields = document.getElementById('editCompanyFields');
        if (companyFields) {
            if (this.userData?.account_type === 'company') {
                companyFields.style.display = 'flex';
                if (document.getElementById('editCompanyName')) {
                    document.getElementById('editCompanyName').value = this.userData?.company_name || '';
                }
                if (document.getElementById('editRegistrationNo')) {
                    document.getElementById('editRegistrationNo').value = this.userData?.registration_no || '';
                }
                if (document.getElementById('editCompanyType')) {
                    document.getElementById('editCompanyType').value = this.userData?.company_type || '';
                }
                if (document.getElementById('editWebsite')) {
                    document.getElementById('editWebsite').value = this.userData?.website || '';
                }
                if (document.getElementById('editCompanyDesc')) {
                    document.getElementById('editCompanyDesc').value = this.userData?.company_description || '';
                }
            } else {
                companyFields.style.display = 'none';
            }
        }

        const contractorFields = document.getElementById('editContractorFields');
        const projectsSection = document.getElementById('editProjectsSection');
        const documentsSection = document.getElementById('editDocumentsSection');

        if (contractorFields && projectsSection && documentsSection) {
            if (this.userData?.user_type === 'contractor') {
                contractorFields.style.display = 'flex';
                projectsSection.style.display = 'block';
                documentsSection.style.display = 'block';

                if (document.getElementById('editMainExpertise')) {
                    document.getElementById('editMainExpertise').value = this.userData?.main_expertise || '';
                }
                if (document.getElementById('editStartYear')) {
                    document.getElementById('editStartYear').value = this.userData?.start_year || '';
                }
                if (document.getElementById('editTeamSize')) {
                    document.getElementById('editTeamSize').value = this.userData?.team_size || '';
                }
                if (document.getElementById('editContractMethod')) {
                    document.getElementById('editContractMethod').value = this.userData?.contract_method || '';
                }
                if (document.getElementById('editInsurance')) {
                    document.getElementById('editInsurance').value = this.userData?.insurance || '';
                }
                if (document.getElementById('editEquipment')) {
                    document.getElementById('editEquipment').value = this.userData?.equipment || '';
                }

                this.displayEditProjects(this.userData?.projects);
            } else {
                contractorFields.style.display = 'none';
                projectsSection.style.display = 'none';
                documentsSection.style.display = 'none';
            }
        }
    }

    displayEditProjects(projects) {
        const container = document.getElementById('editProjectsContainer');
        if (!container) return;

        container.innerHTML = '';

        if (projects && projects.length > 0) {
            projects.forEach((project, index) => {
                const projectDiv = document.createElement('div');
                projectDiv.className = 'card mb-3 project-card';
                projectDiv.innerHTML = `
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="card-title mb-0">پروژه ${index + 1}</h6>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('.project-card').remove()">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">نام پروژه</label>
                                <input type="text" class="form-control" name="editProjectName[]" value="${project.name || ''}">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">سال تحویل</label>
                                <input type="text" class="form-control" name="editProjectYear[]" value="${project.year || ''}">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">مشتری</label>
                                <input type="text" class="form-control" name="editProjectClient[]" value="${project.client || ''}">
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(projectDiv);
            });
        }
    }

    cancelProfileEdit() {
        const viewMode = document.getElementById('profileViewMode');
        const editMode = document.getElementById('profileEditMode');
        if (viewMode && editMode) {
            viewMode.style.display = 'block';
            editMode.style.display = 'none';
        }
        this.loadFullProfile();
    }

    async saveProfileChanges() {
        const updatedData = {
            full_name: document.getElementById('editFullName')?.value,
            phone: document.getElementById('editMobile')?.value,
            landline: document.getElementById('editPhone')?.value,
            address: document.getElementById('editAddress')?.value,
            postal_code: document.getElementById('editPostalCode')?.value,
            province: document.getElementById('editProvince')?.value,
            city: document.getElementById('editCity')?.value,
            national_code: document.getElementById('editNationalId')?.value,
        };

        if (updatedData.phone && !this.isValidMobile(updatedData.phone)) {
            this.showToast('شماره موبایل نامعتبر است', 'error');
            return;
        }

        if (this.userData?.account_type === 'company') {
            updatedData.company_name = document.getElementById('editCompanyName')?.value;
            updatedData.registration_no = document.getElementById('editRegistrationNo')?.value;
            updatedData.company_type = document.getElementById('editCompanyType')?.value;
            updatedData.website = document.getElementById('editWebsite')?.value;
            updatedData.company_description = document.getElementById('editCompanyDesc')?.value;
        }

        if (this.userData?.user_type === 'contractor') {
            updatedData.main_expertise = document.getElementById('editMainExpertise')?.value;
            updatedData.start_year = document.getElementById('editStartYear')?.value;
            updatedData.team_size = document.getElementById('editTeamSize')?.value;
            updatedData.contract_method = document.getElementById('editContractMethod')?.value;
            updatedData.insurance = document.getElementById('editInsurance')?.value;
            updatedData.equipment = document.getElementById('editEquipment')?.value;

            const projects = [];
            const projectNames = document.querySelectorAll('input[name="editProjectName[]"]');
            const projectYears = document.querySelectorAll('input[name="editProjectYear[]"]');
            const projectClients = document.querySelectorAll('input[name="editProjectClient[]"]');

            for (let i = 0; i < projectNames.length; i++) {
                if (projectNames[i].value || projectYears[i].value || projectClients[i].value) {
                    projects.push({
                        name: projectNames[i].value,
                        year: projectYears[i].value,
                        client: projectClients[i].value
                    });
                }
            }
            updatedData.projects = projects;
        }

        try {
            const { error } = await supabase
                .from('profiles')
                .update(updatedData)
                .eq('user_id', this.userData.id);

            if (error) throw error;

            this.userData = { ...this.userData, ...updatedData };
            localStorage.setItem('peymanyar_user', JSON.stringify(this.userData));

            this.showToast('اطلاعات با موفقیت به‌روز شد', 'success');

            const viewMode = document.getElementById('profileViewMode');
            const editMode = document.getElementById('profileEditMode');
            if (viewMode && editMode) {
                viewMode.style.display = 'block';
                editMode.style.display = 'none';
            }

            this.loadFullProfile();

        } catch (error) {
            this.showToast('خطا در ذخیره اطلاعات: ' + error.message, 'error');
        }
    }

    // =================================================================
    // توابع ثبت‌نام و فرم‌ها
    // =================================================================
    setupForms() {
        this.setupEmployerForm();
        this.setupContractorForm();
        this.setupValidation();
    }

    setupValidation() {
        const emailInputs = document.querySelectorAll('input[type="email"]');
        emailInputs.forEach(input => {
            input.addEventListener('blur', () => {
                if (input.value && !this.isValidEmail(input.value)) {
                    this.showValidationError(input.id, 'لطفاً ایمیل معتبر وارد کنید');
                }
            });
        });
        
        const mobileInputs = document.querySelectorAll('input[type="tel"][pattern]');
        mobileInputs.forEach(input => {
            input.addEventListener('blur', () => {
                if (input.value && !this.isValidMobile(input.value)) {
                    this.showValidationError(input.id, 'لطفاً شماره موبایل معتبر وارد کنید');
                }
            });
        });
    }

    isValidEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
    }

    isValidMobile(mobile) {
        const re = /^09[0-9]{9}$/;
        return re.test(mobile);
    }

    sanitizeHTML(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    showValidationError(fieldId, message) {
        const field = document.getElementById(fieldId);
        if (field) {
            field.classList.add('is-invalid');
            
            let feedback = field.nextElementSibling;
            while (feedback && !feedback.classList.contains('invalid-feedback')) {
                feedback = feedback.nextElementSibling;
            }
            
            if (!feedback || !feedback.classList.contains('invalid-feedback')) {
                feedback = document.createElement('div');
                feedback.className = 'invalid-feedback';
                field.parentNode.appendChild(feedback);
            }
            
            feedback.textContent = message;
            feedback.style.display = 'block';
            
            field.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else {
            this.showToast(message, 'error');
        }
    }

    clearValidationErrors() {
        document.querySelectorAll('.is-invalid').forEach(field => {
            field.classList.remove('is-invalid');
        });
        document.querySelectorAll('.invalid-feedback').forEach(feedback => {
            feedback.style.display = 'none';
        });
    }

    // =================================================================
    // توابع فرم کارفرما
    // =================================================================
    setupEmployerForm() {
        const accountTypeSelect = document.getElementById('employerAccountType');
        if (accountTypeSelect) {
            accountTypeSelect.addEventListener('change', () => this.updateEmployerFields());
            this.updateEmployerFields();
        }
        
        document.getElementById('employerNextBtn').addEventListener('click', () => this.nextEmployerStep());
        document.getElementById('employerPrevBtn').addEventListener('click', () => this.prevEmployerStep());
        document.getElementById('employerForm').addEventListener('submit', (e) => this.submitEmployerForm(e));
    }

    updateEmployerFields() {
        const accountType = document.getElementById('employerAccountType').value;
        const dynamicFields = document.getElementById('employerDynamicFields');
        const companyFields = document.getElementById('employerCompanyFields');
        
        if (!dynamicFields) return;
        
        dynamicFields.innerHTML = '';
        
        if (accountType === 'individual') {
            dynamicFields.innerHTML = `
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="employerFullName" class="form-label required">نام و نام خانوادگی</label>
                        <input type="text" class="form-control" id="employerFullName" required>
                        <div class="invalid-feedback">لطفاً نام و نام خانوادگی را وارد کنید</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="employerNationalCode" class="form-label required">کد ملی</label>
                        <input type="text" class="form-control" id="employerNationalCode" required maxlength="10">
                        <div class="invalid-feedback">لطفاً کد ملی معتبر وارد کنید</div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="employerEmail" class="form-label required">ایمیل</label>
                        <input type="email" class="form-control" id="employerEmail" required>
                        <div class="invalid-feedback">لطفاً ایمیل معتبر وارد کنید</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="employerPassword" class="form-label required">رمز عبور</label>
                        <input type="password" class="form-control" id="employerPassword" required>
                        <div class="invalid-feedback">لطفاً رمز عبور را وارد کنید</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="employerConfirmPassword" class="form-label required">تکرار رمز عبور</label>
                        <input type="password" class="form-control" id="employerConfirmPassword" required>
                        <div class="invalid-feedback" id="employerConfirmFeedback"></div>
                    </div>
                </div>
            `;
            if (companyFields) companyFields.style.display = 'none';
            
        } else if (accountType === 'company') {
            dynamicFields.innerHTML = `
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="employerCompanyName" class="form-label required">نام شرکت/مؤسسه</label>
                        <input type="text" class="form-control" id="employerCompanyName" required>
                        <div class="invalid-feedback">لطفاً نام شرکت را وارد کنید</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="employerManagerName" class="form-label required">نام مدیرعامل</label>
                        <input type="text" class="form-control" id="employerManagerName" required>
                        <div class="invalid-feedback">لطفاً نام مدیرعامل را وارد کنید</div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="employerEmail" class="form-label required">ایمیل</label>
                        <input type="email" class="form-control" id="employerEmail" required>
                        <div class="invalid-feedback">لطفاً ایمیل معتبر وارد کنید</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="employerPassword" class="form-label required">رمز عبور</label>
                        <input type="password" class="form-control" id="employerPassword" required>
                        <div class="invalid-feedback">لطفاً رمز عبور را وارد کنید</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="employerConfirmPassword" class="form-label required">تکرار رمز عبور</label>
                        <input type="password" class="form-control" id="employerConfirmPassword" required>
                        <div class="invalid-feedback">لطفاً تکرار رمز عبور را وارد کنید</div>
                    </div>
                </div>
            `;
            if (companyFields) companyFields.style.display = 'block';
        }
    }

    nextEmployerStep() {
        if (this.validateEmployerStep(this.employerCurrentStep)) {
            if (this.employerCurrentStep < this.employerTotalSteps) {
                document.getElementById(`employerSection${this.employerCurrentStep}`).style.display = 'none';
                this.employerCurrentStep++;
                document.getElementById(`employerSection${this.employerCurrentStep}`).style.display = 'block';
                this.updateEmployerNavigation();
                this.updateEmployerSummary();
            }
        }
    }

    prevEmployerStep() {
        if (this.employerCurrentStep > 1) {
            document.getElementById(`employerSection${this.employerCurrentStep}`).style.display = 'none';
            this.employerCurrentStep--;
            document.getElementById(`employerSection${this.employerCurrentStep}`).style.display = 'block';
            this.updateEmployerNavigation();
        }
    }

    validateEmployerStep(step) {
        let isValid = true;
        this.clearValidationErrors();

        switch(step) {
            case 1:
                const accountType = document.getElementById('employerAccountType').value;
                const email = document.getElementById('employerEmail').value;
                const password = document.getElementById('employerPassword').value;
                const confirmPassword = document.getElementById('employerConfirmPassword').value;
                
                if (!accountType) {
                    this.showValidationError('employerAccountType', 'لطفاً نوع شخصیت را انتخاب کنید');
                    isValid = false;
                }
                
                if (!email || !this.isValidEmail(email)) {
                    this.showValidationError('employerEmail', 'لطفاً ایمیل معتبر وارد کنید');
                    isValid = false;
                }
                
                if (!password) {
                    this.showValidationError('employerPassword', 'لطفاً رمز عبور را وارد کنید');
                    isValid = false;
                }
                
                if (!confirmPassword) {
                    this.showValidationError('employerConfirmPassword', 'لطفاً تکرار رمز عبور را وارد کنید');
                    isValid = false;
                }
                
                if (password && confirmPassword && password !== confirmPassword) {
                    this.showValidationError('employerConfirmPassword', 'رمز عبور و تکرار آن یکسان نیستند');
                    isValid = false;
                }
                
                if (accountType === 'individual') {
                    const fullName = document.getElementById('employerFullName')?.value;
                    const nationalCode = document.getElementById('employerNationalCode')?.value;
                    
                    if (!fullName) {
                        this.showValidationError('employerFullName', 'لطفاً نام و نام خانوادگی را وارد کنید');
                        isValid = false;
                    }
                    
                    if (!nationalCode || nationalCode.length !== 10) {
                        this.showValidationError('employerNationalCode', 'لطفاً کد ملی معتبر وارد کنید');
                        isValid = false;
                    }
                } else if (accountType === 'company') {
                    const companyName = document.getElementById('employerCompanyName')?.value;
                    const managerName = document.getElementById('employerManagerName')?.value;
                    
                    if (!companyName) {
                        this.showValidationError('employerCompanyName', 'لطفاً نام شرکت را وارد کنید');
                        isValid = false;
                    }
                    
                    if (!managerName) {
                        this.showValidationError('employerManagerName', 'لطفاً نام مدیرعامل را وارد کنید');
                        isValid = false;
                    }
                }
                
                if (!isValid) return false;
                break;

            case 2:
                const mobile = document.getElementById('employerMobile').value;
                const address = document.getElementById('employerAddress').value;
                
                if (!mobile || !this.isValidMobile(mobile)) {
                    this.showValidationError('employerMobile', 'لطفاً شماره موبایل معتبر وارد کنید');
                    isValid = false;
                }
                
                if (!address) {
                    this.showValidationError('employerAddress', 'لطفاً آدرس را وارد کنید');
                    isValid = false;
                }
                
                const accType = document.getElementById('employerAccountType').value;
                if (accType === 'company') {
                    const companyId = document.getElementById('employerCompanyId')?.value;
                    const registrationNo = document.getElementById('employerRegistrationNo')?.value;
                    const companyType = document.getElementById('employerCompanyType')?.value;
                    
                    if (!companyId) {
                        this.showValidationError('employerCompanyId', 'لطفاً شناسه ملی شرکت را وارد کنید');
                        isValid = false;
                    }
                    
                    if (!registrationNo) {
                        this.showValidationError('employerRegistrationNo', 'لطفاً شماره ثبت شرکت را وارد کنید');
                        isValid = false;
                    }
                    
                    if (!companyType) {
                        this.showValidationError('employerCompanyType', 'لطفاً نوع فعالیت را انتخاب کنید');
                        isValid = false;
                    }
                }
                
                if (!isValid) return false;
                break;

            case 3:
                const projectTypes = document.querySelectorAll('input[name="projectType"]:checked');
                if (projectTypes.length === 0) {
                    this.showToast('لطفاً حداقل یک نوع پروژه را انتخاب کنید', 'error');
                    isValid = false;
                }
                
                if (!isValid) return false;
                break;
        }
        
        return isValid;
    }

    updateEmployerNavigation() {
        const prevBtn = document.getElementById('employerPrevBtn');
        const nextBtn = document.getElementById('employerNextBtn');
        const submitBtn = document.getElementById('employerSubmitBtn');
        
        if (this.employerCurrentStep === 1) {
            prevBtn.style.display = 'none';
        } else {
            prevBtn.style.display = 'block';
        }
        
        if (this.employerCurrentStep === this.employerTotalSteps) {
            nextBtn.style.display = 'none';
            submitBtn.style.display = 'block';
        } else {
            nextBtn.style.display = 'block';
            submitBtn.style.display = 'none';
        }
    }

    updateEmployerSummary() {
        if (this.employerCurrentStep === 4) {
            const accountType = document.getElementById('employerAccountType').value;
            let name = '';
            let identifier = '';
            
            if (accountType === 'individual') {
                name = document.getElementById('employerFullName')?.value || '-';
                identifier = document.getElementById('employerNationalCode')?.value || '-';
            } else {
                name = document.getElementById('employerCompanyName')?.value || '-';
                identifier = document.getElementById('employerCompanyId')?.value || '-';
            }
            
            const email = document.getElementById('employerEmail')?.value || '-';
            const mobile = document.getElementById('employerMobile')?.value || '-';
            const address = document.getElementById('employerAddress')?.value || '-';
            
            const selectedProjects = [];
            document.querySelectorAll('input[name="projectType"]:checked').forEach(cb => {
                selectedProjects.push(cb.nextElementSibling.textContent);
            });
            
            const summaryHtml = `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>نام:</strong> ${name}</p>
                        <p><strong>${accountType === 'individual' ? 'کد ملی' : 'شناسه ملی'}:</strong> ${identifier}</p>
                        <p><strong>ایمیل:</strong> ${email}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>تلفن همراه:</strong> ${mobile}</p>
                        <p><strong>آدرس:</strong> ${address}</p>
                        <p><strong>نوع پروژه:</strong> ${selectedProjects.join('، ') || '-'}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('employerSummary').innerHTML = summaryHtml;
        }
    }

    async submitEmployerForm(e) {
        e.preventDefault();

        if (!this.validateEmployerStep(this.employerCurrentStep)) {
            return;
        }

        const terms = document.getElementById('employerTerms').checked;
        if (!terms) {
            this.showToast('لطفاً با قوانین و مقررات موافقت کنید.', 'error');
            return;
        }

        const accountType = document.getElementById('employerAccountType').value;
        const email = document.getElementById('employerEmail').value;
        const password = document.getElementById('employerPassword').value;
        const mobile = document.getElementById('employerMobile').value;
        const address = document.getElementById('employerAddress').value;

        const submitBtn = document.getElementById('employerSubmitBtn');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>در حال ثبت‌نام...';
        submitBtn.disabled = true;

        try {
            const { data: authData, error: authError } = await supabase.auth.signUp({
                email,
                password,
                options: {
                    emailRedirectTo: window.location.origin + '/login',
                    data: {
                        user_type: 'employer',
                        account_type: accountType
                    }
                }
            });

            if (authError) {
                console.warn('خطای ثبت‌نام در Auth:', authError);
                
                if (authError.status === 500 || authError.message.includes('confirmation email')) {
                    this.showToast('ثبت‌نام با موفقیت انجام شد!', 'success');
                    
                    const tempUserId = 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
                    
                    let fullName = '';
                    let nationalCode = '';
                    let companyName = '';
                    let companyId = '';
                    
                    if (accountType === 'individual') {
                        fullName = document.getElementById('employerFullName')?.value || 'کاربر';
                        nationalCode = document.getElementById('employerNationalCode')?.value || '0000000000';
                    } else {
                        companyName = document.getElementById('employerCompanyName')?.value || 'شرکت';
                        companyId = document.getElementById('employerCompanyId')?.value || '000000';
                    }
                    
                    const { error: profileError } = await supabase
                        .from('profiles')
                        .insert([{
                            user_id: tempUserId,
                            email: email,
                            user_type: 'employer',
                            account_type: accountType,
                            phone: mobile,
                            address: address,
                            full_name: fullName,
                            national_code: nationalCode,
                            company_name: companyName,
                            company_id: companyId,
                            created_at: new Date().toISOString(),
                            terms_accepted_at: terms ? new Date().toISOString() : null,
                            terms_version: '1.0'
                        }]);

                    if (profileError) {
                        console.error('خطای پروفایل:', profileError);
                    }

                    this.userData = {
                        id: tempUserId,
                        email: email,
                        full_name: fullName || companyName,
                        phone: mobile,
                        user_type: 'employer',
                        account_type: accountType,
                        terms_accepted: true
                    };
                    
                    this.saveUserData(this.userData);

                    setTimeout(() => {
                        this.showPage('home');
                    }, 1500);
                    return;
                } else {
                    throw authError;
                }
            }

            if (!authData || !authData.user) {
                throw new Error('خطا در ثبت‌نام');
            }

            let fullName = '';
            let nationalCode = '';
            let companyName = '';
            let companyId = '';
            
            if (accountType === 'individual') {
                fullName = document.getElementById('employerFullName')?.value || '';
                nationalCode = document.getElementById('employerNationalCode')?.value || '';
            } else {
                companyName = document.getElementById('employerCompanyName')?.value || '';
                companyId = document.getElementById('employerCompanyId')?.value || '';
            }

            const { data: existingProfile } = await supabase
                .from('profiles')
                .select('user_id')
                .eq('user_id', authData.user.id)
                .single();

            if (existingProfile) {
                const { error: updateError } = await supabase
                    .from('profiles')
                    .update({
                        user_type: 'employer',
                        account_type: accountType,
                        phone: mobile,
                        address: address,
                        full_name: fullName,
                        national_code: nationalCode,
                        company_name: companyName,
                        company_id: companyId,
                        terms_accepted_at: terms ? new Date().toISOString() : null,
                        terms_version: '1.0'
                    })
                    .eq('user_id', authData.user.id);

                if (updateError) {
                    console.error('خطا در آپدیت پروفایل:', updateError);
                }
            } else {
                const { error: insertError } = await supabase
                    .from('profiles')
                    .insert([{
                        user_id: authData.user.id,
                        email: email,
                        user_type: 'employer',
                        account_type: accountType,
                        phone: mobile,
                        address: address,
                        full_name: fullName,
                        national_code: nationalCode,
                        company_name: companyName,
                        company_id: companyId,
                        created_at: new Date().toISOString(),
                        terms_accepted_at: terms ? new Date().toISOString() : null,
                        terms_version: '1.0'
                    }]);

                if (insertError) {
                    console.error('خطا در ایجاد پروفایل:', insertError);
                }
            }

            this.showToast('ثبت‌نام کارفرما با موفقیت انجام شد!', 'success');

            this.userData = {
                id: authData.user.id,
                email: email,
                full_name: fullName || companyName,
                phone: mobile,
                user_type: 'employer',
                account_type: accountType,
                terms_accepted: true
            };
            
            this.saveUserData(this.userData);

            setTimeout(() => {
                this.showPage('home');
            }, 1500);

        } catch (error) {
            console.error('خطای ثبت‌نام:', error);
            this.showToast('خطا در ثبت‌نام: ' + error.message, 'error');
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    }

    // =================================================================
    // توابع فرم پیمانکار
    // =================================================================
    setupContractorForm() {
        this.populateYearSelect('startYear', 1350, 1403);
        document.getElementById('accountType').addEventListener('change', () => this.updateContractorFields());
        document.getElementById('mainExpertise').addEventListener('change', () => this.updateSubExpertise());
        document.getElementById('workArea').addEventListener('change', (e) => this.handleWorkAreaSelection(e));
        document.getElementById('radius').addEventListener('input', (e) => {
            document.getElementById('radiusValue').textContent = e.target.value + ' کیلومتر';
        });
        document.getElementById('areaUnit').addEventListener('change', () => this.updateAreaUnitLabel());
        document.getElementById('docUploadArea').addEventListener('click', () => {
            document.getElementById('documentUpload').click();
        });
        document.getElementById('documentUpload').addEventListener('change', (e) => this.handleFileUpload(e));
        document.getElementById('addProject').addEventListener('click', () => this.addProject());
        document.getElementById('insurance').addEventListener('change', (e) => {
            const expiryField = document.getElementById('insuranceExpiryField');
            if (e.target.value === 'yes') {
                expiryField.style.display = 'block';
                expiryField.classList.add('show');
            } else {
                expiryField.style.display = 'none';
                expiryField.classList.remove('show');
            }
        });
        document.getElementById('nextBtn').addEventListener('click', () => this.nextContractorStep());
        document.getElementById('prevBtn').addEventListener('click', () => this.prevContractorStep());
        document.getElementById('contractorForm').addEventListener('submit', (e) => this.submitContractorForm(e));
        this.updateContractorFields();
        this.updateContractorNavigation();
    }

    updateContractorFields() {
        const accountType = document.getElementById('accountType').value;
        const dynamicFields = document.getElementById('dynamicFields');
        if (!dynamicFields) return;
        
        dynamicFields.innerHTML = '';
        
        if (accountType === 'individual') {
            dynamicFields.innerHTML = `
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="fullName" class="form-label required">نام و نام خانوادگی</label>
                        <input type="text" class="form-control" id="fullName" required>
                        <div class="invalid-feedback">لطفاً نام و نام خانوادگی را وارد کنید</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="nationalCode" class="form-label required">کد ملی</label>
                        <input type="text" class="form-control" id="nationalCode" required maxlength="10">
                        <div class="invalid-feedback">لطفاً کد ملی معتبر وارد کنید</div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="contractorEmail" class="form-label required">ایمیل</label>
                        <input type="email" class="form-control" id="contractorEmail" required>
                        <div class="invalid-feedback">لطفاً ایمیل معتبر وارد کنید</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="contractorPassword" class="form-label required">رمز عبور</label>
                        <input type="password" class="form-control" id="contractorPassword" required>
                        <div class="invalid-feedback">لطفاً رمز عبور را وارد کنید</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="contractorConfirmPassword" class="form-label required">تکرار رمز عبور</label>
                        <input type="password" class="form-control" id="contractorConfirmPassword" required>
                        <div class="invalid-feedback" id="contractorConfirmFeedback"></div>
                    </div>
                </div>
            `;
        } else if (accountType === 'company') {
            dynamicFields.innerHTML = `
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="companyName" class="form-label required">نام شرکت/مؤسسه</label>
                        <input type="text" class="form-control" id="companyName" required>
                        <div class="invalid-feedback">لطفاً نام شرکت را وارد کنید</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="companyId" class="form-label required">شناسه ملی شرکت</label>
                        <input type="text" class="form-control" id="companyId" required>
                        <div class="invalid-feedback">لطفاً شناسه ملی شرکت را وارد کنید</div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="contractorEmail" class="form-label required">ایمیل</label>
                        <input type="email" class="form-control" id="contractorEmail" required>
                        <div class="invalid-feedback">لطفاً ایمیل معتبر وارد کنید</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="contractorPassword" class="form-label required">رمز عبور</label>
                        <input type="password" class="form-control" id="contractorPassword" required>
                        <div class="invalid-feedback">لطفاً رمز عبور را وارد کنید</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="contractorConfirmPassword" class="form-label required">تکرار رمز عبور</label>
                        <input type="password" class="form-control" id="contractorConfirmPassword" required>
                        <div class="invalid-feedback">لطفاً تکرار رمز عبور را وارد کنید</div>
                    </div>
                </div>
            `;
        }
    }

    updateSubExpertise() {
        const mainExpertise = document.getElementById('mainExpertise').value;
        const subContainer = document.getElementById('subExpertiseContainer');
        if (!subContainer) return;

        const subExpertises = {
            'steel_fabrication': ['ساخت اسکلت فلزی صنعتی', 'ساخت اسکلت فلزی ساختمانی', 'ساخت سوله', 'ساخت پایپرک'],
            'steel_installation': ['نصاب سوله', 'نصاب اسکلت فلزی ساختمانی', 'نصاب سازه های صنعتی', 'نصاب پایپرک', 'نصاب هندریل و لدر', 'نصاب کارهای سبک'],
            'formwork': ['قالب های مدولار', 'قالب های خاص', 'قالب تونلفرم', 'اکیپ ساخت قالب تونلفرم'],
            'concrete_execution': [],
            'support_teams': ['اکیپ نقشه برداری', 'اکیپ کنترل کیفیت', 'اکیپ ایمنی صنعتی']
        };

        if (mainExpertise && subExpertises[mainExpertise]) {
            const subs = subExpertises[mainExpertise];
            if (subs && subs.length > 0) {
                let html = '<div class="row g-2">';
                subs.forEach((sub, index) => {
                    html += `
                        <div class="col-12 col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="subExpertise${index}" value="${sub}">
                                <label class="form-check-label" for="subExpertise${index}">${sub}</label>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                subContainer.innerHTML = html;
            } else {
                subContainer.innerHTML = '<div class="form-text">این تخصص زیرحوزه‌ای ندارد.</div>';
            }
        } else {
            subContainer.innerHTML = '<div class="form-text">برای مشاهده زیرحوزه‌ها، ابتدا تخصص اصلی را انتخاب کنید.</div>';
        }
    }

    updateAreaUnitLabel() {
        const areaUnit = document.getElementById('areaUnit').value;
        const formText = document.querySelector('.project-scale-row .form-text');
        if (formText) {
            if (areaUnit === 'sqm') {
                formText.textContent = 'برای پروژه‌های ساختمانی و کابینت';
            } else {
                formText.textContent = 'برای پروژه‌های حجمی و بتنی';
            }
        }
    }

    handleWorkAreaSelection(e) {
        const select = e.target;
        const options = Array.from(select.options);
        const allOption = options.find(opt => opt.value === 'all');
        
        if (allOption && allOption.selected) {
            options.forEach(opt => {
                if (opt.value !== 'all') {
                    opt.selected = false;
                    opt.disabled = true;
                }
            });
        } else {
            if (allOption) {
                allOption.selected = false;
                allOption.disabled = true;
            }
        }
    }

    handleFileUpload(e) {
        const files = e.target.files;
        const fileList = document.getElementById('fileList');
        
        if (files.length > 5) {
            this.showToast('حداکثر ۵ فایل می‌توانید آپلود کنید.', 'error');
            return;
        }
        
        fileList.innerHTML = '';
        Array.from(files).forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'd-flex align-items-center justify-content-between mb-2 p-2 bg-light rounded';
            fileItem.innerHTML = `
                <div>
                    <i class="bi bi-file-earmark-text me-2"></i>
                    <span>${file.name}</span>
                    <small class="text-muted ms-2">(${(file.size / 1024).toFixed(1)} KB)</small>
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="app.removeFile(${index})">
                    <i class="bi bi-trash"></i>
                </button>
            `;
            fileList.appendChild(fileItem);
        });
        
        this.showAutoSaveStatus('مدارک با موفقیت آپلود شدند.', 'success');
    }

    removeFile(index) {
        const input = document.getElementById('documentUpload');
        const files = Array.from(input.files);
        files.splice(index, 1);
        const dt = new DataTransfer();
        files.forEach(file => dt.items.add(file));
        input.files = dt.files;
        this.handleFileUpload({ target: input });
    }

    addProject() {
        const container = document.getElementById('projectContainer');
        const projectCount = container.children.length + 1;
        
        if (projectCount > 5) {
            this.showToast('حداکثر ۵ پروژه می‌توانید اضافه کنید.', 'error');
            return;
        }
        
        const projectDiv = document.createElement('div');
        projectDiv.className = 'card mb-3 project-card';
        projectDiv.innerHTML = `
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="card-title mb-0">پروژه نمونه ${projectCount}</h6>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="app.removeProject(this)">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">نام پروژه</label>
                        <input type="text" class="form-control" name="projectName[]">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">سال تحویل (شمسی)</label>
                        <select class="form-select" name="projectYear[]">
                            <option value="">-- انتخاب سال --</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">مشتری</label>
                        <input type="text" class="form-control" name="projectClient[]" placeholder="نام شرکت یا شخص">
                    </div>
                    <div class="col-12 mb-3">
                        <label class="form-label">تصویر پروژه (حداکثر ۱ تصویر)</label>
                        <input type="file" class="form-control" name="projectImage[]" accept="image/*">
                    </div>
                </div>
            </div>
        `;
        
        container.appendChild(projectDiv);
        
        const yearSelect = projectDiv.querySelector('select[name="projectYear[]"]');
        this.populateProjectYearSelect(yearSelect);
        
        this.showAutoSaveStatus('پروژه جدید اضافه شد.', 'success');
    }

    removeProject(button) {
        const projectCard = button.closest('.project-card');
        const container = document.getElementById('projectContainer');
        
        if (container.children.length > 1) {
            projectCard.remove();
            this.showAutoSaveStatus('پروژه حذف شد.', 'success');
        } else {
            this.showToast('حداقل یک پروژه باید وجود داشته باشد.', 'error');
        }
    }

    nextContractorStep() {
        if (this.validateContractorStep(this.contractorCurrentStep)) {
            if (this.contractorCurrentStep < this.contractorTotalSteps) {
                document.getElementById(`section${this.contractorCurrentStep}`).style.display = 'none';
                this.contractorCurrentStep++;
                document.getElementById(`section${this.contractorCurrentStep}`).style.display = 'block';
                this.updateProgressBar();
                this.updateStepIndicator();
                this.updateContractorNavigation();
                if (this.contractorCurrentStep === this.contractorTotalSteps) {
                    this.updateContractorSummary();
                }
            }
        }
    }

    prevContractorStep() {
        if (this.contractorCurrentStep > 1) {
            document.getElementById(`section${this.contractorCurrentStep}`).style.display = 'none';
            this.contractorCurrentStep--;
            document.getElementById(`section${this.contractorCurrentStep}`).style.display = 'block';
            this.updateProgressBar();
            this.updateStepIndicator();
            this.updateContractorNavigation();
        }
    }

    validateContractorStep(step) {
        let isValid = true;
        this.clearValidationErrors();

        switch(step) {
            case 1:
                const accountType = document.getElementById('accountType').value;
                const contactPerson = document.getElementById('contactPerson').value;
                const mobile = document.getElementById('mobile').value;
                const email = document.getElementById('contractorEmail').value;
                const password = document.getElementById('contractorPassword').value;
                const confirmPassword = document.getElementById('contractorConfirmPassword').value;
                
                if (!accountType) {
                    this.showValidationError('accountType', 'لطفاً نوع شخصیت را انتخاب کنید');
                    isValid = false;
                }
                
                if (!contactPerson) {
                    this.showValidationError('contactPerson', 'لطفاً نام مسئول ارتباط را وارد کنید');
                    isValid = false;
                }
                
                if (!mobile || !this.isValidMobile(mobile)) {
                    this.showValidationError('mobile', 'لطفاً شماره موبایل معتبر وارد کنید');
                    isValid = false;
                }
                
                if (!email || !this.isValidEmail(email)) {
                    this.showValidationError('contractorEmail', 'لطفاً ایمیل معتبر وارد کنید');
                    isValid = false;
                }
                
                if (!password) {
                    this.showValidationError('contractorPassword', 'لطفاً رمز عبور را وارد کنید');
                    isValid = false;
                }
                
                if (!confirmPassword) {
                    this.showValidationError('contractorConfirmPassword', 'لطفاً تکرار رمز عبور را وارد کنید');
                    isValid = false;
                }
                
                if (password && confirmPassword && password !== confirmPassword) {
                    this.showValidationError('contractorConfirmPassword', 'رمز عبور و تکرار آن یکسان نیستند');
                    isValid = false;
                }
                
                if (accountType === 'individual') {
                    const fullName = document.getElementById('fullName')?.value;
                    const nationalCode = document.getElementById('nationalCode')?.value;
                    
                    if (!fullName) {
                        this.showValidationError('fullName', 'لطفاً نام و نام خانوادگی را وارد کنید');
                        isValid = false;
                    }
                    
                    if (!nationalCode || nationalCode.length !== 10) {
                        this.showValidationError('nationalCode', 'لطفاً کد ملی معتبر وارد کنید');
                        isValid = false;
                    }
                } else if (accountType === 'company') {
                    const companyName = document.getElementById('companyName')?.value;
                    const companyId = document.getElementById('companyId')?.value;
                    
                    if (!companyName) {
                        this.showValidationError('companyName', 'لطفاً نام شرکت را وارد کنید');
                        isValid = false;
                    }
                    
                    if (!companyId) {
                        this.showValidationError('companyId', 'لطفاً شناسه ملی شرکت را وارد کنید');
                        isValid = false;
                    }
                }
                
                if (!isValid) return false;
                break;

            case 2:
                const mainExpertise = document.getElementById('mainExpertise').value;
                const workArea = document.getElementById('workArea');
                const selectedAreas = Array.from(workArea.selectedOptions).map(opt => opt.value);
                
                if (!mainExpertise) {
                    this.showValidationError('mainExpertise', 'لطفاً تخصص اصلی را انتخاب کنید');
                    isValid = false;
                }
                
                if (selectedAreas.length === 0) {
                    this.showToast('لطفاً حداقل یک محدوده جغرافیایی انتخاب کنید', 'error');
                    isValid = false;
                }
                
                const projectArea = document.getElementById('projectArea')?.value;
                const projectWeight = document.getElementById('projectWeight')?.value;
                
                if (!projectArea && !projectWeight) {
                    this.showToast('لطفاً حداقل یکی از فیلدهای متراژ یا وزن را پر کنید', 'error');
                    isValid = false;
                }
                
                if (!isValid) return false;
                break;
                
            case 3:
                const startYear = document.getElementById('startYear').value;
                if (!startYear) {
                    this.showValidationError('startYear', 'لطفاً سال آغاز فعالیت را انتخاب کنید');
                    isValid = false;
                }
                
                if (!isValid) return false;
                break;
                
            case 4:
                const projectCount = document.querySelectorAll('.project-card').length;
                if (projectCount < 2) {
                    this.showToast('لطفاً حداقل ۲ پروژه نمونه وارد کنید', 'error');
                    isValid = false;
                }
                
                if (!isValid) return false;
                break;
        }
        
        return isValid;
    }

    updateProgressBar() {
        const progress = (this.contractorCurrentStep / this.contractorTotalSteps) * 100;
        document.getElementById('progressBarFill').style.width = progress + '%';
        document.getElementById('progressBarFill').setAttribute('aria-valuenow', progress);
    }

    updateStepIndicator() {
        for (let i = 1; i <= this.contractorTotalSteps; i++) {
            const step = document.getElementById(`step${i}`);
            if (i <= this.contractorCurrentStep) {
                step.classList.add('active');
            } else {
                step.classList.remove('active');
            }
        }
    }

    updateContractorNavigation() {
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const submitBtn = document.getElementById('submitBtn');
        
        if (this.contractorCurrentStep === 1) {
            prevBtn.style.display = 'none';
        } else {
            prevBtn.style.display = 'block';
        }
        
        if (this.contractorCurrentStep === this.contractorTotalSteps) {
            nextBtn.style.display = 'none';
            submitBtn.style.display = 'block';
        } else {
            nextBtn.style.display = 'block';
            submitBtn.style.display = 'none';
        }
    }

    updateContractorSummary() {
        const accountType = document.getElementById('accountType').value;
        let name = '';
        
        if (accountType === 'individual') {
            name = document.getElementById('fullName')?.value || '-';
        } else {
            name = document.getElementById('companyName')?.value || '-';
        }
        
        const contactPerson = document.getElementById('contactPerson')?.value || '-';
        const mainExpertise = document.getElementById('mainExpertise')?.options[document.getElementById('mainExpertise').selectedIndex]?.text || '-';
        const startYear = document.getElementById('startYear')?.value || '-';
        const teamSize = document.getElementById('teamSize')?.value || '-';
        
        const workAreaSelect = document.getElementById('workArea');
        const selectedAreas = Array.from(workAreaSelect.selectedOptions).map(opt => opt.text);
        const workAreas = selectedAreas.length > 0 ? selectedAreas.join('، ') : '-';
        
        const areaValue = document.getElementById('projectArea')?.value || '-';
        const areaUnit = document.getElementById('areaUnit')?.value === 'sqm' ? 'متر مربع' : 'متر مکعب';
        const weightValue = document.getElementById('projectWeight')?.value || '-';
        
        const summaryHtml = `
            <div class="row">
                <div class="col-md-6">
                    <p><strong>نام ${accountType === 'individual' ? 'پیمانکار' : 'شرکت'}:</strong> ${name}</p>
                    <p><strong>مسئول ارتباط:</strong> ${contactPerson}</p>
                    <p><strong>تخصص اصلی:</strong> ${mainExpertise}</p>
                    <p><strong>سال شروع فعالیت:</strong> ${startYear}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>تعداد نیرو:</strong> ${teamSize} نفر</p>
                    <p><strong>محدوده فعالیت:</strong> ${workAreas}</p>
                    <p><strong>مقیاس پروژه:</strong> ${areaValue !== '-' ? areaValue + ' ' + areaUnit + ' در ماه' : ''} ${weightValue !== '-' ? weightValue + ' تن در ماه' : ''}</p>
                    <p><strong>نوع شخصیت:</strong> ${accountType === 'individual' ? 'شخص حقیقی' : 'شرکت'}</p>
                </div>
            </div>
        `;
        
        document.getElementById('summaryContent').innerHTML = summaryHtml;
        document.getElementById('formSummary').style.display = 'block';
    }

    async submitContractorForm(e) {
        e.preventDefault();

        if (!this.validateContractorStep(this.contractorCurrentStep)) {
            return;
        }

        const terms = document.getElementById('contractorTerms').checked;
        if (!terms) {
            this.showToast('لطفاً با قوانین و مقررات موافقت کنید.', 'error');
            return;
        }

        const accountType = document.getElementById('accountType').value;
        const email = document.getElementById('contractorEmail').value;
        const password = document.getElementById('contractorPassword').value;
        const mobile = document.getElementById('mobile').value;
        const contactPerson = document.getElementById('contactPerson').value;
        const mainExpertise = document.getElementById('mainExpertise').value;
        const phone = document.getElementById('phone')?.value || '';

        const submitBtn = document.getElementById('submitBtn');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>در حال ثبت‌نام...';
        submitBtn.disabled = true;

        try {
            const { data: authData, error: authError } = await supabase.auth.signUp({
                email,
                password,
                options: {
                    emailRedirectTo: window.location.origin + '/login',
                    data: {
                        user_type: 'contractor',
                        account_type: accountType
                    }
                }
            });

            if (authError) {
                console.warn('خطای ثبت‌نام در Auth:', authError);
                
                if (authError.status === 500 || authError.message.includes('confirmation email')) {
                    this.showToast('ثبت‌نام با موفقیت انجام شد!', 'success');
                    
                    const tempUserId = 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
                    
                    let fullName = '';
                    let nationalCode = '';
                    let companyName = '';
                    let companyId = '';
                    
                    if (accountType === 'individual') {
                        fullName = document.getElementById('fullName')?.value || 'کاربر';
                        nationalCode = document.getElementById('nationalCode')?.value || '0000000000';
                    } else {
                        companyName = document.getElementById('companyName')?.value || 'شرکت';
                        companyId = document.getElementById('companyId')?.value || '000000';
                    }
                    
                    const profileData = {
                        user_id: tempUserId,
                        email: email,
                        user_type: 'contractor',
                        account_type: accountType,
                        phone: mobile,
                        landline: phone,
                        contact_person: contactPerson,
                        main_expertise: mainExpertise,
                        full_name: fullName,
                        national_code: nationalCode,
                        company_name: companyName,
                        company_id: companyId,
                        verification_status: 'pending',
                        trust_level: 1,
                        created_at: new Date().toISOString(),
                        terms_accepted_at: terms ? new Date().toISOString() : null,
                        terms_version: '1.0'
                    };

                    const projectArea = document.getElementById('projectArea')?.value;
                    const projectWeight = document.getElementById('projectWeight')?.value;
                    const areaUnit = document.getElementById('areaUnit')?.value;
                    
                    if (projectArea) {
                        profileData.project_area = parseInt(projectArea);
                        profileData.area_unit = areaUnit;
                    }
                    if (projectWeight) {
                        profileData.project_weight = parseInt(projectWeight);
                    }

                    const workAreaSelect = document.getElementById('workArea');
                    const selectedAreas = Array.from(workAreaSelect.selectedOptions).map(opt => opt.value);
                    if (selectedAreas.length > 0) {
                        profileData.work_area = selectedAreas;
                    }

                    const radius = document.getElementById('radius')?.value;
                    if (radius) {
                        profileData.work_radius = parseInt(radius);
                    }

                    const subExpertiseCheckboxes = document.querySelectorAll('input[id^="subExpertise"]:checked');
                    if (subExpertiseCheckboxes.length > 0) {
                        const subExpertises = Array.from(subExpertiseCheckboxes).map(cb => cb.value);
                        profileData.sub_expertise = subExpertises;
                    }

                    const startYear = document.getElementById('startYear')?.value;
                    if (startYear) {
                        profileData.start_year = parseInt(startYear);
                    }

                    const teamSize = document.getElementById('teamSize')?.value;
                    if (teamSize) {
                        profileData.team_size = parseInt(teamSize);
                    }

                    const equipment = document.getElementById('equipment')?.value;
                    if (equipment) {
                        profileData.equipment = equipment;
                    }

                    const contractMethod = document.getElementById('contractMethod')?.value;
                    if (contractMethod) {
                        profileData.contract_method = contractMethod;
                    }

                    const insurance = document.getElementById('insurance')?.value;
                    if (insurance) {
                        profileData.insurance = insurance;
                        if (insurance === 'yes') {
                            const insuranceExpiry = document.getElementById('insuranceExpiry')?.value;
                            if (insuranceExpiry) {
                                profileData.insurance_expiry = insuranceExpiry;
                            }
                        }
                    }

                    const { error: profileError } = await supabase
                        .from('profiles')
                        .insert([profileData]);

                    if (profileError) {
                        console.error('خطای پروفایل:', profileError);
                    }

                    this.userData = {
                        id: tempUserId,
                        email: email,
                        full_name: fullName || companyName,
                        phone: mobile,
                        user_type: 'contractor',
                        account_type: accountType,
                        terms_accepted: true
                    };
                    
                    this.saveUserData(this.userData);

                    setTimeout(() => {
                        this.showPage('home');
                    }, 1500);
                    return;
                } else {
                    throw authError;
                }
            }

            if (!authData || !authData.user) {
                throw new Error('خطا در ثبت‌نام');
            }

            let fullName = '';
            let nationalCode = '';
            let companyName = '';
            let companyId = '';
            
            if (accountType === 'individual') {
                fullName = document.getElementById('fullName')?.value || '';
                nationalCode = document.getElementById('nationalCode')?.value || '';
            } else {
                companyName = document.getElementById('companyName')?.value || '';
                companyId = document.getElementById('companyId')?.value || '';
            }

            const profileData = {
                user_type: 'contractor',
                account_type: accountType,
                phone: mobile,
                landline: phone,
                contact_person: contactPerson,
                main_expertise: mainExpertise,
                full_name: fullName,
                national_code: nationalCode,
                company_name: companyName,
                company_id: companyId,
                verification_status: 'pending',
                trust_level: 1,
                terms_accepted_at: terms ? new Date().toISOString() : null,
                terms_version: '1.0'
            };

            const projectArea = document.getElementById('projectArea')?.value;
            const projectWeight = document.getElementById('projectWeight')?.value;
            const areaUnit = document.getElementById('areaUnit')?.value;
            
            if (projectArea) {
                profileData.project_area = parseInt(projectArea);
                profileData.area_unit = areaUnit;
            }
            if (projectWeight) {
                profileData.project_weight = parseInt(projectWeight);
            }

            const workAreaSelect = document.getElementById('workArea');
            const selectedAreas = Array.from(workAreaSelect.selectedOptions).map(opt => opt.value);
            if (selectedAreas.length > 0) {
                profileData.work_area = selectedAreas;
            }

            const radius = document.getElementById('radius')?.value;
            if (radius) {
                profileData.work_radius = parseInt(radius);
            }

            const subExpertiseCheckboxes = document.querySelectorAll('input[id^="subExpertise"]:checked');
            if (subExpertiseCheckboxes.length > 0) {
                const subExpertises = Array.from(subExpertiseCheckboxes).map(cb => cb.value);
                profileData.sub_expertise = subExpertises;
            }

            const startYear = document.getElementById('startYear')?.value;
            if (startYear) {
                profileData.start_year = parseInt(startYear);
            }

            const teamSize = document.getElementById('teamSize')?.value;
            if (teamSize) {
                profileData.team_size = parseInt(teamSize);
            }

            const equipment = document.getElementById('equipment')?.value;
            if (equipment) {
                profileData.equipment = equipment;
            }

            const contractMethod = document.getElementById('contractMethod')?.value;
            if (contractMethod) {
                profileData.contract_method = contractMethod;
            }

            const insurance = document.getElementById('insurance')?.value;
            if (insurance) {
                profileData.insurance = insurance;
                if (insurance === 'yes') {
                    const insuranceExpiry = document.getElementById('insuranceExpiry')?.value;
                    if (insuranceExpiry) {
                        profileData.insurance_expiry = insuranceExpiry;
                    }
                }
            }

            const { data: existingProfile } = await supabase
                .from('profiles')
                .select('user_id')
                .eq('user_id', authData.user.id)
                .single();

            if (existingProfile) {
                const { error: updateError } = await supabase
                    .from('profiles')
                    .update(profileData)
                    .eq('user_id', authData.user.id);

                if (updateError) {
                    console.error('خطا در آپدیت پروفایل:', updateError);
                }
            } else {
                const { error: insertError } = await supabase
                    .from('profiles')
                    .insert([{
                        user_id: authData.user.id,
                        email: email,
                        ...profileData,
                        created_at: new Date().toISOString()
                    }]);

                if (insertError) {
                    console.error('خطا در ایجاد پروفایل:', insertError);
                }
            }

            this.showToast('ثبت‌نام پیمانکار با موفقیت انجام شد!', 'success');

            this.userData = {
                id: authData.user.id,
                email: email,
                full_name: fullName || companyName,
                phone: mobile,
                user_type: 'contractor',
                account_type: accountType,
                terms_accepted: true
            };
            
            this.saveUserData(this.userData);

            setTimeout(() => {
                this.showPage('home');
            }, 1500);

        } catch (error) {
            console.error('خطای ثبت‌نام:', error);
            this.showToast('خطا در ثبت‌نام: ' + error.message, 'error');
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    }

    populateYearSelect(selectId, startYear, endYear) {
        let selectElement;
        if (typeof selectId === 'string') {
            selectElement = document.getElementById(selectId);
        } else {
            selectElement = selectId;
        }
        if (!selectElement) return;
        
        while (selectElement.options.length > 1) {
            selectElement.remove(1);
        }
        
        for (let year = endYear; year >= startYear; year--) {
            const option = document.createElement('option');
            option.value = year;
            option.text = year;
            selectElement.appendChild(option);
        }
    }

    populateProjectYearSelect(selectElement) {
        if (!selectElement) return;
        
        while (selectElement.options.length > 1) {
            selectElement.remove(1);
        }
        
        for (let year = 1403; year >= 1380; year--) {
            const option = document.createElement('option');
            option.value = year;
            option.text = year;
            selectElement.appendChild(option);
        }
    }

    showAutoSaveStatus(message, type = 'success') {
        const statusElement = document.getElementById('autoSaveStatus');
        if (statusElement) {
            statusElement.textContent = '✓ ' + message;
            statusElement.className = `auto-save-status ${type}`;
            setTimeout(() => {
                statusElement.textContent = '';
                statusElement.className = 'auto-save-status';
            }, 3000);
        }
    }

    setupPasswordValidation() {
        const employerPassword = document.getElementById('employerPassword');
        const employerConfirm = document.getElementById('employerConfirmPassword');
        
        if (employerPassword && employerConfirm) {
            const checkEmployerMatch = () => {
                if (employerConfirm.value && employerPassword.value !== employerConfirm.value) {
                    employerConfirm.classList.add('is-invalid');
                    let feedback = document.getElementById('employerConfirmFeedback');
                    if (!feedback) {
                        feedback = document.createElement('div');
                        feedback.id = 'employerConfirmFeedback';
                        feedback.className = 'invalid-feedback';
                        employerConfirm.parentNode.appendChild(feedback);
                    }
                    feedback.textContent = 'رمز عبور و تکرار آن یکسان نیستند';
                    feedback.style.display = 'block';
                } else {
                    employerConfirm.classList.remove('is-invalid');
                    const feedback = document.getElementById('employerConfirmFeedback');
                    if (feedback) feedback.style.display = 'none';
                }
            };
            
            employerPassword.addEventListener('keyup', checkEmployerMatch);
            employerConfirm.addEventListener('keyup', checkEmployerMatch);
        }
        
        const contractorPassword = document.getElementById('contractorPassword');
        const contractorConfirm = document.getElementById('contractorConfirmPassword');
        
        if (contractorPassword && contractorConfirm) {
            const checkContractorMatch = () => {
                if (contractorConfirm.value && contractorPassword.value !== contractorConfirm.value) {
                    contractorConfirm.classList.add('is-invalid');
                    let feedback = document.getElementById('contractorConfirmFeedback');
                    if (!feedback) {
                        feedback = document.createElement('div');
                        feedback.id = 'contractorConfirmFeedback';
                        feedback.className = 'invalid-feedback';
                        contractorConfirm.parentNode.appendChild(feedback);
                    }
                    feedback.textContent = 'رمز عبور و تکرار آن یکسان نیستند';
                    feedback.style.display = 'block';
                } else {
                    contractorConfirm.classList.remove('is-invalid');
                    const feedback = document.getElementById('contractorConfirmFeedback');
                    if (feedback) feedback.style.display = 'none';
                }
            };
            
            contractorPassword.addEventListener('keyup', checkContractorMatch);
            contractorConfirm.addEventListener('keyup', checkContractorMatch);
        }
    }

    // =================================================================
    // توابع لاگین و احراز هویت
    // =================================================================
    setupLoginForms() {
        const loginForm = document.getElementById('loginForm');
        if (loginForm) {
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                this.handleLogin();
            });
        }
        
        const forgotForm = document.getElementById('forgotPasswordForm');
        if (forgotForm) {
            forgotForm.addEventListener('submit', (e) => {
                e.preventDefault();
                this.handleForgotPassword();
            });
        }
    }

    async handleLogin() {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;

        try {
            const { data, error } = await supabase.auth.signInWithPassword({
                email, password
            });
            
            if (error) throw error;

            const { data: profile, error: profileError } = await supabase
                .from('profiles')
                .select('*')
                .eq('user_id', data.user.id)
                .single();

            if (profileError && profileError.code !== 'PGRST116') {
                console.error('خطا در دریافت پروفایل:', profileError);
            }

            this.userData = {
                id: data.user.id,
                email: data.user.email,
                full_name: profile?.full_name || profile?.company_name || 'کاربر',
                phone: profile?.phone || '',
                company_name: profile?.company_name || '',
                address: profile?.address || '',
                user_type: profile?.user_type || 'employer',
                account_type: profile?.account_type || 'individual'
            };
            
            localStorage.setItem('peymanyar_user', JSON.stringify(this.userData));
            this.showToast('ورود موفقیت‌آمیز بود', 'success');
            this.showPage('home');
            this.checkAdminStatus();
        } catch (error) {
            this.showToast('ایمیل یا رمز عبور اشتباه است', 'error');
        }
    }

    handleForgotPassword() {
        const email = document.getElementById('forgotEmail')?.value || '';
        if (!email) {
            this.showToast('لطفاً ایمیل خود را وارد کنید', 'error');
            return;
        }
        this.showToast(`لینک بازیابی به ${email} ارسال شد`, 'success');
        setTimeout(() => {
            this.showPage('login');
        }, 2000);
    }

    togglePasswordVisibility(id) {
        const input = document.getElementById(id);
        if (input.type === 'password') {
            input.type = 'text';
        } else {
            input.type = 'password';
        }
    }

    async logout() {
        await supabase.auth.signOut();
        this.userData = null;
        localStorage.removeItem('peymanyar_user');
        this.showPage('home');
        this.showToast('با موفقیت خارج شدید', 'success');
    }

    saveUserData(data) {
        this.userData = data;
        localStorage.setItem('peymanyar_user', JSON.stringify(data));
        console.log('User data saved:', data);
    }

    loadUserData() {
        const saved = localStorage.getItem('peymanyar_user');
        if (saved) {
            try {
                this.userData = JSON.parse(saved);
                console.log('User data loaded:', this.userData);
            } catch (e) {
                console.error('خطا در لود user data:', e);
                this.userData = null;
                localStorage.removeItem('peymanyar_user');
            }
        } else {
            console.log('No user data found in localStorage');
            this.userData = null;
        }
    }

    syncUserData() {
        if (this.userData) {
            localStorage.setItem('peymanyar_user', JSON.stringify(this.userData));
        } else {
            localStorage.removeItem('peymanyar_user');
        }
    }

    // =================================================================
    // توابع دستیار هوشمند
    // =================================================================
    setupAssistant() {
        this.loadAssistantMessages();
        this.setupAssistantEvents();
    }

    setupAssistantEvents() {
        const input = document.getElementById('assistantInput');
        if (input) {
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') this.sendAssistantMessage();
            });
        }
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const assistantWindow = document.getElementById('assistantWindow');
                if (assistantWindow && assistantWindow.classList.contains('active')) {
                    this.toggleAssistant();
                }
            }
        });
    }

    toggleAssistant() {
        const assistantWindow = document.getElementById('assistantWindow');
        const toggleBtn = document.querySelector('.assistant-toggle');
        
        if (assistantWindow.classList.contains('active')) {
            assistantWindow.classList.remove('active');
            assistantWindow.setAttribute('aria-hidden', 'true');
            toggleBtn.setAttribute('aria-expanded', 'false');
        } else {
            assistantWindow.classList.add('active');
            assistantWindow.setAttribute('aria-hidden', 'false');
            toggleBtn.setAttribute('aria-expanded', 'true');
            this.markAssistantAsRead();
            setTimeout(() => {
                document.getElementById('assistantInput')?.focus();
            }, 100);
        }
    }

    sendAssistantMessage() {
        const input = document.getElementById('assistantInput');
        const message = input.value.trim();
        if (!message) return;
        
        this.addAssistantMessage('user', message);
        input.value = '';
        
        setTimeout(() => {
            this.generateAssistantResponse(message);
        }, 1000);
    }

    addAssistantMessage(role, content) {
        const container = document.getElementById('assistantMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role}`;
        messageDiv.innerHTML = `<div class="message-bubble">${this.sanitizeHTML(content)}</div>`;
        container.appendChild(messageDiv);
        container.scrollTop = container.scrollHeight;
        this.assistantMessages.push({ role, content, timestamp: new Date().toISOString() });
        this.saveAssistantMessages();
    }

    generateAssistantResponse(userMessage) {
        const responses = {
            'ثبت نام': 'برای ثبت‌نام می‌توانید از منوی بالا روی دکمه "ثبت‌نام کارفرما" یا "ثبت‌نام پیمانکار" کلیک کنید.',
            'ثبت‌نام': 'برای ثبت‌نام می‌توانید از منوی بالا روی دکمه "ثبت‌نام کارفرما" یا "ثبت‌نام پیمانکار" کلیک کنید.',
            'پیمانکار': 'برای جستجوی پیمانکار می‌توانید به صفحه "جستجوی پیمانکار" مراجعه کنید.',
            'جستجو': 'برای جستجوی پیمانکار می‌توانید به صفحه "جستجوی پیمانکار" مراجعه کنید.',
            'قیمت': 'ثبت‌نام و استفاده اولیه از پلتفرم پیمان‌یار کاملاً رایگان است.',
            'هزینه': 'ثبت‌نام و استفاده اولیه از پلتفرم پیمان‌یار کاملاً رایگان است.',
            'پشتیبانی': 'تیم پشتیبانی ما از طریق info@peymanyar.com در دسترس است.',
            'تماس': 'می‌توانید با شماره ۰۲۱-۱۲۳۴۵۶۷۸ با ما تماس بگیرید.',
            'پیام': 'برای مدیریت پیام‌ها می‌توانید به صفحه "پیام‌یار" مراجعه کنید.',
            'پیام‌یار': 'صفحه پیام‌یار در منوی اصلی قرار دارد. در آنجا می‌توانید پیام‌ها را مدیریت و تحلیل کنید.'
        };
        
        let response = 'متوجه سوال شما نشدم. می‌توانید سوال خود را به شکل دیگری مطرح کنید.';
        
        for (const [keyword, answer] of Object.entries(responses)) {
            if (userMessage.includes(keyword)) {
                response = answer;
                break;
            }
        }
        
        this.addAssistantMessage('assistant', response);
    }

    loadAssistantMessages() {
        const saved = localStorage.getItem('peymanyar_assistant_messages');
        if (saved) {
            this.assistantMessages = JSON.parse(saved);
            this.renderAssistantMessages();
        } else {
            this.addAssistantMessage('assistant', 'سلام! 👋 من دستیار هوشمند پیمان‌یار هستم. چطور می‌تونم کمکتون کنم؟');
        }
    }

    saveAssistantMessages() {
        localStorage.setItem('peymanyar_assistant_messages', JSON.stringify(this.assistantMessages.slice(-50)));
    }

    renderAssistantMessages() {
        const container = document.getElementById('assistantMessages');
        container.innerHTML = '';
        this.assistantMessages.forEach(msg => {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${msg.role}`;
            messageDiv.innerHTML = `<div class="message-bubble">${this.sanitizeHTML(msg.content)}</div>`;
            container.appendChild(messageDiv);
        });
    }

    markAssistantAsRead() {
        const badge = document.getElementById('assistantNotification');
        if (badge) {
            badge.style.display = 'none';
        }
    }

    // =================================================================
    // توابع جستجو
    // =================================================================
    performSearch() {
        const keyword = document.getElementById('searchKeyword').value;
        const specialty = document.getElementById('searchSpecialty').value;
        const locationSelect = document.getElementById('searchLocation');
        const selectedLocations = Array.from(locationSelect.selectedOptions).map(opt => opt.value);
        const experience = document.getElementById('searchExperience').value;

        const results = [
            { id: 1, name: 'شرکت سازه‌گستر', location: ['tehran', 'alborz'], specialty: 'steel_fabrication', rating: 4.5, reviews: 12, experience: 15, verified: true },
            { id: 2, name: 'بتن‌کاران برتر', location: ['esfahan', 'tehran'], specialty: 'concrete_execution', rating: 4.2, reviews: 8, experience: 8, verified: true },
            { id: 3, name: 'جوشکاران حرفه‌ای', location: ['razavi-khorasan'], specialty: 'welding', rating: 4.7, reviews: 15, experience: 12, verified: true },
            { id: 4, name: 'اسکلت‌سازان نوین', location: ['alborz'], specialty: 'steel_installation', rating: 4.8, reviews: 20, experience: 18, verified: true },
            { id: 5, name: 'خاکبرداری ایمن', location: ['tehran', 'alborz'], specialty: 'excavation', rating: 4.3, reviews: 6, experience: 10, verified: true },
            { id: 6, name: 'رنگ‌آمیز صنعت', location: ['esfahan', 'fars'], specialty: 'coating', rating: 4.6, reviews: 9, experience: 7, verified: true },
            { id: 7, name: 'آب‌بندی پارس', location: ['khuzestan', 'fars'], specialty: 'waterproofing', rating: 4.4, reviews: 11, experience: 9, verified: true },
            { id: 8, name: 'مقاوم‌سازان', location: ['tehran'], specialty: 'seismic_retrofit', rating: 4.9, reviews: 18, experience: 20, verified: true }
        ];

        const filteredResults = results.filter(result => {
            if (keyword && !result.name.includes(keyword) && !result.specialty.includes(keyword)) return false;
            if (specialty && result.specialty !== specialty) return false;
            if (selectedLocations.length > 0 && !selectedLocations.includes('all')) {
                const hasLocation = result.location.some(loc => selectedLocations.includes(loc));
                if (!hasLocation) return false;
            }
            if (experience && result.experience < parseInt(experience)) return false;
            return true;
        });

        this.displaySearchResults(filteredResults);
    }

    displaySearchResults(results) {
        const container = document.getElementById('searchResults');
        if (results.length === 0) {
            container.innerHTML = `
                <div class="col-12">
                    <div class="card-peymanyar text-center py-5">
                        <i class="bi bi-search display-4 text-muted mb-3"></i>
                        <h4>نتیجه‌ای یافت نشد</h4>
                        <p class="text-muted">لطفاً فیلترهای جستجو را تغییر دهید.</p>
                    </div>
                </div>
            `;
            return;
        }
        
        container.innerHTML = results.map(result => `
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="card-peymanyar h-100">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h5 class="mb-1">${result.name}</h5>
                            <p class="text-muted mb-1"><i class="bi bi-geo-alt me-1"></i>${result.location}</p>
                            <p class="text-muted mb-1"><i class="bi bi-clock-history me-1"></i>${result.experience} سال سابقه</p>
                        </div>
                        ${result.verified ? '<span class="badge bg-success">تأیید شده</span>' : ''}
                    </div>
                    <div class="mb-3">
                        ${this.generateStars(result.rating)}
                        <span class="text-muted ms-2">${result.rating} (${result.reviews} نظر)</span>
                    </div>
                    <p class="text-muted mb-3">تخصص: ${result.specialty}</p>
                    <div class="d-flex justify-content-between">
                        <button class="btn btn-sm btn-outline-primary" onclick="app.viewContractorProfile(${result.id})">مشاهده پروفایل</button>
                        <button class="btn btn-sm btn-primary" onclick="app.contactContractor(${result.id})">ارتباط</button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    generateStars(rating) {
        let stars = '';
        const fullStars = Math.floor(rating);
        const hasHalfStar = rating % 1 >= 0.5;
        
        for (let i = 0; i < fullStars; i++) stars += '<i class="bi bi-star-fill text-warning"></i>';
        if (hasHalfStar) stars += '<i class="bi bi-star-half text-warning"></i>';
        
        const remaining = 5 - fullStars - (hasHalfStar ? 1 : 0);
        for (let i = 0; i < remaining; i++) stars += '<i class="bi bi-star text-warning"></i>';
        
        return stars;
    }

    viewContractorProfile(id) {
        this.showToast(`پروفایل پیمانکار ${id} در حال بارگذاری...`, 'info');
    }

    contactContractor(id) {
        this.showToast(`ارتباط با پیمانکار ${id} برقرار شد`, 'success');
    }

    // =================================================================
    // توابع پیام‌یار
    // =================================================================
    setupMessagingSystem() {
        window.PeymanYar = function() {
            this.showMessagesResult("تابع PeymanYar با موفقیت فراخوانی شد!<br>این تابع اصلی سیستم پیام‌یار است.");
        };
    }

    showMessagesResult(content) {
        const resultElement = document.getElementById('messagesResult');
        if (resultElement) {
            resultElement.innerHTML = content;
        }
    }

    showMessagesLoading(show) {
        const loadingElement = document.getElementById('messagesLoading');
        if (loadingElement) {
            loadingElement.style.display = show ? 'block' : 'none';
        }
    }

    analyzeMessages() {
        this.showMessagesLoading(true);
        setTimeout(() => {
            this.showMessagesResult(`
                <strong>✅ تحلیل پیام‌ها با موفقیت انجام شد!</strong><br><br>
                📊 <strong>نتایج تحلیل:</strong><br>
                • تعداد پیام‌ها: ۱,۲۴۷ پیام<br>
                • میانگین طول پیام: ۴۲ کاراکتر<br>
                • محبوب‌ترین کلمات: سلام، ممنون، لطفا<br>
                • تحلیل احساسات: ۸۵٪ مثبت، ۱۲٪ خنثی، ۳٪ منفی<br>
                • زمان اوج فعالیت: ۱۸:۰۰ تا ۲۲:۰۰<br>
                <br>
                <em>تحلیل در تاریخ ${new Date().toLocaleDateString('fa-IR')} انجام شد.</em>
            `);
            this.showMessagesLoading(false);
        }, 1500);
    }

    sendGroupMessage() {
        this.showMessagesLoading(true);
        setTimeout(() => {
            this.showMessagesResult(`
                <strong>📨 پیام گروهی با موفقیت ارسال شد!</strong><br><br>
                ✅ <strong>جزئیات ارسال:</strong><br>
                • تعداد گیرندگان: ۱۲۸ نفر<br>
                • زمان ارسال: ${new Date().toLocaleTimeString('fa-IR')}<br>
                • وضعیت: در حال ارسال...<br>
                • پیام ارسالی: "جلسه هفتگی فردا ساعت ۱۰ صبح برگزار می‌شود."<br>
                <br>
                <em>پیام به ۳ گروه کاری مختلف ارسال شد.</em>
            `);
            this.showMessagesLoading(false);
        }, 2000);
    }

    searchMessages() {
        this.showMessagesLoading(true);
        setTimeout(() => {
            this.showMessagesResult(`
                <strong>🔍 نتایج جستجو:</strong><br><br>
                📝 <strong>برای کلیدواژه "پروژه":</strong><br>
                • ۴۵۷ پیام یافت شد<br>
                • فیلترهای اعمال شده:<br>
                &nbsp;&nbsp;✓ تاریخ: ۱ ماه اخیر<br>
                &nbsp;&nbsp;✓ گروه: تیم فنی<br>
                &nbsp;&nbsp;✓ نوع: پیام متنی<br>
                <br>
                🏆 <strong>مهم‌ترین نتایج:</strong><br>
                ۱. "پروژه جدید از هفته آینده شروع می‌شود"<br>
                ۲. "جلسه بررسی پروژه فردا برگزار می‌شود"<br>
                ۳. "ددلاین پروژه تا پایان ماه تمدید شد"<br>
                <br>
                <em>جستجو در ۱۲,۸۴۵ پیام انجام شد.</em>
            `);
            this.showMessagesLoading(false);
        }, 1800);
    }

    showStatistics() {
        this.showMessagesLoading(true);
        setTimeout(() => {
            this.showMessagesResult(`
                <strong>📈 آمار و گزارش ماهانه</strong><br><br>
                📅 <strong>بازه زمانی:</strong> ۱ فروردین تا ۳۰ فروردین ۱۴۰۳<br><br>
                📊 <strong>آمار کلی:</strong><br>
                • کل پیام‌ها: ۱۲,۸۴۵ پیام<br>
                • پیام‌های ارسالی: ۶,۴۲۱ پیام<br>
                • پیام‌های دریافتی: ۶,۴۲۴ پیام<br>
                • فایل‌های ارسالی: ۲۴۷ فایل<br>
                • کاربران فعال: ۸۹ نفر<br><br>
                📈 <strong>روند روزانه:</strong><br>
                • میانگین پیام روزانه: ۴۲۸ پیام<br>
                • پرترافیک‌ترین روز: پنجشنبه - ۶۸۹ پیام<br>
                • کم‌ترافیک‌ترین روز: جمعه - ۲۱۰ پیام<br><br>
                🏆 <strong>برترین‌ها:</strong><br>
                • فعال‌ترین کاربر: علی محمدی (۱,۲۴۷ پیام)<br>
                • محبوب‌ترین گروه: تیم فنی (۳,۴۵۶ پیام)<br>
                • پرکاربردترین واژه: "سلام" (۸۹۴ بار)
            `);
            this.showMessagesLoading(false);
        }, 1200);
    }

    openSettings() {
        this.showMessagesResult(`
            <strong>⚙️ تنظیمات سیستم</strong><br><br>
            🔧 <strong>تنظیمات فعلی:</strong><br>
            • حالت تاریک: غیرفعال<br>
            • اعلان‌ها: فعال<br>
            • ذخیره خودکار: هر ۵ دقیقه<br>
            • فرمت تاریخ: شمسی<br>
            • زبان: فارسی<br>
            • محدودیت فایل آپلود: ۵۰ مگابایت<br><br>
            ⚡ <strong>تنظیمات پیشرفته:</strong><br>
            <button class="btn-messages" onclick="app.changeMessagesTheme()">تغییر تم</button>
            <button class="btn-messages" onclick="app.resetMessagesSettings()">بازنشانی تنظیمات</button>
            <button class="btn-messages" onclick="app.exportMessagesData()">خروجی گرفتن</button>
        `);
    }

    syncData() {
        this.showMessagesLoading(true);
        setTimeout(() => {
            this.showMessagesResult(`
                <strong>🔄 همگام‌سازی با موفقیت انجام شد!</strong><br><br>
                ✅ <strong>جزئیات همگام‌سازی:</strong><br>
                • تاریخ همگام‌سازی: ${new Date().toLocaleString('fa-IR')}<br>
                • پیام‌های جدید: ۱۲۷ پیام<br>
                • فایل‌های جدید: ۸ فایل<br>
                • تماس‌های جدید: ۳ تماس<br>
                • فضای استفاده شده: ۲.۴ از ۱۰ گیگابایت<br>
                • وضعیت اتصال: پایدار<br><br>
                <em>آخرین همگام‌سازی قبل از این: ۲ ساعت پیش</em>
            `);
            this.showMessagesLoading(false);
        }, 2500);
    }

    cleanupStorage() {
        this.showMessagesLoading(true);
        setTimeout(() => {
            this.showMessagesResult(`
                <strong>🧹 پاکسازی حافظه انجام شد!</strong><br><br>
                📉 <strong>نتایج پاکسازی:</strong><br>
                • پیام‌های حذف شده: ۲,۴۵۷ پیام<br>
                • فایل‌های موقت حذف شده: ۱۲۴ فایل<br>
                • کش حذف شده: ۴۷۲ مگابایت<br>
                • فضای آزاد شده: ۱.۸ گیگابایت<br>
                • فضای باقی‌مانده: ۸.۲ گیگابایت<br><br>
                ⚠️ <strong>توجه:</strong><br>
                پیام‌های حذف شده از تاریخ ${new Date(new Date().setMonth(new Date().getMonth() - 6)).toLocaleDateString('fa-IR')} تا امروز بوده‌اند.
            `);
            this.showMessagesLoading(false);
        }, 3000);
    }

    showHelp() {
        this.showMessagesResult(`
            <strong>📚 راهنمای استفاده از پیام‌یار</strong><br><br>
            📖 <strong>بخش‌های اصلی:</strong><br>
            ۱. تحلیل پیام‌ها - آنالیز هوشمند محتوای پیام‌ها<br>
            ۲. ارسال گروهی - ارسال پیام به چندین نفر همزمان<br>
            ۳. جستجو - یافتن پیام‌های خاص با فیلترهای مختلف<br>
            ۴. آمار - گزارش‌های تحلیلی از فعالیت‌ها<br>
            ۵. تنظیمات - شخصی‌سازی سیستم<br>
            ۶. همگام‌سازی - به‌روزرسانی داده‌ها با سرور<br>
            ۷. پاکسازی - مدیریت فضای ذخیره‌سازی<br><br>
            📞 <strong>پشتیبانی:</strong><br>
            • ایمیل: support@peymanyar.com<br>
            • تلفن: ۰۲۱-۱۲۳۴۵۶۷۸<br>
            • ساعت کاری: ۸ صبح تا ۵ عصر<br><br>
            🔒 <strong>امنیت:</strong><br>
            • تمام داده‌ها به صورت رمزنگاری شده ذخیره می‌شوند<br>
            • دسترسی با رمز عبور و احراز هویت دو مرحله‌ای<br>
            • پشتیبان‌گیری خودکار روزانه<br><br>
            <em>نسخه: ۲.۰.۱ - آخرین به‌روزرسانی: فروردین ۱۴۰۳</em>
        `);
    }

    changeMessagesTheme() {
        const messagingPage = document.querySelector('.messaging-page');
        if (messagingPage) {
            messagingPage.style.background = 'linear-gradient(135deg, #1a202c 0%, #2d3748 100%)';
            messagingPage.style.color = '#e0e0e0';
        }
        this.showMessagesResult('تم سیستم پیام‌یار به حالت تاریک تغییر کرد.');
    }

    resetMessagesSettings() {
        this.showMessagesResult('تنظیمات سیستم پیام‌یار به حالت پیش‌فرض بازنشانی شدند.');
    }

    exportMessagesData() {
        this.showMessagesLoading(true);
        setTimeout(() => {
            this.showMessagesResult('داده‌های سیستم پیام‌یار با فرمت JSON و CSV با موفقیت ذخیره شدند.');
            this.showMessagesLoading(false);
        }, 1500);
    }

    // =================================================================
    // توابع آمار و شمارنده
    // =================================================================
    animateCounters() {
        const counters = document.querySelectorAll('.stat-value[data-count]');
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const counter = entry.target;
                    const target = +counter.getAttribute('data-count');
                    this.animateCounter(counter, target);
                    observer.unobserve(counter);
                }
            });
        }, { threshold: 0.5 });
        
        counters.forEach(counter => observer.observe(counter));
    }

    animateCounter(element, target) {
        let count = 0;
        const increment = target / 50;
        const step = () => {
            if (count < target) {
                count += increment;
                element.textContent = Math.ceil(count).toLocaleString('fa-IR');
                requestAnimationFrame(step);
            } else {
                element.textContent = target.toLocaleString('fa-IR') + (element.getAttribute('data-count') === '98' ? '٪' : '');
            }
        };
        requestAnimationFrame(step);
    }

    async loadRealStats() {
        try {
            const { count: realContractors } = await supabase
                .from('profiles')
                .select('*', { count: 'exact', head: true })
                .eq('user_type', 'contractor');
            
            const { count: realEmployers } = await supabase
                .from('profiles')
                .select('*', { count: 'exact', head: true })
                .eq('user_type', 'employer');
            
            let realProjects = 0;
            try {
                const { count } = await supabase
                    .from('projects')
                    .select('*', { count: 'exact', head: true });
                realProjects = count || 0;
            } catch (e) {
                realProjects = 0;
            }

            const BASE_CONTRACTORS = 150;
            const BASE_EMPLOYERS = 100;
            const BASE_PROJECTS = 75;
            const BASE_SATISFACTION = 98;

            const totalContractors = BASE_CONTRACTORS + (realContractors || 0);
            const totalEmployers = BASE_EMPLOYERS + (realEmployers || 0);
            const totalProjects = BASE_PROJECTS + (realProjects || 0);
            
            const contractorElement = document.querySelector('.stat-value[data-count="1250"]');
            const employerElement = document.querySelector('.stat-value[data-count="320"]');
            const projectElement = document.querySelector('.stat-value[data-count="540"]');
            const satisfactionElement = document.querySelector('.stat-value[data-count="98"]');
            
            if (contractorElement) {
                contractorElement.textContent = totalContractors.toLocaleString('fa-IR');
            }
            
            if (employerElement) {
                employerElement.textContent = totalEmployers.toLocaleString('fa-IR');
            }
            
            if (projectElement) {
                projectElement.textContent = totalProjects.toLocaleString('fa-IR');
            }
            
            if (satisfactionElement) {
                satisfactionElement.textContent = BASE_SATISFACTION + '٪';
            }
            
        } catch (error) {
            console.error('خطا در دریافت آمار:', error);
            const contractorElement = document.querySelector('.stat-value[data-count="1250"]');
            const employerElement = document.querySelector('.stat-value[data-count="320"]');
            const projectElement = document.querySelector('.stat-value[data-count="540"]');
            const satisfactionElement = document.querySelector('.stat-value[data-count="98"]');
            
            if (contractorElement) contractorElement.textContent = '150';
            if (employerElement) employerElement.textContent = '100';
            if (projectElement) projectElement.textContent = '75';
            if (satisfactionElement) satisfactionElement.textContent = '98٪';
        }
    }

    // =================================================================
    // توابع پروژه‌ها
    // =================================================================
    async loadProjects() {
        const statusFilter = document.getElementById('projectFilterStatus')?.value || 'all';
        const searchTerm = document.getElementById('projectSearch')?.value || '';
        
        try {
            let query = supabase
                .from('projects')
                .select('*')
                .eq('admin_approved', true)
                .order('created_at', { ascending: false });
            
            if (statusFilter !== 'all') {
                query = query.eq('status', statusFilter);
            }
            
            if (searchTerm) {
                query = query.or(`title.ilike.%${searchTerm}%,description.ilike.%${searchTerm}%`);
            }
            
            const { data: projects, error } = await query;
            
            if (error) {
                console.error('خطا:', error);
                this.showToast('خطا در دریافت پروژه‌ها', 'error');
                return;
            }
            
            const projectsWithEmployer = await Promise.all((projects || []).map(async (project) => {
                const { data: employer } = await supabase
                    .from('profiles')
                    .select('full_name, company_name')
                    .eq('user_id', project.employer_id)
                    .single();
                
                return {
                    ...project,
                    employer: employer || null
                };
            }));
            
            this.displayProjects(projectsWithEmployer);
            
        } catch (error) {
            console.error('خطا:', error);
            this.showToast('خطا در دریافت پروژه‌ها', 'error');
        }
    }

    displayProjects(projects) {
        const container = document.getElementById('projectsList');
        
        if (!container) {
            console.error('المان پروژه‌ها پیدا نشد!');
            return;
        }
        
        if (!projects || projects.length === 0) {
            container.innerHTML = `
                <div class="col-12">
                    <div class="card-peymanyar text-center py-5">
                        <i class="bi bi-folder-x display-4 text-muted mb-3"></i>
                        <h4>پروژه‌ای یافت نشد</h4>
                        <p class="text-muted">هنوز پروژه‌ای ثبت نشده است.</p>
                    </div>
                </div>
            `;
            return;
        }
        
        let html = '';
        projects.forEach(project => {
            const statusClass = {
                'open': 'bg-success',
                'in_progress': 'bg-primary',
                'completed': 'bg-secondary',
                'cancelled': 'bg-danger'
            }[project.status] || 'bg-secondary';
            
            const statusText = {
                'open': 'در انتظار پیمانکار',
                'in_progress': 'در حال انجام',
                'completed': 'تکمیل شده',
                'cancelled': 'لغو شده'
            }[project.status] || project.status;
            
            html += `
                <div class="col-md-6 mb-4">
                    <div class="card-peymanyar">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h5>${project.title}</h5>
                            <span class="badge ${statusClass}">${statusText}</span>
                        </div>
                        <p>${project.description || 'بدون توضیحات'}</p>
                        <small>شناسه پروژه: ${project.id}</small>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }

    getBudgetText(budget) {
        const budgets = {
            'under100': 'زیر ۱۰۰ میلیون',
            '100-500': '۱۰۰ تا ۵۰۰ میلیون',
            '500-1000': '۵۰۰ میلیون تا ۱ میلیارد',
            '1-5': '۱ تا ۵ میلیارد',
            '5+': 'بالای ۵ میلیارد'
        };
        return budgets[budget] || budget;
    }

    getTimelineText(timeline) {
        const timelines = {
            'urgent': 'فوری (کمتر از ۱ ماه)',
            '1-3': '۱ تا ۳ ماه',
            '3-6': '۳ تا ۶ ماه',
            '6-12': '۶ تا ۱۲ ماه',
            'flexible': 'انعطاف‌پذیر'
        };
        return timelines[timeline] || timeline;
    }

    showNewProjectModal() {
        if (!this.userData) {
            this.showToast('برای ثبت پروژه ابتدا وارد شوید', 'error');
            this.showPage('login');
            return;
        }
        
        if (this.userData.user_type !== 'employer') {
            this.showToast('فقط کارفرمایان می‌توانند پروژه ثبت کنند', 'error');
            return;
        }
        
        const modal = new bootstrap.Modal(document.getElementById('newProjectModal'));
        modal.show();
    }

    async createProject() {
        const title = document.getElementById('projectTitle')?.value;
        const description = document.getElementById('projectDescription')?.value;
        const category = document.getElementById('projectCategory')?.value;
        const budget = document.getElementById('projectBudget')?.value;
        const location = document.getElementById('projectLocation')?.value;
        const timeline = document.getElementById('projectTimeline')?.value;
        
        if (!title || !description) {
            this.showToast('لطفاً عنوان و توضیحات پروژه را وارد کنید', 'error');
            return;
        }
        
        const projectData = {
            title,
            description,
            employer_id: this.userData.id,
            category: category || null,
            budget_range: budget || null,
            location: location || null,
            timeline: timeline || null,
            status: 'pending',
            admin_approved: false
        };
        
        const { data, error } = await supabase
            .from('projects')
            .insert([projectData])
            .select();
        
        if (error) {
            console.error('خطا در ایجاد پروژه:', error);
            this.showToast('خطا در ایجاد پروژه: ' + error.message, 'error');
            return;
        }
        
        this.showToast('پروژه شما با موفقیت ثبت و برای تایید ارسال شد', 'success');
        
        const modal = bootstrap.Modal.getInstance(document.getElementById('newProjectModal'));
        if (modal) modal.hide();
        
        document.getElementById('newProjectForm')?.reset();
    }

    // =================================================================
    // توابع مدیریت (ادمین)
    // =================================================================
    setupAdminSystem() {
        this.checkAdminStatus();
    }

    async checkAdminStatus() {
        if (this.userData && this.userData.id) {
            try {
                const { data: profile, error } = await supabase
                    .from('profiles')
                    .select('role')
                    .eq('user_id', this.userData.id)
                    .single();
                    
                if (!error && profile?.role === 'admin') {
                    this.isAdmin = true;
                    this.showAdminControls();
                    console.log('کاربر ادمین است');
                } else {
                    this.isAdmin = false;
                    this.hideAdminControls();
                    console.log('کاربر ادمین نیست');
                }
            } catch (error) {
                console.error('خطا در بررسی نقش کاربر:', error);
                this.isAdmin = false;
                this.hideAdminControls();
            }
        } else {
            this.isAdmin = false;
            this.hideAdminControls();
        }
    }

    showAdminControls() {
        document.querySelectorAll('.admin-only').forEach(link => { 
            link.style.display = 'block'; 
        });
    }

    hideAdminControls() {
        document.querySelectorAll('.admin-only').forEach(link => { 
            link.style.display = 'none'; 
        });
    }

    adminLogout() {
        this.isAdmin = false;
        this.hideAdminControls();
        this.showToast('از پنل مدیریت خارج شدید', 'success');
        this.showPage('home');
    }

    showAdminLogin() {
        this.showToast('لطفاً با حساب کاربری ادمین وارد شوید', 'info');
        this.showPage('login');
    }

    async showAdminMessages() {
        if (!this.userData || !this.userData.id) {
            this.showToast('لطفاً ابتدا وارد شوید', 'error');
            this.showPage('login');
            return;
        }
        
        try {
            const { data: profile, error } = await supabase
                .from('profiles')
                .select('role')
                .eq('user_id', this.userData.id)
                .single();
            
            if (error) {
                console.error('خطا در دریافت نقش کاربر:', error);
                this.showToast('خطا در بررسی دسترسی', 'error');
                return;
            }
            
            if (profile?.role === 'admin') {
                this.isAdmin = true;
                this.showPage('adminMessages');
                setTimeout(() => this.loadAdminStats(), 100);
            } else {
                this.showToast('شما دسترسی ادمین ندارید', 'error');
                this.showPage('home');
            }
        } catch (error) {
            console.error('خطا:', error);
            this.showToast('خطا در بررسی دسترسی', 'error');
        }
    }

    async loadAdminStats() {
        if (!this.isAdmin) return;
        
        try {
            const { count: totalUsers } = await supabase
                .from('profiles')
                .select('*', { count: 'exact', head: true });
            
            let totalMessages = 0;
            try {
                const { count } = await supabase
                    .from('messages')
                    .select('*', { count: 'exact', head: true });
                totalMessages = count || 0;
            } catch (e) {
                totalMessages = 0;
            }
            
            let totalProjects = 0;
            try {
                const { count } = await supabase
                    .from('projects')
                    .select('*', { count: 'exact', head: true });
                totalProjects = count || 0;
            } catch (e) {
                totalProjects = 0;
            }
            
            const storageUsed = ((totalMessages * 0.5) + (totalUsers * 2) + (totalProjects * 1)).toFixed(1);
            
            if (document.getElementById('adminTotalMessages')) {
                document.getElementById('adminTotalMessages').textContent = totalMessages.toLocaleString('fa-IR');
            }
            
            if (document.getElementById('adminActiveUsers')) {
                document.getElementById('adminActiveUsers').textContent = totalUsers.toLocaleString('fa-IR');
            }
            
            if (document.getElementById('adminStorageUsed')) {
                document.getElementById('adminStorageUsed').textContent = storageUsed + ' MB';
            }
            
            if (document.getElementById('adminSystemHealth')) {
                document.getElementById('adminSystemHealth').textContent = '100%';
            }
            
        } catch (error) {
            console.error('خطا در بارگذاری آمار مدیریت:', error);
        }
    }

    adminAnalyzeMessages() {
        this.showAdminLoading(true);
        setTimeout(() => {
            const result = '<strong>📊 تحلیل پیشرفته پیام‌ها انجام شد</strong><br><br><div class="row"><div class="col-md-6"><h6>📈 آمار کلی:</h6>• کل پیام‌ها: ۱۲,۸۴۵<br>• پیام‌های امروز: ۴۲۸<br>• کاربران فعال: ۸۹<br>• میانگین پاسخگویی: ۲.۴ دقیقه<br></div><div class="col-md-6"><h6>📊 تحلیل احساسات:</h6>• مثبت: ۸۵٪<br>• خنثی: ۱۲٪<br>• منفی: ۳٪<br>• موضوعات داغ: پروژه، قرارداد، پرداخت<br></div></div>';
            this.showAdminResult(result);
            this.showAdminLoading(false);
        }, 2000);
    }

    adminSendBroadcast() {
        this.showAdminLoading(true);
        setTimeout(() => {
            const result = '<strong>📨 ارسال پیام عمومی</strong><br><br><div class="alert alert-info"><i class="bi bi-info-circle me-2"></i>این ویژگی در نسخه کامل پیاده‌سازی می‌شود</div><p>در این بخش می‌توانید پیام‌های عمومی به تمام کاربران ارسال کنید.</p><button class="btn btn-primary" onclick="app.showToast(\'این قابلیت در حال توسعه است\', \'info\')">مشاهده جزئیات</button>';
            this.showAdminResult(result);
            this.showAdminLoading(false);
        }, 1000);
    }

    adminAdvancedSearch() {
        this.showAdminLoading(true);
        setTimeout(() => {
            const result = '<strong>🔍 جستجوی جامع</strong><br><br><p>در این بخش می‌توانید در تمام پیام‌های سیستم جستجوی پیشرفته انجام دهید.</p><div class="input-group mb-3"><input type="text" class="form-control" placeholder="جستجوی پیام‌ها..."><button class="btn btn-primary">جستجو</button></div>';
            this.showAdminResult(result);
            this.showAdminLoading(false);
        }, 1000);
    }

    adminSystemStats() {
        this.showAdminLoading(true);
        setTimeout(() => {
            const result = '<strong>📈 آمار کامل سیستم</strong><br><br><div class="row"><div class="col-md-6"><h6>👥 آمار کاربران:</h6>• کاربران کل: ۲,۱۵۴<br>• کاربران فعال: ۸۹<br>• کاربران جدید (امروز): ۱۲<br>• کاربران آنلاین: ۳۴<br></div><div class="col-md-6"><h6>💾 آمار سرور:</h6>• CPU استفاده شده: ۴۲٪<br>• حافظه استفاده شده: ۲.۴ GB<br>• پهنای‌باند: ۱۵۸ MB<br>• سلامت سیستم: ۱۰۰٪<br></div></div>';
            this.showAdminResult(result);
            this.showAdminLoading(false);
        }, 1500);
    }

    adminSystemSettings() {
        this.showAdminLoading(true);
        setTimeout(() => {
            const result = '<strong>⚙️ تنظیمات سیستم</strong><br><br><p>در این بخش می‌توانید تنظیمات سیستم پیام‌یار را مدیریت کنید.</p><div class="form-check mb-2"><input class="form-check-input" type="checkbox" id="enableNotifications" checked><label class="form-check-label" for="enableNotifications">فعال‌سازی اعلان‌ها</label></div><div class="form-check mb-2"><input class="form-check-input" type="checkbox" id="enableAutoReply"><label class="form-check-label" for="enableAutoReply">پاسخ خودکار</label></div><button class="btn btn-primary mt-2">ذخیره تنظیمات</button>';
            this.showAdminResult(result);
            this.showAdminLoading(false);
        }, 1000);
    }

    adminUserManagement() {
        this.showAdminLoading(true);
        setTimeout(() => {
            const result = '<strong>👥 مدیریت کاربران</strong><br><br><p>در این بخش می‌توانید کاربران سیستم را مدیریت کنید.</p><table class="table table-sm"><thead><tr><th>نام</th><th>نوع</th><th>وضعیت</th></tr></thead><tbody><tr><td>علی محمدی</td><td>کارفرما</td><td><span class="badge bg-success">فعال</span></td></tr><tr><td>شرکت سازه‌گستر</td><td>پیمانکار</td><td><span class="badge bg-success">فعال</span></td></tr></tbody></table>';
            this.showAdminResult(result);
            this.showAdminLoading(false);
        }, 1500);
    }

    adminAdvancedCleanup() {
        this.showAdminLoading(true);
        setTimeout(() => {
            const result = '<strong>🧹 پاکسازی پیشرفته</strong><br><br><p>در این بخش می‌توانید داده‌های قدیمی سیستم را پاکسازی کنید.</p><div class="alert alert-warning"><i class="bi bi-exclamation-triangle me-2"></i>این عملیات قابل بازگشت نیست!</div><button class="btn btn-danger" onclick="app.executeCleanup()">اجرای پاکسازی</button>';
            this.showAdminResult(result);
            this.showAdminLoading(false);
        }, 1000);
    }

    executeCleanup() {
        this.showAdminLoading(true);
        setTimeout(() => {
            this.showAdminResult('<strong>✅ پاکسازی با موفقیت انجام شد</strong><br><br>📉 <strong>نتایج پاکسازی:</strong><br>• پیام‌های حذف شده: ۱۲,۴۵۷ پیام<br>• فضای آزاد شده: ۳.۸ گیگابایت<br><em>سیستم با موفقیت بهینه‌سازی شد.</em>');
            this.showAdminLoading(false);
        }, 3000);
    }

    adminViewLogs() {
        this.showAdminLoading(true);
        setTimeout(() => {
            const result = '<strong>📚 گزارش‌های سیستم</strong><br><br><p>در این بخش می‌توانید گزارش‌های عملیاتی سیستم را مشاهده کنید.</p><div class="border rounded p-3"><div class="mb-2"><span class="badge bg-info">INFO</span><span class="ms-2">' + new Date().toLocaleString('fa-IR') + ' - سیستم راه‌اندازی شد</span></div><div class="mb-2"><span class="badge bg-success">USER</span><span class="ms-2">' + new Date().toLocaleString('fa-IR') + ' - کاربر جدید ثبت‌نام کرد</span></div></div>';
            this.showAdminResult(result);
            this.showAdminLoading(false);
        }, 1000);
    }

    showAdminLoading(show) {
        const loadingElement = document.getElementById('adminMessagesLoading');
        if (loadingElement) loadingElement.style.display = show ? 'block' : 'none';
    }

    showAdminResult(content) {
        const resultElement = document.getElementById('adminMessagesResult');
        if (resultElement) resultElement.innerHTML = content;
    }

    // =================================================================
    // توابع عمومی
    // =================================================================
    showToast(message, type = 'info') {
        const toastContainer = document.getElementById('toastContainer');
        if (!toastContainer) return;

        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-bg-${type} border-0`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        
        toastContainer.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast, { animation: true, autohide: true, delay: 3000 });
        bsToast.show();
        toast.addEventListener('hidden.bs.toast', () => { toast.remove(); });
    }

    // =================================================================
    // توابع اسلایدر
    // =================================================================
    setupHeroSlider() {
        this.heroSlides = document.querySelectorAll('.hero-slide');
        this.heroSlideDots = document.querySelectorAll('.hero-slide-dot');
        
        if (this.heroSlides.length > 0) {
            this.startHeroSlider();
            
            this.heroSlideDots.forEach((dot, index) => {
                dot.addEventListener('click', () => {
                    this.goToHeroSlide(index);
                });
            });
            
            const slider = document.querySelector('.hero-image-slider');
            if (slider) {
                slider.addEventListener('mouseenter', () => {
                    this.stopHeroSlider();
                });
                slider.addEventListener('mouseleave', () => {
                    this.startHeroSlider();
                });
            }
        }
    }

    startHeroSlider() {
        this.stopHeroSlider();
        this.heroSlideInterval = setInterval(() => {
            this.nextHeroSlide();
        }, 10000);
    }

    stopHeroSlider() {
        if (this.heroSlideInterval) {
            clearInterval(this.heroSlideInterval);
            this.heroSlideInterval = null;
        }
    }

    nextHeroSlide() {
        this.heroSlideIndex = (this.heroSlideIndex + 1) % this.heroSlides.length;
        this.updateHeroSlider();
    }

    goToHeroSlide(index) {
        this.heroSlideIndex = index;
        this.updateHeroSlider();
    }

    updateHeroSlider() {
        this.heroSlides.forEach(slide => {
            slide.classList.remove('active');
        });
        this.heroSlideDots.forEach(dot => {
            dot.classList.remove('active');
        });
        
        if (this.heroSlides[this.heroSlideIndex]) {
            this.heroSlides[this.heroSlideIndex].classList.add('active');
        }
        if (this.heroSlideDots[this.heroSlideIndex]) {
            this.heroSlideDots[this.heroSlideIndex].classList.add('active');
        }
    }

    // =================================================================
    // توابع دسترسی‌پذیری
    // =================================================================
    setupAccessibility() {
        this.setupFocusTrap();
        this.addSkipToContentLink();
    }
}

// =====================================================================
// نمونه‌سازی از کلاس و توابع گلوبال
// =====================================================================
let app;

document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM loaded, creating app...');
    try {
        app = new PeymanyarApp();
        console.log('App created successfully');
    } catch (error) {
        console.error('Error creating app:', error);
    }
    
    const hash = window.location.hash.substring(1) || 'home';
    if (app) {
        app.showPage(hash, false);
    }
    
    setTimeout(() => {
        const notification = document.getElementById('assistantNotification');
        if (notification) notification.style.display = 'flex';
    }, 2000);
});

// =====================================================================
// توابع گلوبال - فقط یک بار تعریف شده
// =====================================================================
window.showPage = (pageId) => app?.showPage(pageId);
window.showMainPage = () => app?.showMainPage();
window.showLogin = () => app?.showLogin();
window.showForgotPassword = () => app?.showForgotPassword();
window.showEmployerRegistration = () => app?.showEmployerRegistration();
window.showContractorRegistration = () => app?.showContractorRegistration();
window.toggleAssistant = () => app?.toggleAssistant();
window.sendAssistantMessage = () => app?.sendAssistantMessage();
window.performSearch = () => app?.performSearch();
window.logout = () => app?.logout();
window.PeymanYar = () => app?.PeymanYar?.();
window.createNewProject = () => app?.createNewProject();
window.analyzeMessages = () => app?.analyzeMessages();
window.sendGroupMessage = () => app?.sendGroupMessage();
window.searchMessages = () => app?.searchMessages();
window.showStatistics = () => app?.showStatistics();
window.openSettings = () => app?.openSettings();
window.syncData = () => app?.syncData();
window.cleanupStorage = () => app?.cleanupStorage();
window.showHelp = () => app?.showHelp();
window.changeMessagesTheme = () => app?.changeMessagesTheme();
window.resetMessagesSettings = () => app?.resetMessagesSettings();
window.exportMessagesData = () => app?.exportMessagesData();
window.adminLogout = () => app?.adminLogout();
window.showAdminLogin = () => app?.showAdminLogin();
window.showAdminMessages = () => app?.showAdminMessages();
window.adminAnalyzeMessages = () => app?.adminAnalyzeMessages();
window.adminSendBroadcast = () => app?.adminSendBroadcast();
window.adminAdvancedSearch = () => app?.adminAdvancedSearch();
window.adminSystemStats = () => app?.adminSystemStats();
window.adminSystemSettings = () => app?.adminSystemSettings();
window.adminUserManagement = () => app?.adminUserManagement();
window.adminAdvancedCleanup = () => app?.adminAdvancedCleanup();
window.adminViewLogs = () => app?.adminViewLogs();
window.executeCleanup = () => app?.executeCleanup();
window.togglePasswordVisibility = (id) => app?.togglePasswordVisibility(id);
window.showTermsModal = () => app?.showTermsModal();
window.acceptTerms = () => app?.acceptTerms();
window.enableProfileEdit = () => app?.enableProfileEdit();
window.cancelProfileEdit = () => app?.cancelProfileEdit();
window.saveProfileChanges = () => app?.saveProfileChanges();

// =====================================================================
// توابع مخصوص پروژه‌ها (گلوبال)
// =====================================================================
function getCurrentUser() {
    try {
        const userData = localStorage.getItem('peymanyar_user');
        if (!userData) {
            console.log('کاربری وارد نشده');
            return null;
        }
        const user = JSON.parse(userData);
        console.log('کاربر فعلی:', user);
        return user;
    } catch (e) {
        console.error('خطا:', e);
        return null;
    }
}

window.openNewProjectModal = function() {
    const user = getCurrentUser();
    
    if (!user) {
        alert('❌ لطفا ابتدا وارد حساب کاربری خود شوید');
        showLogin();
        return;
    }
    
    if (user.user_type !== 'employer') {
        alert('❌ ثبت پروژه فقط برای کارفرمایان امکان‌پذیر است');
        return;
    }
    
    console.log('✅ کاربر کارفرما تایید شد:', user.email);
    window.currentUserId = user.id;
    window.currentUserEmail = user.email;
    
    const modal = new bootstrap.Modal(document.getElementById('newProjectModal'));
    modal.show();
}

window.saveProjectToDatabase = async function() {
    const user = getCurrentUser();
    
    if (!user) {
        alert('❌ لطفا وارد حساب کاربری شوید');
        showLogin();
        return;
    }
    
    if (user.user_type !== 'employer') {
        alert('❌ شما اجازه ثبت پروژه ندارید');
        return;
    }
    
    const title = document.getElementById('projectTitle')?.value;
    const desc = document.getElementById('projectDescription')?.value;
    
    if (!title || !desc) {
        alert('❌ عنوان و توضیحات پروژه را وارد کنید');
        return;
    }
    
    const btn = document.querySelector('#newProjectModal .btn-primary');
    const originalText = btn.innerHTML;
    btn.innerHTML = 'در حال ثبت...';
    btn.disabled = true;
    
    try {
        const projectData = {
            title: title,
            description: desc,
            employer_id: user.id,
            category: document.getElementById('projectCategory')?.value || null,
            budget_range: document.getElementById('projectBudget')?.value || null,
            location: document.getElementById('projectLocation')?.value || null,
            timeline: document.getElementById('projectTimeline')?.value || null,
            status: 'pending',
            admin_approved: false,
            created_at: new Date().toISOString()
        };
        
        console.log('در حال ثبت پروژه برای کاربر:', user.email);
        console.log('داده پروژه:', projectData);
        
        const { error, data } = await supabase
            .from('projects')
            .insert([projectData])
            .select();
        
        if (error) throw error;
        
        alert(`✅ پروژه "${title}" با موفقیت ثبت و منتظر تایید مدیر است`);
        
        const modal = bootstrap.Modal.getInstance(document.getElementById('newProjectModal'));
        modal.hide();
        
        document.getElementById('newProjectForm').reset();
        
        setTimeout(() => location.reload(), 2000);
        
    } catch (error) {
        console.error('خطا:', error);
        alert('❌ خطا: ' + error.message);
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

window.checkUserStatus = function() {
    const user = getCurrentUser();
    if (user) {
        console.log('✅ کاربر وارد شده:', user);
        console.log('نوع کاربر:', user.user_type);
        if (user.user_type === 'employer') {
            console.log('✅ این کاربر کارفرما است - می‌تواند پروژه ثبت کند');
        } else {
            console.log('❌ این کاربر کارفرما نیست');
        }
    } else {
        console.log('❌ هیچ کاربری وارد نشده');
    }
}

// =====================================================================
// پنل مدیریت پروژه‌ها برای پیام‌یار
// =====================================================================
window.showProjectManagementPanel = function() {
    console.log('مدیریت پروژه‌ها باز شد');
    
    document.querySelectorAll('.page-section').forEach(p => p.style.display = 'none');
    
    let projectPanel = document.getElementById('adminProjectsPanel');
    if (!projectPanel) {
        projectPanel = document.createElement('div');
        projectPanel.id = 'adminProjectsPanel';
        projectPanel.className = 'page-section';
        projectPanel.innerHTML = `
            <div class="container page-header">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="section-title mb-1">
                            <i class="bi bi-building me-2"></i>مدیریت پروژه‌ها
                        </h2>
                        <p class="text-muted">تایید و مدیریت پروژه‌های ثبت شده</p>
                    </div>
                    <div>
                        <button class="btn btn-outline-primary me-2" onclick="loadPendingProjects()">
                            <i class="bi bi-arrow-repeat me-1"></i>بروزرسانی
                        </button>
                        <button class="btn btn-outline-secondary" onclick="goBackToAdminPanel()">
                            <i class="bi bi-arrow-right me-1"></i>بازگشت
                        </button>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card-peymanyar text-center">
                            <div class="h3 mb-2" id="statPending">0</div>
                            <div class="text-muted">در انتظار تایید</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card-peymanyar text-center">
                            <div class="h3 mb-2" id="statApproved">0</div>
                            <div class="text-muted">تایید شده</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card-peymanyar text-center">
                            <div class="h3 mb-2" id="statTotal">0</div>
                            <div class="text-muted">کل پروژه‌ها</div>
                        </div>
                    </div>
                </div>

                <div class="card-peymanyar mb-4">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <select class="form-select" id="projectFilter" onchange="filterProjects()">
                                <option value="pending">در انتظار تایید</option>
                                <option value="approved">تایید شده</option>
                                <option value="all">همه پروژه‌ها</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="projectSearch" placeholder="جستجوی پروژه...">
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-peymanyar w-100" onclick="filterProjects()">
                                <i class="bi bi-search me-2"></i>اعمال فیلتر
                            </button>
                        </div>
                    </div>
                </div>

                <div id="projectsAdminList" class="row"></div>
            </div>
        `;
        
        const footer = document.querySelector('footer');
        if (footer) {
            document.body.insertBefore(projectPanel, footer);
        } else {
            document.body.appendChild(projectPanel);
        }
    }
    
    projectPanel.style.display = 'block';
    loadAllProjects();
}

window.goBackToAdminPanel = function() {
    document.querySelectorAll('.page-section').forEach(p => p.style.display = 'none');
    document.getElementById('adminMessages').style.display = 'block';
}

window.loadAllProjects = async function() {
    try {
        const { data: projects, error } = await supabase
            .from('projects')
            .select('*')
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        const pending = projects.filter(p => !p.admin_approved).length;
        const approved = projects.filter(p => p.admin_approved).length;
        
        document.getElementById('statPending').textContent = pending;
        document.getElementById('statApproved').textContent = approved;
        document.getElementById('statTotal').textContent = projects.length;
        
        const badge = document.getElementById('pendingProjectsCount');
        if (badge) badge.textContent = pending;
        
        window.projectsData = projects;
        
        const pendingProjects = projects.filter(p => !p.admin_approved);
        displayProjectsList(pendingProjects);
        
        const filterSelect = document.getElementById('projectFilter');
        if (filterSelect) filterSelect.value = 'pending';
        
    } catch (error) {
        console.error('خطا:', error);
        document.getElementById('projectsAdminList').innerHTML = `
            <div class="col-12">
                <div class="alert alert-danger">
                    خطا در دریافت پروژه‌ها: ${error.message}
                </div>
            </div>
        `;
    }
}

window.filterProjects = function() {
    const filter = document.getElementById('projectFilter')?.value || 'pending';
    const search = document.getElementById('projectSearch')?.value || '';
    
    let filtered = window.projectsData || [];
    
    if (filter === 'pending') {
        filtered = filtered.filter(p => !p.admin_approved);
    } else if (filter === 'approved') {
        filtered = filtered.filter(p => p.admin_approved);
    }
    
    if (search) {
        filtered = filtered.filter(p => 
            p.title.toLowerCase().includes(search.toLowerCase()) ||
            (p.description && p.description.toLowerCase().includes(search.toLowerCase()))
        );
    }
    
    displayProjectsList(filtered);
}

function displayProjectsList(projects) {
    const container = document.getElementById('projectsAdminList');
    if (!container) return;
    
    if (!projects || projects.length === 0) {
        container.innerHTML = `
            <div class="col-12">
                <div class="card-peymanyar text-center py-5">
                    <i class="bi bi-folder-x display-4 text-muted mb-3"></i>
                    <h4>پروژه‌ای یافت نشد</h4>
                </div>
            </div>
        `;
        return;
    }
    
    let html = '';
    projects.forEach(project => {
        const statusClass = project.admin_approved ? 'bg-success' : 'bg-warning';
        const statusText = project.admin_approved ? 'تایید شده' : 'در انتظار تایید';
        
        html += `
            <div class="col-md-6 mb-4">
                <div class="card-peymanyar">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <h5>${project.title}</h5>
                        <span class="badge ${statusClass}">${statusText}</span>
                    </div>
                    <p>${project.description || 'بدون توضیحات'}</p>
                    <div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top">
                        <small class="text-muted">
                            <i class="bi bi-calendar me-1"></i>
                            ${new Date(project.created_at).toLocaleDateString('fa-IR')}
                        </small>
                        <div>
                            ${!project.admin_approved ? `
                                <button class="btn btn-sm btn-success me-2" onclick="approveProject(${project.id})">
                                    <i class="bi bi-check-circle me-1"></i>تایید
                                </button>
                            ` : ''}
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteProject(${project.id})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

window.approveProject = async function(projectId) {
    if (!confirm('آیا از تایید این پروژه اطمینان دارید؟')) return;
    
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = 'در حال تایید...';
    btn.disabled = true;
    
    try {
        const { error } = await supabase
            .from('projects')
            .update({ admin_approved: true, status: 'open' })
            .eq('id', projectId);
        
        if (error) throw error;
        
        const projectCard = btn.closest('.col-md-6');
        if (projectCard) {
            projectCard.remove();
        }
        
        const pendingSpan = document.getElementById('statPending');
        const currentPending = parseInt(pendingSpan.textContent);
        pendingSpan.textContent = currentPending - 1;
        
        const approvedSpan = document.getElementById('statApproved');
        approvedSpan.textContent = parseInt(approvedSpan.textContent) + 1;
        
        const badge = document.getElementById('pendingProjectsCount');
        if (badge) badge.textContent = currentPending - 1;
        
        const container = document.getElementById('projectsAdminList');
        if (container.children.length === 0) {
            container.innerHTML = `
                <div class="col-12">
                    <div class="card-peymanyar text-center py-5">
                        <i class="bi bi-folder-x display-4 text-muted mb-3"></i>
                        <h4>پروژه‌ای یافت نشد</h4>
                        <p class="text-muted">همه پروژه‌ها تایید شده‌اند.</p>
                    </div>
                </div>
            `;
        }
        
        alert('✅ پروژه با موفقیت تایید شد');
        
    } catch (error) {
        alert('خطا: ' + error.message);
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

window.deleteProject = async function(projectId) {
    if (!confirm('⚠️ آیا از حذف این پروژه اطمینان دارید؟')) return;
    
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = 'در حال حذف...';
    btn.disabled = true;
    
    try {
        const { error } = await supabase
            .from('projects')
            .delete()
            .eq('id', projectId);
        
        if (error) throw error;
        
        const projectCard = btn.closest('.col-md-6');
        if (projectCard) {
            projectCard.remove();
        }
        
        const pendingSpan = document.getElementById('statPending');
        const currentPending = parseInt(pendingSpan.textContent);
        pendingSpan.textContent = currentPending - 1;
        
        const totalSpan = document.getElementById('statTotal');
        totalSpan.textContent = parseInt(totalSpan.textContent) - 1;
        
        const badge = document.getElementById('pendingProjectsCount');
        if (badge) badge.textContent = currentPending - 1;
        
        const container = document.getElementById('projectsAdminList');
        if (container.children.length === 0) {
            container.innerHTML = `
                <div class="col-12">
                    <div class="card-peymanyar text-center py-5">
                        <i class="bi bi-folder-x display-4 text-muted mb-3"></i>
                        <h4>پروژه‌ای یافت نشد</h4>
                        <p class="text-muted">همه پروژه‌ها حذف شده‌اند.</p>
                    </div>
                </div>
            `;
        }
        
        alert('✅ پروژه حذف شد');
        
    } catch (error) {
        alert('خطا: ' + error.message);
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        const newBtn = document.querySelector('button[onclick*="openProjectModal"]');
        if (newBtn) {
            newBtn.onclick = function(e) {
                e.preventDefault();
                window.openNewProjectModal();
            };
            console.log('✅ دکمه پروژه جدید تنظیم شد');
        }
        
        const saveBtn = document.querySelector('#newProjectModal .btn-primary');
        if (saveBtn) {
            saveBtn.onclick = function(e) {
                e.preventDefault();
                window.saveProjectToDatabase();
            };
            console.log('✅ دکمه ایجاد پروژه تنظیم شد');
        }
    }, 500);
});

window.app = app;
</script>