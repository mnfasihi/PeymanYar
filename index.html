<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù¾ÛŒÙ…Ø§Ù†â€ŒÛŒØ§Ø± | Ù¾Ù„ØªÙØ±Ù… Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù¾ÛŒÙ…Ø§Ù†Ú©Ø§Ø±Ø§Ù† Ø³Ø§Ø®ØªÙ…Ø§Ù†ÛŒ</title>
    
    <!-- CSS files -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    
    <style>
        /* Ù‡Ù…Ø§Ù† Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ - Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± */
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --accent-color: #f72585;
            --employer-color: #4cc9f0;
            --contractor-color: #7209b7;
            --dark-color: #1a1a2e;
            --light-color: #f8f9fa;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --gradient-primary: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
            --gradient-accent: linear-gradient(135deg, #f72585 0%, #b5179e 100%);
            --gradient-employer: linear-gradient(135deg, #4cc9f0 0%, #4895ef 100%);
            --gradient-contractor: linear-gradient(135deg, #7209b7 0%, #560bad 100%);
            --gradient-success: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            --shadow-sm: 0 2px 10px rgba(0,0,0,0.05);
            --shadow-md: 0 5px 20px rgba(0,0,0,0.08);
            --shadow-lg: 0 10px 30px rgba(0,0,0,0.12);
            --shadow-xl: 0 15px 35px rgba(0,0,0,0.2);
            --border-radius-sm: 8px;
            --border-radius-md: 15px;
            --border-radius-lg: 20px;
            --border-radius-xl: 30px;
            --transition-fast: 0.2s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;
        }
        
        /* Ø¨Ù‚ÛŒÙ‡ Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ù…Ø«Ù„ Ù‚Ø¨Ù„ÛŒ */
        /* ... */
    </style>
</head>
<body>

<!-- ========== SECTION 1: MODALS ========== -->

<!-- Modal: Ù‚ÙˆØ§Ù†ÛŒÙ† Ùˆ Ù…Ù‚Ø±Ø±Ø§Øª -->
<div class="modal fade" id="termsModal" tabindex="-1">
    <!-- Ù…Ø­ØªÙˆØ§ÛŒ Ù…ÙˆØ¯Ø§Ù„ Ù…Ø«Ù„ Ù‚Ø¨Ù„ -->
</div>

<!-- Modal: Ù¾Ø±ÙˆÚ˜Ù‡ Ø¬Ø¯ÛŒØ¯ -->
<div class="modal fade" id="newProjectModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ø±ÙˆÚ˜Ù‡ Ø¬Ø¯ÛŒØ¯</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="newProjectForm">
                    <div class="mb-3">
                        <label class="form-label required">Ø¹Ù†ÙˆØ§Ù† Ù¾Ø±ÙˆÚ˜Ù‡</label>
                        <input type="text" class="form-control" id="projectTitle" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label required">ØªÙˆØ¶ÛŒØ­Ø§Øª Ù¾Ø±ÙˆÚ˜Ù‡</label>
                        <textarea class="form-control" id="projectDescription" rows="4" required></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</label>
                            <select class="form-select" id="projectCategory">
                                <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                                <option value="residential">Ù…Ø³Ú©ÙˆÙ†ÛŒ</option>
                                <option value="commercial">ØªØ¬Ø§Ø±ÛŒ</option>
                                <option value="industrial">ØµÙ†Ø¹ØªÛŒ</option>
                                <option value="renovation">Ù†ÙˆØ³Ø§Ø²ÛŒ</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Ø¨ÙˆØ¯Ø¬Ù‡ ØªÙ‚Ø±ÛŒØ¨ÛŒ</label>
                            <select class="form-select" id="projectBudget">
                                <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                                <option value="under100">Ø²ÛŒØ± Û±Û°Û° Ù…ÛŒÙ„ÛŒÙˆÙ†</option>
                                <option value="100-500">Û±Û°Û° ØªØ§ ÛµÛ°Û° Ù…ÛŒÙ„ÛŒÙˆÙ†</option>
                                <option value="500-1000">ÛµÛ°Û° Ù…ÛŒÙ„ÛŒÙˆÙ† ØªØ§ Û± Ù…ÛŒÙ„ÛŒØ§Ø±Ø¯</option>
                                <option value="1-5">Û± ØªØ§ Ûµ Ù…ÛŒÙ„ÛŒØ§Ø±Ø¯</option>
                                <option value="5+">Ø¨Ø§Ù„Ø§ÛŒ Ûµ Ù…ÛŒÙ„ÛŒØ§Ø±Ø¯</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ú©Ø§Ù†ÛŒ</label>
                            <input type="text" class="form-control" id="projectLocation" placeholder="ØªÙ‡Ø±Ø§Ù†ØŒ Ø³Ø¹Ø§Ø¯Øªâ€ŒØ¢Ø¨Ø§Ø¯">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Ø²Ù…Ø§Ù†Ø¨Ù†Ø¯ÛŒ</label>
                            <select class="form-select" id="projectTimeline">
                                <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                                <option value="urgent">ÙÙˆØ±ÛŒ (Ú©Ù…ØªØ± Ø§Ø² Û± Ù…Ø§Ù‡)</option>
                                <option value="1-3">Û± ØªØ§ Û³ Ù…Ø§Ù‡</option>
                                <option value="3-6">Û³ ØªØ§ Û¶ Ù…Ø§Ù‡</option>
                                <option value="6-12">Û¶ ØªØ§ Û±Û² Ù…Ø§Ù‡</option>
                                <option value="flexible">Ø§Ù†Ø¹Ø·Ø§Ùâ€ŒÙ¾Ø°ÛŒØ±</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø§Ù†ØµØ±Ø§Ù</button>
                <button type="button" class="btn btn-primary" id="saveProjectBtn">Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ø±ÙˆÚ˜Ù‡</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toastContainer" style="position: fixed; top: 20px; left: 20px; z-index: 9999;"></div>

<!-- ========== SECTION 2: ASSISTANT ========== -->
<div class="assistant-container">
    <!-- Ù…Ø­ØªÙˆØ§ÛŒ Ø¯Ø³ØªÛŒØ§Ø± Ù…Ø«Ù„ Ù‚Ø¨Ù„ -->
</div>

<!-- ========== SECTION 3: NAVBAR ========== -->
<nav class="navbar navbar-expand-lg navbar-light fixed-top">
    <!-- Ù…Ø­ØªÙˆØ§ÛŒ Ù†ÙˆØ¨Ø§Ø± Ù…Ø«Ù„ Ù‚Ø¨Ù„ -->
</nav>

<!-- ========== SECTION 4: MAIN PAGES ========== -->

<!-- ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ -->
<div id="home" class="page-section active">
    <!-- Ù…Ø­ØªÙˆØ§ÛŒ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ Ù…Ø«Ù„ Ù‚Ø¨Ù„ -->
</div>

<!-- ØµÙØ­Ù‡ ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ -->
<div id="features" class="page-section">
    <!-- Ù…Ø­ØªÙˆØ§ÛŒ ØµÙØ­Ù‡ ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ Ù…Ø«Ù„ Ù‚Ø¨Ù„ -->
</div>

<!-- ØµÙØ­Ù‡ Ø¬Ø³ØªØ¬Ùˆ -->
<div id="search" class="page-section">
    <!-- Ù…Ø­ØªÙˆØ§ÛŒ ØµÙØ­Ù‡ Ø¬Ø³ØªØ¬Ùˆ Ù…Ø«Ù„ Ù‚Ø¨Ù„ -->
</div>

<!-- ØµÙØ­Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ -->
<div id="projects" class="page-section">
    <div class="container page-header">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="section-title">ğŸ“‹ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§</h2>
            <button class="btn btn-primary" id="newProjectBtn">
                <i class="bi bi-plus-circle me-2"></i>Ù¾Ø±ÙˆÚ˜Ù‡ Ø¬Ø¯ÛŒØ¯
            </button>
        </div>

        <!-- ÙÛŒÙ„ØªØ±Ù‡Ø§ -->
        <div class="card-peymanyar mb-4">
            <div class="row g-3">
                <div class="col-md-4">
                    <select class="form-select" id="projectFilterStatus">
                        <option value="all">Ù‡Ù…Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§</option>
                        <option value="open">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ù¾ÛŒÙ…Ø§Ù†Ú©Ø§Ø±</option>
                        <option value="in_progress">Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</option>
                        <option value="completed">ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <input type="text" class="form-control" id="projectSearch" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§...">
                </div>
                <div class="col-md-4">
                    <button class="btn btn-peymanyar w-100" id="applyFiltersBtn">
                        <i class="bi bi-search me-2"></i>Ø§Ø¹Ù…Ø§Ù„ ÙÛŒÙ„ØªØ±
                    </button>
                </div>
            </div>
        </div>

        <!-- Ù„ÛŒØ³Øª Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ -->
        <div id="projectsList" class="row"></div>
    </div>
</div>

<!-- ØµÙØ­Ù‡ Ù¾ÛŒØ§Ù…â€ŒÛŒØ§Ø± -->
<div id="messages" class="page-section">
    <!-- Ù…Ø­ØªÙˆØ§ÛŒ ØµÙØ­Ù‡ Ù¾ÛŒØ§Ù…â€ŒÛŒØ§Ø± Ù…Ø«Ù„ Ù‚Ø¨Ù„ -->
</div>

<!-- ØµÙØ­Ù‡ Ø¨Ù„Ø§Ú¯ -->
<div id="blog" class="page-section">
    <!-- Ù…Ø­ØªÙˆØ§ÛŒ ØµÙØ­Ù‡ Ø¨Ù„Ø§Ú¯ Ù…Ø«Ù„ Ù‚Ø¨Ù„ -->
</div>

<!-- ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯ -->
<div id="login" class="page-section">
    <!-- Ù…Ø­ØªÙˆØ§ÛŒ ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯ Ù…Ø«Ù„ Ù‚Ø¨Ù„ -->
</div>

<!-- ØµÙØ­Ù‡ ÙØ±Ø§Ù…ÙˆØ´ÛŒ Ø±Ù…Ø² -->
<div id="forgotPassword" class="page-section">
    <!-- Ù…Ø­ØªÙˆØ§ÛŒ ØµÙØ­Ù‡ ÙØ±Ø§Ù…ÙˆØ´ÛŒ Ø±Ù…Ø² Ù…Ø«Ù„ Ù‚Ø¨Ù„ -->
</div>

<!-- ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯ Ø§Ø¯Ù…ÛŒÙ† -->
<div id="adminLogin" class="page-section">
    <!-- Ù…Ø­ØªÙˆØ§ÛŒ ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯ Ø§Ø¯Ù…ÛŒÙ† Ù…Ø«Ù„ Ù‚Ø¨Ù„ -->
</div>

<!-- ØµÙØ­Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª -->
<div id="adminMessages" class="page-section">
    <!-- Ù…Ø­ØªÙˆØ§ÛŒ ØµÙØ­Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø«Ù„ Ù‚Ø¨Ù„ -->
</div>

<!-- ØµÙØ­Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ -->
<div id="profile" class="page-section">
    <!-- Ù…Ø­ØªÙˆØ§ÛŒ ØµÙØ­Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…Ø«Ù„ Ù‚Ø¨Ù„ -->
</div>

<!-- ØµÙØ­Ù‡ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø§Ø±ÙØ±Ù…Ø§ -->
<div id="employerRegistration" class="page-section">
    <!-- Ù…Ø­ØªÙˆØ§ÛŒ ØµÙØ­Ù‡ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø§Ø±ÙØ±Ù…Ø§ Ù…Ø«Ù„ Ù‚Ø¨Ù„ -->
</div>

<!-- ØµÙØ­Ù‡ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù¾ÛŒÙ…Ø§Ù†Ú©Ø§Ø± -->
<div id="contractorRegistration" class="page-section">
    <!-- Ù…Ø­ØªÙˆØ§ÛŒ ØµÙØ­Ù‡ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù¾ÛŒÙ…Ø§Ù†Ú©Ø§Ø± Ù…Ø«Ù„ Ù‚Ø¨Ù„ -->
</div>

<!-- ========== SECTION 5: FOOTER ========== -->
<footer class="footer">
    <!-- Ù…Ø­ØªÙˆØ§ÛŒ ÙÙˆØªØ± Ù…Ø«Ù„ Ù‚Ø¨Ù„ -->
</footer>

<!-- ========== SECTION 6: SCRIPTS ========== -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
// ========== SECTION 6.1: SUPABASE CONFIG ==========
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const supabaseUrl = 'https://fycyznoykgxpaatjsawi.supabase.co'
const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ5Y3l6bm95a2d4cGFhdGpzYXdpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2MDM0MjYsImV4cCI6MjA4NzE3OTQyNn0.fZQfDuaUW6jxQOF0be8eaK16mD-lHfPnyYht-0ryQSQ'

const supabase = createClient(supabaseUrl, supabaseAnonKey)
window.supabase = supabase

// ========== SECTION 6.2: HELPER FUNCTIONS ==========
function getCurrentUser() {
    try {
        const userData = localStorage.getItem('peymanyar_user')
        return userData ? JSON.parse(userData) : null
    } catch (e) {
        console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ú©Ø§Ø±Ø¨Ø±:', e)
        return null
    }
}

function showToast(message, type = 'info') {
    const container = document.getElementById('toastContainer')
    if (!container) return

    const toast = document.createElement('div')
    toast.className = `toast align-items-center text-bg-${type} border-0`
    toast.setAttribute('role', 'alert')
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `
    container.appendChild(toast)
    const bsToast = new bootstrap.Toast(toast, { delay: 3000 })
    bsToast.show()
    toast.addEventListener('hidden.bs.toast', () => toast.remove())
}

// ========== SECTION 6.3: PROJECT FUNCTIONS ==========
window.openNewProjectModal = function() {
    const user = getCurrentUser()
    
    if (!user) {
        showToast('Ù„Ø·ÙØ§ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø®ÙˆØ¯ Ø´ÙˆÛŒØ¯', 'error')
        setTimeout(() => window.showLogin?.(), 1500)
        return
    }
    
    if (user.user_type !== 'employer') {
        showToast('Ø«Ø¨Øª Ù¾Ø±ÙˆÚ˜Ù‡ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±ÙØ±Ù…Ø§ÛŒØ§Ù† Ø§Ù…Ú©Ø§Ù†â€ŒÙ¾Ø°ÛŒØ± Ø§Ø³Øª', 'error')
        return
    }
    
    const modal = new bootstrap.Modal(document.getElementById('newProjectModal'))
    modal.show()
}

window.saveProjectToDatabase = async function() {
    const user = getCurrentUser()
    
    if (!user || user.user_type !== 'employer') {
        showToast('Ø´Ù…Ø§ Ø§Ø¬Ø§Ø²Ù‡ Ø«Ø¨Øª Ù¾Ø±ÙˆÚ˜Ù‡ Ù†Ø¯Ø§Ø±ÛŒØ¯', 'error')
        return
    }
    
    const title = document.getElementById('projectTitle')?.value
    const desc = document.getElementById('projectDescription')?.value
    
    if (!title || !desc) {
        showToast('Ø¹Ù†ÙˆØ§Ù† Ùˆ ØªÙˆØ¶ÛŒØ­Ø§Øª Ù¾Ø±ÙˆÚ˜Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error')
        return
    }
    
    const btn = document.getElementById('saveProjectBtn')
    const originalText = btn.innerHTML
    btn.innerHTML = 'Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øª...'
    btn.disabled = true
    
    try {
        const projectData = {
            title: title,
            description: desc,
            employer_id: user.id,
            category: document.getElementById('projectCategory')?.value || null,
            budget_range: document.getElementById('projectBudget')?.value || null,
            location: document.getElementById('projectLocation')?.value || null,
            timeline: document.getElementById('projectTimeline')?.value || null,
            status: 'pending',
            admin_approved: false,
            created_at: new Date().toISOString()
        }
        
        const { error } = await supabase
            .from('projects')
            .insert([projectData])
        
        if (error) throw error
        
        showToast(`Ù¾Ø±ÙˆÚ˜Ù‡ "${title}" Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯`, 'success')
        
        const modal = bootstrap.Modal.getInstance(document.getElementById('newProjectModal'))
        modal.hide()
        document.getElementById('newProjectForm').reset()
        
        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ Ø§Ú¯Ø± Ø¯Ø± ØµÙØ­Ù‡ Ù‡Ø³ØªÛŒÙ…
        if (document.getElementById('projects').classList.contains('active')) {
            setTimeout(() => window.loadPublicProjects?.(), 500)
        }
        
    } catch (error) {
        console.error('Ø®Ø·Ø§:', error)
        showToast('Ø®Ø·Ø§: ' + error.message, 'error')
    } finally {
        btn.innerHTML = originalText
        btn.disabled = false
    }
}

// ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ú†Ø³Ø¨ Ø¨ÙˆØ¯Ø¬Ù‡
function getBudgetLabel(budget) {
    const labels = {
        'under100': 'Ø²ÛŒØ± Û±Û°Û° Ù…ÛŒÙ„ÛŒÙˆÙ†',
        '100-500': 'Û±Û°Û° ØªØ§ ÛµÛ°Û° Ù…ÛŒÙ„ÛŒÙˆÙ†',
        '500-1000': 'ÛµÛ°Û° Ù…ÛŒÙ„ÛŒÙˆÙ† ØªØ§ Û± Ù…ÛŒÙ„ÛŒØ§Ø±Ø¯',
        '1-5': 'Û± ØªØ§ Ûµ Ù…ÛŒÙ„ÛŒØ§Ø±Ø¯',
        '5+': 'Ø¨Ø§Ù„Ø§ÛŒ Ûµ Ù…ÛŒÙ„ÛŒØ§Ø±Ø¯'
    }
    return labels[budget] || budget
}

// ØªØ§Ø¨Ø¹ Ù†Ù…Ø§ÛŒØ´ Ù¾Ø±ÙˆÚ˜Ù‡
window.viewProject = function(id) {
    showToast(`Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª Ù¾Ø±ÙˆÚ˜Ù‡ ${id} - Ø¯Ø± Ø­Ø§Ù„ ØªÙˆØ³Ø¹Ù‡`, 'info')
}

// ØªØ§Ø¨Ø¹ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ
window.loadPublicProjects = async function(status = 'all', search = '') {
    const container = document.getElementById('projectsList')
    if (!container) return
    
    try {
        container.innerHTML = '<div class="col-12 text-center py-5"><div class="spinner-border text-primary"></div><p class="mt-2">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p></div>'
        
        let query = supabase
            .from('projects')
            .select('*')
            .eq('admin_approved', true)
            .order('created_at', { ascending: false })
        
        if (status !== 'all') {
            query = query.eq('status', status)
        }
        
        if (search) {
            query = query.or(`title.ilike.%${search}%,description.ilike.%${search}%`)
        }
        
        const { data: projects, error } = await query
        
        if (error) throw error
        
        if (!projects || projects.length === 0) {
            container.innerHTML = `
                <div class="col-12">
                    <div class="card-peymanyar text-center py-5">
                        <i class="bi bi-folder2-open display-4 text-muted mb-3"></i>
                        <h4>Ù¾Ø±ÙˆÚ˜Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</h4>
                        <p class="text-muted">Ù‡Ù†ÙˆØ² Ù¾Ø±ÙˆÚ˜Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>
                    </div>
                </div>
            `
            return
        }
        
        let html = ''
        projects.forEach(project => {
            const date = new Date(project.created_at).toLocaleDateString('fa-IR')
            
            html += `
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card-peymanyar h-100">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h5 class="mb-0">${project.title}</h5>
                            <span class="badge bg-${project.status === 'open' ? 'success' : 'secondary'}">
                                ${project.status === 'open' ? 'Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯' : 'Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù‡'}
                            </span>
                        </div>
                        <p class="text-muted small mb-3">${project.description || 'Ø¨Ø¯ÙˆÙ† ØªÙˆØ¶ÛŒØ­Ø§Øª'}</p>
                        <div class="mt-auto">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted">
                                    <i class="bi bi-calendar me-1"></i>${date}
                                </small>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-outline-primary flex-grow-1" onclick="viewProject(${project.id})">
                                    <i class="bi bi-eye me-1"></i>Ù…Ø´Ø§Ù‡Ø¯Ù‡
                                </button>
                                ${project.budget_range ? `
                                    <span class="badge bg-light text-dark p-2">
                                        <i class="bi bi-cash me-1"></i>${getBudgetLabel(project.budget_range)}
                                    </span>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `
        })
        
        container.innerHTML = html
        
    } catch (error) {
        console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§:', error)
        container.innerHTML = `
            <div class="col-12">
                <div class="alert alert-danger">
                    Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.
                </div>
            </div>
        `
    }
}

// ========== SECTION 6.4: EVENT LISTENERS ==========
document.addEventListener('DOMContentLoaded', function() {
    // Ø¯Ú©Ù…Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡ Ø¬Ø¯ÛŒØ¯
    const newBtn = document.getElementById('newProjectBtn')
    if (newBtn) {
        newBtn.addEventListener('click', (e) => {
            e.preventDefault()
            window.openNewProjectModal()
        })
    }
    
    // Ø¯Ú©Ù…Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡
    const saveBtn = document.getElementById('saveProjectBtn')
    if (saveBtn) {
        saveBtn.addEventListener('click', (e) => {
            e.preventDefault()
            window.saveProjectToDatabase()
        })
    }
    
    // Ø¯Ú©Ù…Ù‡ Ø§Ø¹Ù…Ø§Ù„ ÙÛŒÙ„ØªØ±
    const filterBtn = document.getElementById('applyFiltersBtn')
    if (filterBtn) {
        filterBtn.addEventListener('click', () => {
            const status = document.getElementById('projectFilterStatus')?.value || 'all'
            const search = document.getElementById('projectSearch')?.value || ''
            window.loadPublicProjects(status, search)
        })
    }
    
    // Ø¨Ø±Ø±Ø³ÛŒ Ù‡Ø´ ØµÙØ­Ù‡
    if (window.location.hash === '#projects') {
        setTimeout(() => window.loadPublicProjects(), 300)
    }
})

// ========== SECTION 6.5: PEYMANYAR APP CLASS ==========
class PeymanyarApp {
    constructor() {
        this.currentPage = 'home'
        this.userData = null
        this.isAdmin = false
        this.init()
    }
    
    init() {
        this.loadUserData()
        this.setupEventListeners()
        this.checkAdminStatus()
    }
    
    loadUserData() {
        const saved = localStorage.getItem('peymanyar_user')
        if (saved) {
            try {
                this.userData = JSON.parse(saved)
            } catch (e) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ù„ÙˆØ¯ user data:', e)
                this.userData = null
            }
        }
    }
    
    setupEventListeners() {
        window.addEventListener('popstate', (e) => {
            if (e.state && e.state.page) {
                this.showPage(e.state.page, false)
            }
        })
    }
    
    async checkAdminStatus() {
        if (this.userData && this.userData.id) {
            try {
                const { data: profile } = await supabase
                    .from('profiles')
                    .select('role')
                    .eq('user_id', this.userData.id)
                    .single()
                
                this.isAdmin = profile?.role === 'admin'
                this.showAdminControls()
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ Ù†Ù‚Ø´ Ú©Ø§Ø±Ø¨Ø±:', error)
                this.isAdmin = false
            }
        }
    }
    
    showAdminControls() {
        document.querySelectorAll('.admin-only').forEach(link => {
            link.style.display = this.isAdmin ? 'block' : 'none'
        })
    }
    
    showPage(pageId, pushState = true) {
        document.querySelectorAll('.page-section').forEach(page => {
            page.classList.remove('active')
            page.style.display = 'none'
            page.setAttribute('aria-hidden', 'true')
        })
        
        const targetPage = document.getElementById(pageId)
        if (targetPage) {
            targetPage.classList.add('active')
            targetPage.style.display = 'block'
            targetPage.setAttribute('aria-hidden', 'false')
            window.scrollTo({ top: 0, behavior: 'smooth' })
            
            if (pushState) {
                history.pushState({ page: pageId }, '', `#${pageId}`)
            }
            
            this.currentPage = pageId
            
            // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ Ø§Ú¯Ø± ØµÙØ­Ù‡ projects Ø§Ø³Øª
            if (pageId === 'projects') {
                setTimeout(() => window.loadPublicProjects(), 100)
            }
            
            // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø§Ú¯Ø± ØµÙØ­Ù‡ profile Ø§Ø³Øª
            if (pageId === 'profile') {
                this.loadFullProfile()
            }
        }
    }
    
    async loadFullProfile() {
        // ØªØ§Ø¨Ø¹ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…Ø«Ù„ Ù‚Ø¨Ù„
        showToast('Ø¯Ø± Ø­Ø§Ù„ ØªÙˆØ³Ø¹Ù‡', 'info')
    }
    
    async logout() {
        await supabase.auth.signOut()
        this.userData = null
        localStorage.removeItem('peymanyar_user')
        this.showPage('home')
        showToast('Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø®Ø§Ø±Ø¬ Ø´Ø¯ÛŒØ¯', 'success')
    }
    
    // ØªÙˆØ§Ø¨Ø¹ Ø¯ÛŒÚ¯Ø± Ú©Ù„Ø§Ø³ (Ù…Ø«Ù„ Ù‚Ø¨Ù„)
    // ...
}

// ========== SECTION 6.6: GLOBAL INSTANCE ==========
const app = new PeymanyarApp()
window.app = app

// ØªÙˆØ§Ø¨Ø¹ Ú¯Ù„ÙˆØ¨Ø§Ù„ Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø² HTML
window.showPage = (pageId) => app?.showPage(pageId)
window.showMainPage = () => app?.showPage('home')
window.showLogin = () => app?.showPage('login')
window.showEmployerRegistration = () => app?.showPage('employerRegistration')
window.showContractorRegistration = () => app?.showPage('contractorRegistration')
window.logout = () => app?.logout()

// ========== SECTION 6.7: ADMIN PANEL ==========
(function() {
    window.adminPanelActive = false
    
    window.showProjectManagementPanel = function() {
        window.adminPanelActive = true
        
        document.querySelectorAll('.page-section').forEach(p => {
            p.style.display = 'none'
            p.classList.remove('active')
            p.setAttribute('aria-hidden', 'true')
        })
        
        let panel = document.getElementById('adminProjectsPanel')
        if (!panel) {
            panel = document.createElement('div')
            panel.id = 'adminProjectsPanel'
            panel.className = 'page-section'
            panel.style.display = 'block'
            panel.classList.add('active')
            panel.removeAttribute('aria-hidden')
            
            panel.innerHTML = `
                <div class="container page-header">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="section-title">Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§</h2>
                        <button class="btn btn-secondary" onclick="window.closeAdminPanel()">
                            <i class="bi bi-arrow-right me-2"></i>Ø¨Ø§Ø²Ú¯Ø´Øª
                        </button>
                    </div>
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card-peymanyar text-center">
                                <div class="h3 mb-2" id="pendingCount">0</div>
                                <p class="text-muted">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ§ÛŒÛŒØ¯</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card-peymanyar text-center">
                                <div class="h3 mb-2" id="approvedCount">0</div>
                                <p class="text-muted">ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card-peymanyar text-center">
                                <div class="h3 mb-2" id="totalCount">0</div>
                                <p class="text-muted">Ú©Ù„ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§</p>
                            </div>
                        </div>
                    </div>
                    <div id="adminProjectsContainer" class="row"></div>
                </div>
            `
            document.body.insertBefore(panel, document.querySelector('footer'))
        } else {
            panel.style.display = 'block'
            panel.classList.add('active')
            panel.removeAttribute('aria-hidden')
        }
        
        loadAdminProjects()
    }
    
    window.closeAdminPanel = function() {
        window.adminPanelActive = false
        document.getElementById('adminProjectsPanel').style.display = 'none'
        document.getElementById('adminMessages').style.display = 'block'
        document.getElementById('adminMessages').classList.add('active')
    }
    
    async function loadAdminProjects() {
        try {
            const { data: pending } = await supabase
                .from('projects')
                .select('*')
                .eq('admin_approved', false)
                .order('created_at', { ascending: false })
            
            const { count: total } = await supabase
                .from('projects')
                .select('*', { count: 'exact', head: true })
            
            const { count: approved } = await supabase
                .from('projects')
                .select('*', { count: 'exact', head: true })
                .eq('admin_approved', true)
            
            document.getElementById('pendingCount').textContent = pending?.length || 0
            document.getElementById('approvedCount').textContent = approved || 0
            document.getElementById('totalCount').textContent = total || 0
            
            const badge = document.getElementById('pendingProjectsCount')
            if (badge) badge.textContent = pending?.length || 0
            
            const container = document.getElementById('adminProjectsContainer')
            
            if (!pending || pending.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-info text-center">
                            <i class="bi bi-check-circle me-2"></i>
                            Ù‡ÛŒÚ† Ù¾Ø±ÙˆÚ˜Ù‡â€ŒØ§ÛŒ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ§ÛŒÛŒØ¯ Ù†ÛŒØ³Øª
                        </div>
                    </div>
                `
                return
            }
            
            let html = ''
            pending.forEach(p => {
                html += `
                    <div class="col-md-6 mb-3" id="project-${p.id}">
                        <div class="card-peymanyar">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="mb-0">${p.title}</h5>
                                <span class="badge bg-warning">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</span>
                            </div>
                            <p class="text-muted small">${p.description || 'Ø¨Ø¯ÙˆÙ† ØªÙˆØ¶ÛŒØ­Ø§Øª'}</p>
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <small class="text-muted">
                                    <i class="bi bi-calendar me-1"></i>
                                    ${new Date(p.created_at).toLocaleDateString('fa-IR')}
                                </small>
                                <div>
                                    <button class="btn btn-sm btn-success me-2" onclick="approveProject(${p.id})">
                                        <i class="bi bi-check-circle"></i> ØªØ§ÛŒÛŒØ¯
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteProject(${p.id})">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            })
            
            container.innerHTML = html
            
        } catch (error) {
            console.error('Ø®Ø·Ø§:', error)
        }
    }
    
    window.approveProject = async function(id) {
        if (!confirm('Ø¢ÛŒØ§ Ø§Ø² ØªØ§ÛŒÛŒØ¯ Ø§ÛŒÙ† Ù¾Ø±ÙˆÚ˜Ù‡ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) return
        
        try {
            await supabase
                .from('projects')
                .update({ admin_approved: true, status: 'open' })
                .eq('id', id)
            
            document.getElementById(`project-${id}`)?.remove()
            
            const pendingSpan = document.getElementById('pendingCount')
            const approvedSpan = document.getElementById('approvedCount')
            
            pendingSpan.textContent = parseInt(pendingSpan.textContent) - 1
            approvedSpan.textContent = parseInt(approvedSpan.textContent) + 1
            
            const badge = document.getElementById('pendingProjectsCount')
            if (badge) badge.textContent = pendingSpan.textContent
            
            showToast('Ù¾Ø±ÙˆÚ˜Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØ§ÛŒÛŒØ¯ Ø´Ø¯', 'success')
            
        } catch (error) {
            console.error('Ø®Ø·Ø§:', error)
            showToast('Ø®Ø·Ø§ Ø¯Ø± ØªØ§ÛŒÛŒØ¯ Ù¾Ø±ÙˆÚ˜Ù‡', 'error')
        }
    }
    
    window.deleteProject = async function(id) {
        if (!confirm('âš ï¸ Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù¾Ø±ÙˆÚ˜Ù‡ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) return
        
        try {
            await supabase.from('projects').delete().eq('id', id)
            
            document.getElementById(`project-${id}`)?.remove()
            
            const pendingSpan = document.getElementById('pendingCount')
            const totalSpan = document.getElementById('totalCount')
            
            pendingSpan.textContent = parseInt(pendingSpan.textContent) - 1
            totalSpan.textContent = parseInt(totalSpan.textContent) - 1
            
            const badge = document.getElementById('pendingProjectsCount')
            if (badge) badge.textContent = pendingSpan.textContent
            
            showToast('Ù¾Ø±ÙˆÚ˜Ù‡ Ø­Ø°Ù Ø´Ø¯', 'success')
            
        } catch (error) {
            console.error('Ø®Ø·Ø§:', error)
            showToast('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ù¾Ø±ÙˆÚ˜Ù‡', 'error')
        }
    }
})()
</script>
</body>
</html>